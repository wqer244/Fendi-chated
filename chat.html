<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>تطبيق الدردشة مع الإيموجي وخيارات تعديل وحذف الرسائل</title>
  <!--منع تكبير او تصغير في موقعي -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <!-- خطوط تاجوال وروبوت -->
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;500&display=swap" rel="stylesheet">
  
  <!-- الخطوط الجديدة -->
  <link href="https://fonts.googleapis.com/css2?family=Almarai:wght@300;400;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Changa:wght@300;500;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;600;900&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=El+Messiri:wght@400;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Reem+Kufi:wght@400;600&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Lemonada:wght@300;500;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Scheherazade+New:wght@400;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Markazi+Text:wght@400;600&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Naskh+Arabic:wght@400;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Harmattan:wght@400;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Lateef:wght@400;600&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Rakkas&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Mirza:wght@400;600&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Katibeh&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Aref+Ruqaa:wght@400;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Jomhuria&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Mada:wght@300;600&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Baloo+Bhaijaan+2:wght@400;600&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;500&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;500;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;500;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Raleway:wght@300;500;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:wght@300;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Source+Sans+Pro:wght@300;600&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@300;500;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@300;500&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@300;700&display=swap" rel="stylesheet">
  
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- سكربتات Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
  
  <!-- إضافة مكتبة Howler.js لتشغيل الأصوات -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.3/howler.min.js"></script>
  
  <!-- مكتبة Hammer.js للسحب -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js"></script>
  
  <style>
    /* الإعدادات العامة والألوان */
    :root {
      --primary-bg: #36393f;
      --secondary-bg: #2f3136;
      --tertiary-bg: #202225;
      --accent-color: #7289da;
      --font-size: 16px;
      --message-border-radius: 10px;
      --username-color: #7289da;
    }
    body.dark-mode {
      --primary-bg: #18191a;
      --secondary-bg: #242526;
      --tertiary-bg: #3a3b3c;
      --accent-color: #7289da;
    }
    body {
      margin: 0;
      padding: 0;
      background: var(--primary-bg);
      color: #dcddde;
      font-family: 'Tajawal', sans-serif;
      direction: rtl;
      overflow: hidden;
      font-size: var(--font-size);
    }
    /* تخطيط التطبيق */
    .container {
      display: flex;
      height: 100vh;
    }
    .sidebar {
      position: relative;
      width: 80px;
      background: var(--secondary-bg);
      padding-top: 10px;
      overflow: hidden;
    }
    .group-list {
      padding: 0 5px;
      overflow-y: auto;
      height: calc(100% - 120px);
    }
    .group-card {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      margin: 10px auto;
      cursor: pointer;
      transition: transform 0.3s;
      border: 2px solid transparent;
      position: relative;
    }
    .group-card.active {
      transform: scale(1.1);
    }
    .group-card.active::before {
      content: "";
      position: absolute;
      left: -5px;
      top: 50%;
      transform: translateY(-50%);
      width: 5px;
      height: 60%;
      background: green;
      border-radius: 5px;
    }
    .group-image {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      object-fit: cover;
    }
    .group-initial {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      background: var(--accent-color);
      color: #fff;
      font-size: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
    }
    .fixed-buttons {
      position: absolute;
      bottom: 0;
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      padding-bottom: 10px;
    }
    .fixed-buttons button {
      background: var(--accent-color);
      color: #fff;
      border: none;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      transition: transform 0.3s, background 0.3s;
    }
    .fixed-buttons button:hover {
      transform: scale(1.1);
    }
    /* زر المنشورات */
    .fixed-posts-btn {
      position: fixed;
      top: 1px;
      left: 50%;
      transform: translateX(-50%);
      background: #007BFF;
      color: #fff;
      padding: 3px 5px;
      border-radius: 5px;
      text-decoration: none;
      font-size: 18px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      z-index: 1200;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: background 0.3s;
    }
    .fixed-posts-btn:hover {
      background: #0056b3;
    }
    /* زر القصص */
    .fixed-stories-btn {
      position: fixed;
      top: 0px;
      right: 30px;
      background: #28a745;
      color: #fff;
      padding: 5px 5px;
      border-radius: 5px;
      text-decoration: none;
      font-size: 15px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      z-index: 1200;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: background 0.3s;
    }
    .fixed-stories-btn:hover {
      background: #218838;
    }
    /* زر الرسائل الخاصة */
    .private-messages-btn {
      position: fixed;
      top: 1px;
      right: 250px;
      background: #7289da;
      color: #fff;
      border: none;
      padding: -1px 10px;
      border-radius: 5px;
      font-size: 12px;
      cursor: pointer;
      z-index: 1300;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: background 0.3s;
    }
    .private-messages-btn:hover {
      background: #5d6dcc;
    }
    .private-messages-btn .badge {
      display: none;
      background: red;
      color: white;
      border-radius: 50%;
      padding: 2px 6px;
      font-size: 12px;
      margin-left: 5px;
    }
    /* منطقة الدردشة العامة */
    .chat-container {
      flex: 1;
      background: var(--primary-bg);
      display: flex;
      flex-direction: column;
    }
    .chat-area {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      background-size: cover;
      background-position: center;
    }
    /* تنسيق الرسالة */
    .message {
      position: relative;
      margin-bottom: 20px;
      display: flex;
      align-items: flex-start;
      gap: 10px;
      transition: transform 0.3s, background-color 0.3s;
    }
    .message.swiping {
      background-color: rgba(114, 137, 218, 0.2);
      transform: translateX(30px);
    }
    .message-profile {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background-size: cover;
      background-position: center;
      flex-shrink: 0;
      cursor: pointer;
    }
    .message-bubble {
      background: var(--secondary-bg);
      padding: 10px;
      border-radius: var(--message-border-radius);
      position: relative;
      flex: 1;
      overflow: hidden;
      white-space: pre-wrap; /* لضمان عرض فواصل الأسطر بشكل مرتب */
    }
    .message.sent .message-bubble {
      background: var(--accent-color);
      color: #fff;
    }
    .message-time {
      font-size: 12px;
      color: #aaa;
      margin-top: 5px;
    }
    /* تفاعلات الرسالة والإيموجي */
    .reaction {
      display: inline-block;
      margin-top: 5px;
      padding: 2px 6px;
      background: rgba(0,0,0,0.2);
      border-radius: 12px;
      font-size: 14px;
      cursor: pointer;
    }
    .options-icon {
      position: absolute;
      top: 5px;
      right: 190px;
      cursor: pointer;
      color: inherit;
    }
    .options-panel {
      position: absolute;
      top: 30px;
      right: 100px;
      background: rgba(0,0,0,0.8);
      border-radius: 5px;
      padding: 5px;
      display: none;
      z-index: 10;
    }
    .options-panel button {
      background: transparent;
      border: none;
      color: #fff;
      cursor: pointer;
      margin: 2px;
      font-size: 14px;
    }
    .emoji-icon {
      position: absolute;
      bottom: 5px;
      right: 190px;
      cursor: pointer;
      font-size: 18px;
      color: inherit;
    }
    
    /* زر الرد الجديد */
    .reply-icon {
      position: absolute;
      bottom: 5px;
      left: 5px; /* لأننا في وضع rtl، سيكون في اليسار */
      cursor: pointer;
      font-size: 14px;
      color: #aaa;
      transition: color 0.3s;
      display: flex;
      align-items: center;
      gap: 3px;
    }
    .reply-icon:hover {
      color: #7289da;
    }
    
    /* نافذة الإدخال (استخدام textarea للرسائل الطويلة) */
    .message-input {
      display: flex;
      padding: 10px;
      background: var(--tertiary-bg);
      border-top: 1px solid var(--secondary-bg);
    }
    .message-input textarea {
      flex: 1;
      padding: 1px;
      border: none;
      border-radius: 5px;
      background: var(--secondary-bg);
      color: #dcddde;
      resize: none;
      font-family: inherit;
    }
    .message-input button {
      padding: 10px 20px;
      margin-left: 10px;
      background: var(--accent-color);
      border: none;
      border-radius: 5px;
      color: #fff;
      cursor: pointer;
      transition: background 0.3s;
    }
    .message-input button:hover {
      background: #5d6dcc;
    }
    /* نافذة الإيموجي */
    #emoji-popup {
      position: fixed;
      display: none;
      background: #fff;
      border: 1px solid #ccc;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      border-radius: 20px;
      padding: 5px 10px;
      z-index: 2500;
    }
    #emoji-popup .emoji-option {
      font-size: 24px;
      cursor: pointer;
      margin: 0 5px;
      transition: transform 0.2s;
    }
    #emoji-popup .emoji-option:hover {
      transform: scale(1.2);
    }
    /* النوافذ المنبثقة */
    .settings-popup,
    .create-group-popup,
    .group-options-popup,
    .edit-group-popup,
    .rooms-popup,
    .background-popup,
    .change-name-popup,
    .edit-message-popup,
    .edit-private-message-popup,
    .chat-settings-popup,
    .privacy-settings-popup,
    .theme-popup,
    .notification-settings-popup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #fff;
      border: 1px solid #ccc;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      display: none;
      text-align: center;
      z-index: 2300;
      border-radius: 8px;
      width: 400px;
      padding: 20px;
    }
    .edit-private-message-popup {
      z-index: 3100;
      width: 90%;
      max-width: 400px;
    }
    .settings-popup h3,
    .create-group-popup h3,
    .edit-group-popup h3,
    .rooms-popup h3,
    .background-popup h3,
    .change-name-popup h3,
    .edit-message-popup h3,
    .edit-private-message-popup h3,
    .chat-settings-popup h3,
    .privacy-settings-popup h3,
    .theme-popup h3,
    .notification-settings-popup h3 {
      margin-top: 0;
    }
    .create-group-popup input,
    .edit-group-popup input,
    .settings-popup input,
    .settings-popup textarea,
    .change-name-popup input,
    .chat-settings-popup input,
    .chat-settings-popup select,
    .notification-settings-popup select {
      width: 100%;
      padding: 10px;
      margin-bottom: 10px;
      border: none;
      border-radius: 5px;
      background: var(--primary-bg);
      color: #dcddde;
    }
    .create-group-popup button,
    .edit-group-popup button,
    .settings-popup button,
    .change-name-popup button,
    .edit-message-popup button,
    .edit-private-message-popup button,
    .chat-settings-popup button,
    .privacy-settings-popup button,
    .theme-popup button,
    .notification-settings-popup button {
      width: 100%;
      padding: 10px;
      background: var(--accent-color);
      border: none;
      border-radius: 5px;
      color: #fff;
      cursor: pointer;
      margin-bottom: 10px;
      transition: background 0.3s;
    }
    .create-group-popup button:hover,
    .edit-group-popup button:hover,
    .settings-popup button:hover,
    .change-name-popup button:hover,
    .edit-message-popup button:hover,
    .edit-private-message-popup button:hover,
    .chat-settings-popup button:hover,
    .privacy-settings-popup button:hover,
    .theme-popup button:hover,
    .notification-settings-popup button:hover {
      background: #5d6dcc;
    }
    .group-options-popup button {
      width: 100%;
      padding: 10px;
      margin: 5px 0;
      background: var(--accent-color);
      border: none;
      border-radius: 5px;
      color: #fff;
      cursor: pointer;
      transition: background 0.3s;
    }
    .group-options-popup button:hover {
      background: #5d6dcc;
    }
    .group-options-popup .cancel-btn {
      background: #dc3545;
    }
    .group-options-popup .cancel-btn:hover {
      background: #c33a2f;
    }
    .settings-popup button {
      width: 100%;
      padding: 12px;
      margin: 8px 0;
      border: none;
      border-radius: 5px;
      font-size: 16px;
      cursor: pointer;
      transition: background 0.3s;
    }
    /* تحسين زر الإغلاق */
    .modal-close {
      background: #dc3545;
      border: none;
      color: #fff;
      padding: 8px 12px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      margin-top: 20px;
    }
    #toggle-theme {
      background: #6c757d;
      color: #fff;
    }
    #toggle-theme:hover {
      background: #5a6268;
    }
    #change-bg-btn {
      background: var(--accent-color);
      color: #fff;
    }
    #change-bg-btn:hover {
      background: #5d6dcc;
    }
    #change-name-btn {
      background: #17a2b8;
      color: #fff;
    }
    #change-name-btn:hover {
      background: #138496;
    }
    #logout-btn {
      background: #dc3545;
      color: #fff;
    }
    #logout-btn:hover {
      background: #c82333;
    }
    #close-settings-btn {
      background: #6c757d;
      color: #fff;
    }
    #close-settings-btn:hover {
      background: #5a6268;
    }
    .rooms-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      max-height: 300px;
      overflow-y: auto;
      margin: 20px 0;
    }
    .room-card {
      width: 80px;
      height: 80px;
      background: var(--secondary-bg);
      border: 1px solid #4a4e57;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      border-radius: 8px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: transform 0.3s, box-shadow 0.3s;
      padding: 5px;
    }
    .room-card:hover {
      transform: scale(1.1);
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    }
    .room-card img {
      width: 100%;
      height: 50px;
      object-fit: cover;
      border-radius: 4px;
      margin-bottom: 5px;
    }
    .room-card span {
      font-size: 12px;
      text-align: center;
      color: #fff;
    }
    @media (max-width: 768px) {
      .sidebar {
        width: 60px;
      }
      .fixed-buttons button {
        width: 40px;
        height: 40px;
        font-size: 18px;
      }
      .group-card {
        width: 50px;
        height: 50px;
      }
      .group-initial {
        font-size: 20px;
      }
      .settings-popup,
      .create-group-popup,
      .group-options-popup,
      .edit-group-popup,
      .rooms-popup,
      .chat-settings-popup,
      .privacy-settings-popup,
      .theme-popup,
      .notification-settings-popup {
        width: 90%;
      }
      .settings-popup button {
        font-size: 14px;
        padding: 10px;
      }
    }
    #background-popup {
      max-height: 80vh;
      overflow-y: auto;
    }
    #background-options-container {
      max-height: 300px;
      overflow-y: auto;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
      margin-bottom: 10px;
    }
    .bg-option {
      width: 100px;
      height: 80px;
      background-size: cover;
      background-position: center;
      border-radius: 8px;
      cursor: pointer;
      border: 2px solid transparent;
      transition: border-color 0.3s, transform 0.3s;
    }
    .bg-option:hover {
      transform: scale(1.05);
    }
    .bg-option.selected {
      border: 2px solid #7289da;
      box-shadow: 0 0 10px rgba(114, 137, 218, 0.5);
    }
    
    /* تحسين خيار افتراضي في الخلفيات */
    .default-bg-option {
      display: flex;
      align-items: center;
      justify-content: center;
      background: #36393f;
      color: #fff;
      font-weight: bold;
      font-size: 14px;
      text-align: center;
      border-radius: 8px;
      border: 1px solid #4a4e57;
    }
    
    /* تصميم صفحة الملف الشخصي الاحترافية */
    #profile-modal {
      display: none;
      position: fixed;
      z-index: 3500;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      overflow-y: auto;
    }
    #profile-modal .modal-content {
      background: #fff;
      margin: 5% auto;
      padding: 30px;
      border-radius: 10px;
      width: 90%;
      max-width: 500px;
      box-shadow: 0 0 20px rgba(0,0,0,0.3);
      text-align: center;
    }
    #profile-modal .modal-content h2 {
      margin-top: 0;
      font-size: 24px;
      color: #333;
    }
    /* نافذة الرسائل الخاصة (قائمة الدردشات الخاصة) */
    .private-messages-popup {
      display: none;
      position: fixed;
      top: 50px;
      right: 10px;
      width: 300px;
      max-height: 80vh;
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 8px;
      z-index: 1400;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
    .private-messages-popup .popup-header {
      background: #7289da;
      color: #fff;
      padding: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .private-messages-list {
      padding: 10px;
      overflow-y: auto;
      max-height: calc(80vh - 50px);
    }
    .private-message-item {
      padding: 8px;
      border-bottom: 1px solid #ddd;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 10px;
      transition: background 0.2s;
    }
    .private-message-item:hover {
      background: #f5f5f5;
    }
    .close-btn {
      background: none;
      border: none;
      color: #fff;
      font-size: 20px;
      cursor: pointer;
    }
    /* نافذة الدردشة الخاصة */
    .private-chat-popup {
      display: none;
      position: fixed;
      z-index: 3000;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
    }
    .private-chat-popup .chat-container {
      background: #fff;
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
    }
    .private-chat-popup .chat-header {
      background: #7289da;
      color: #fff;
      padding: 15px;
      text-align: left;
      font-size: 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .private-chat-popup .chat-header .back-icon {
      margin-right: 10px;
      cursor: pointer;
      font-size: 24px;
    }
    .private-chat-popup .chat-header .chat-user-status {
      font-size: 14px;
      color: #fff;
    }
    .private-chat-popup .chat-area {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      background: #f9f9f9;
    }
    .private-chat-popup .message-input {
      display: flex;
      padding: 10px;
      background: #ddd;
    }
    .private-chat-popup .message-input textarea {
      flex: 1;
      padding: 10px;
      border: none;
      border-radius: 5px;
      margin-right: 10px;
      resize: none;
      font-family: inherit;
    }
    .private-chat-popup .message-input button {
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      background: #7289da;
      color: #fff;
      cursor: pointer;
    }
    /* تنسيق معاينة الرابط */
    .link-preview {
      border: 1px solid #ccc;
      border-radius: 5px;
      margin-top: 5px;
      display: flex;
      text-decoration: none;
      color: inherit;
      overflow: hidden;
    }
    .link-preview img {
      width: 100px;
      height: 100px;
      object-fit: cover;
    }
    .link-preview .preview-details {
      padding: 5px;
      flex: 1;
    }
    .link-preview .preview-details h4 {
      margin: 0 0 5px;
      font-size: 16px;
    }
    .link-preview .preview-details p {
      margin: 0;
      font-size: 14px;
      color: #555;
    }
    body {
      user-select: none;
      -webkit-user-select: none;
      /* للمتصفحات القديمة */
      -moz-user-select: none;
      -ms-user-select: none;
    }
    /* تنسيقات القراءات */
    .seen-status {
      position: absolute;
      bottom: 5px;
      left: 10px;
      font-size: 12px;
    }
    
    .seen-icon {
      color: #888;
      cursor: pointer;
      transition: color 0.3s;
    }
    
    .seen-icon.seen {
      color: #800080; /* اللون البنفسجي عند المشاهدة */
    }
    
    .seen-users-popup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
      z-index: 9999;
    }
    
    .seen-user {
      display: flex;
      align-items: center;
      margin: 10px 0;
    }
    
    .seen-user img {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      margin-left: 10px;
    }
    
    /* زر إرفاق الصورة */
    .attach-image-btn {
      background: #4caf50;
      color: white;
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      margin-left: 10px;
      transition: transform 0.3s;
    }
    
    .attach-image-btn:hover {
      transform: scale(1.1);
    }
    
    /* أيقونة التحميل */
    .upload-indicator {
      display: none;
      margin-left: 10px;
      font-size: 20px;
      color: #7289da;
    }
    
    /* الصور في الدردشة */
    .thumbnail-image {
      max-width: 200px;
      max-height: 200px;
      border-radius: 8px;
      cursor: pointer;
      transition: transform 0.2s;
      object-fit: cover;
      display: block;
      margin-top: 5px;
    }
    
    .thumbnail-image:hover {
      transform: scale(1.03);
    }
    
    .image-caption {
      margin-top: 8px;
      font-size: 15px;
      color: #e0e0e0;
      padding: 5px 0;
      max-width: 200px;
      word-break: break-word;
    }
    
    /* تحسينات نافذة عرض الصورة */
    .image-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.95);
      z-index: 4000;
      text-align: center;
      overflow: auto;
      padding: 20px;
      box-sizing: border-box;
    }

    .image-modal-container {
      position: relative;
      max-width: 90%;
      max-height: 80vh;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .image-modal-content {
      max-width: 100%;
      max-height: 70vh;
      display: block;
      border: 1px solid #444;
      box-shadow: 0 0 30px rgba(0, 0, 0, 0.8);
      object-fit: contain;
      cursor: grab;
      transition: transform 0.3s ease;
    }

    .full-image-caption {
      color: white;
      text-align: center;
      padding: 15px;
      font-size: 18px;
      max-width: 80%;
      margin: 0 auto;
    }

    .image-modal-controls {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 10px;
      background: rgba(0, 0, 0, 0.7);
      padding: 10px;
      border-radius: 50px;
    }

    .zoom-btn, .download-btn {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      transition: background 0.3s;
    }

    .zoom-btn:hover, .download-btn:hover {
      background: rgba(255, 255, 255, 0.4);
    }

    @media (max-width: 768px) {
      .image-modal-content {
        max-height: 60vh;
      }
      
      .image-modal-controls {
        bottom: 10px;
        padding: 8px;
      }
    
      .zoom-btn, .download-btn {
        width: 35px;
        height: 35px;
        font-size: 16px;
      }
    }
    
    /* نافذة إضافة نص للصورة */
    .image-caption-popup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 20px;
      border-radius: 10px;
      z-index: 4500;
      width: 90%;
      max-width: 400px;
      display: none;
    }
    
    .image-caption-popup textarea {
      width: 100%;
      height: 100px;
      margin-bottom: 15px;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      resize: vertical;
    }
    
    /* مؤشر التحميل */
    .upload-indicator-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 5000;
      display: none;
      justify-content: center;
      align-items: center;
    }
    
    .upload-spinner {
      width: 80px;
      height: 80px;
      border: 8px solid #f3f3f3;
      border-top: 8px solid #7289da;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* زر الحالة في الملف الشخصي */
    .user-status-indicator {
      font-size: 14px;
      padding: 3px 8px;
      border-radius: 10px;
      display: inline-block;
      margin-top: 5px;
    }
    
    .status-online {
      background-color: #4CAF50;
      color: white;
    }
    
    .status-offline {
      background-color: #f44336;
      color: white;
    }
    
    .status-idle {
      background-color: #FF9800;
      color: white;
    }
    
    /* معاينة صورة المجموعة */
    .group-image-preview {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      object-fit: cover;
      margin: 10px auto;
      display: block;
      border: 2px solid #7289da;
    }
    
    /* تنسيقات إعدادات المحادثة الجديدة */
    .setting-item {
      margin-bottom: 20px;
      text-align: right;
    }
    .setting-label {
      display: block;
      margin-bottom: 8px;
      font-weight: bold;
      color: #333;
    }
    .slider-container {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .slider-value {
      width: 40px;
      text-align: center;
    }
    .color-preview {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      display: inline-block;
      vertical-align: middle;
      margin-right: 10px;
      border: 1px solid #ccc;
    }
    
    /* إعدادات الخصوصية والأمان الجديدة */
    .privacy-setting {
      margin-bottom: 25px;
      text-align: right;
      border-bottom: 1px solid #eee;
      padding-bottom: 15px;
    }
    
    .privacy-setting h4 {
      margin-top: 0;
      margin-bottom: 15px;
      color: #333;
      font-size: 18px;
      display: flex;
      align-items: center;
    }
    
    .privacy-setting h4 i {
      margin-left: 10px;
      font-size: 20px;
    }
    
    .privacy-options {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    .privacy-option {
      display: flex;
      align-items: center;
      padding: 10px;
      background: #f8f9fa;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.3s;
    }
    
    .privacy-option:hover {
      background: #e9ecef;
    }
    
    .privacy-option.selected {
      background: #e7f3ff;
      border: 1px solid #007bff;
    }
    
    .privacy-option .option-icon {
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-left: 10px;
      font-size: 18px;
    }
    
    .privacy-option .option-text {
      flex: 1;
    }
    
    .privacy-option .option-check {
      color: #007bff;
      font-size: 18px;
      display: none;
    }
    
    .privacy-option.selected .option-check {
      display: block;
    }
    
    /* تحسينات للجوال - صفحة الخصوصية والأمان */
    @media (max-width: 480px) {
      .privacy-settings-popup {
        width: 95%;
        height: 80vh;
        max-height: 80vh;
        overflow-y: auto;
        padding: 15px;
      }
      .privacy-setting {
        padding-bottom: 10px;
      }
      .privacy-options {
        gap: 8px;
      }
      .privacy-option {
        padding: 8px;
      }
      .privacy-settings-popup button {
        padding: 8px;
        font-size: 14px;
      }
    }
    
    /* تحسينات لعرض الخطوط في إعدادات المحادثة */
    .font-preview {
      font-size: 16px;
      padding: 5px;
      border: 1px solid #ddd;
      border-radius: 4px;
      margin: 5px 0;
    }
    
    .font-option {
      padding: 8px;
      margin: 4px 0;
      border-radius: 5px;
      border: 1px solid #eee;
      cursor: pointer;
    }
    
    .font-option:hover {
      background-color: #f5f5f5;
    }
    
    /* تحسينات للنافذة المنبثقة للمظهر */
    .theme-option {
      display: flex;
      align-items: center;
      padding: 15px;
      margin: 10px 0;
      border-radius: 8px;
      cursor: pointer;
      background: #f8f9fa;
      transition: background 0.3s;
    }
    
    .theme-option:hover {
      background: #e9ecef;
    }
    
    .theme-option.selected {
      background: #e7f3ff;
      border: 1px solid #007bff;
    }
    
    .theme-icon {
      margin-left: 10px;
      font-size: 24px;
    }
    
    .theme-text {
      flex: 1;
      text-align: right;
      font-weight: bold;
    }
    
    .theme-check {
      color: #007bff;
      font-size: 18px;
    }
    
    /* التعديلات الجديدة المطلوبة */
    
    /* أيقونة المشاهدة للرسائل الخاصة */
    .seen-indicator {
      position: absolute;
      bottom: 5px;
      left: 5px;
      font-size: 12px;
      width: 15px;
      height: 15px;
      border-radius: 50%;
      background-color: #000; /* اللون الأسود الافتراضي */
    }
    
    .seen-indicator.seen {
      background-color: #800080; /* اللون البنفسجي عند المشاهدة */
    }
    
    /* أيقونة التعديل للرومات */
    .room-edit-icon {
      position: absolute;
      top: 5px;
      right: 5px;
      background: rgba(0, 0, 0, 0.5);
      color: white;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      cursor: pointer;
      z-index: 10;
      transition: all 0.3s;
    }
    
    .room-edit-icon:hover {
      background: var(--accent-color);
      transform: scale(1.2);
    }
    
    /* نافذة الدعوة للمراسلة */
    .invite-popup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 5px 25px rgba(0,0,0,0.3);
      z-index: 5000;
      width: 90%;
      max-width: 400px;
      text-align: center;
      display: none;
    }
    
    .invite-popup h3 {
      margin-top: 0;
      color: #333;
      font-size: 22px;
    }
    
    .invite-popup p {
      color: #555;
      font-size: 16px;
      line-height: 1.6;
      margin-bottom: 20px;
    }
    
    .invite-buttons {
      display: flex;
      justify-content: center;
      gap: 15px;
    }
    
    .invite-btn {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.3s;
    }
    
    .invite-send {
      background: #4CAF50;
      color: white;
    }
    
    .invite-cancel {
      background: #dc3545;
      color: white;
    }
    
    .invite-btn:hover {
      opacity: 0.9;
      transform: translateY(-2px);
    }
    
    .invite-notification {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #28a745;
      color: white;
      padding: 15px 25px;
      border-radius: 8px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      z-index: 6000;
      display: flex;
      align-items: center;
      gap: 10px;
      animation: slideIn 0.5s, fadeOut 0.5s 2.5s forwards;
    }
    
    @keyframes slideIn {
      from { top: -50px; opacity: 0; }
      to { top: 20px; opacity: 1; }
    }
    
    @keyframes fadeOut {
      from { opacity: 1; }
      to { opacity: 0; }
    }
    
    /* قسم الدعوات في الرسائل الخاصة */
    .invites-tab {
      display: flex;
      border-bottom: 1px solid #ccc;
    }
    
    .invites-tab-btn {
      flex: 1;
      padding: 10px;
      text-align: center;
      cursor: pointer;
      background: #f0f0f0;
    }
    
    .invites-tab-btn.active {
      background: #7289da;
      color: white;
    }
    
    .invite-item {
      padding: 10px;
      border-bottom: 1px solid #eee;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .invite-actions {
      display: flex;
      gap: 5px;
    }
    
    .invite-action-btn {
      padding: 5px 10px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    
    .invite-accept {
      background: #4CAF50;
      color: white;
    }
    
    .invite-reject {
      background: #dc3545;
      color: white;
    }

    /* إعدادات الإشعارات الجديدة */
    .notification-setting {
      margin-bottom: 15px;
      text-align: right;
    }
    
    .notification-setting label {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      background: #f8f9fa;
      border-radius: 8px;
      cursor: pointer;
    }
    
    .notification-toggle {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 24px;
    }
    
    .notification-toggle input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    
    .notification-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 24px;
    }
    
    .notification-slider:before {
      position: absolute;
      content: "";
      height: 16px;
      width: 16px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }
    
    input:checked + .notification-slider {
      background-color: #2196F3;
    }
    
    input:checked + .notification-slider:before {
      transform: translateX(26px);
    }
    
    .sound-option {
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      margin: 5px 0;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .sound-option:hover {
      background-color: #f0f0f0;
    }
    
    .sound-option.selected {
      background-color: #e1f0ff;
      border-color: #2196F3;
    }
    
    .sound-option i {
      margin-left: 10px;
    }
    
    .sound-option .sound-name {
      flex: 1;
    }
    
    .sound-option .sound-check {
      color: #2196F3;
      display: none;
    }
    
    .sound-option.selected .sound-check {
      display: inline-block;
    }
    
    /* نافذة طلب إذن الإشعارات */
    .permission-popup {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #2f3136;
      color: white;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
      z-index: 9999;
      max-width: 350px;
      display: none;
    }
    
    .permission-popup button {
      background: #7289da;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 5px;
      cursor: pointer;
      margin-top: 10px;
      transition: background 0.3s;
    }
    
    .permission-popup button:hover {
      background: #5d6dcc;
    }
    
    /* تحسينات لواجهة الإشعارات على الجوال */
    @media (max-width: 480px) {
      .notification-settings-popup {
        width: 95%;
        max-width: 95%;
        left: 2.5%;
        transform: translate(0, -50%);
      }
    }
    
    /* التعديلات الجديدة المطلوبة */
    
    /* مثال حجم الخط في إعدادات المحادثة */
    .font-size-example {
      margin-top: 15px;
      padding: 10px;
      background: #f8f9fa;
      border-radius: 8px;
      text-align: center;
    }
    
    .font-size-example h4 {
      margin: 0 0 10px;
      color: #333;
    }
    
    .font-size-example p {
      margin: 0;
      padding: 8px;
      background: white;
      border-radius: 5px;
      border: 1px solid #ddd;
    }
    
    /* مثال زاوية الرسالة في إعدادات المحادثة */
    .message-radius-example {
      margin-top: 15px;
      padding: 10px;
      background: #f8f9fa;
      border-radius: 8px;
      text-align: center;
    }
    
    .message-radius-example h4 {
      margin: 0 0 10px;
      color: #333;
    }
    
    .message-radius-example .example-bubble {
      display: inline-block;
      padding: 10px;
      background: #e7f3ff;
      border-radius: 15px;
      max-width: 80%;
      margin: 0 auto;
    }
    
    /* التعديلات المطلوبة لحل المشكلة */
    /* إعدادات المحادثة الجديدة - تصحيح مشكلة الجوال */
    .chat-settings-popup {
      max-height: 90vh; /* ارتفاع أقصى بنسبة 90% من ارتفاع الشاشة */
      overflow-y: auto; /* تمكين التمرير العمودي عند الحاجة */
      width: 90%; /* عرض نسبي */
      max-width: 500px; /* عرض أقصى مناسب للشاشات الكبيرة */
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }
    
    /* إعدادات الإشعارات الجديدة - تصحيح مشكلة الجوال */
    .notification-settings-popup {
      max-height: 90vh;
      overflow-y: auto;
      width: 90%;
      max-width: 500px;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }
    
    /* تعديلات للجوال */
    @media (max-width: 768px) {
      .chat-settings-popup,
      .notification-settings-popup {
        width: 95%;
        height: 90vh; /* ارتفاع النافذة 90% من ارتفاع الشاشة */
        max-height: 90vh;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
      }
      
      .chat-settings-popup .setting-item,
      .notification-settings-popup .notification-setting {
        margin-bottom: 15px;
      }
      
      .chat-settings-popup button,
      .notification-settings-popup button {
        padding: 12px;
        font-size: 14px;
      }
    }
    
    /* تحسينات عامة للعرض على الجوال */
    @media (max-width: 480px) {
      .chat-settings-popup,
      .notification-settings-popup {
        padding: 15px;
      }
      
      .slider-container {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .slider-value {
        margin-top: 5px;
      }
    }
    
    /* تحسينات لقائمة الرسائل الخاصة */
    .pm-user-avatar {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      object-fit: cover;
    }
    
    .pm-user-info {
      flex: 1;
      overflow: hidden;
    }
    
    .pm-user-name {
      font-weight: bold;
      margin-bottom: 3px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .pm-last-message {
      font-size: 14px;
      color: #666;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    /* تحسينات لرأس الدردشة الخاصة */
    .chat-header-user {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .chat-header-avatar {
      width: 35px;
      height: 35px;
      border-radius: 50%;
      object-fit: cover;
    }
    
    /* تنسيق الروابط */
    .message-link {
      color: #1e90ff;
      text-decoration: none;
    }
    
    .message-link:hover {
      text-decoration: underline;
    }
    
    /* التعديلات الجديدة */
    .seen-now-text {
      font-size: 12px;
      color: #7289da; /* اللون الأزرق */
      margin-top: 5px;
      text-align: left;
      font-weight: bold;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    .seen-now-text::before {
      content: "✓✓";
      color: #7289da;
      font-size: 14px;
    }
    
    /* منطقة الرد على الرسالة */
    .reply-preview {
      background: rgba(0, 0, 0, 0.1);
      border-right: 3px solid #7289da;
      border-radius: 4px;
      padding: 5px 10px;
      margin-bottom: 5px;
      font-size: 14px;
      color: #aaa;
      display: flex;
      justify-content: space-between;
    }
    
    .reply-preview .close-reply {
      cursor: pointer;
      color: #dc3545;
    }
    
    /* مؤشر الكتابة في الرسائل الخاصة */
    .typing-indicator {
      display: flex;
      align-items: center;
      padding: 8px 15px;
      background: #f0f0f0;
      border-radius: 18px;
      width: fit-content;
      margin: 5px 0;
      font-size: 14px;
      color: #666;
    }
    
    .typing-indicator span {
      display: inline-block;
      width: 8px;
      height: 8px;
      background-color: #7289da;
      border-radius: 50%;
      margin: 0 2px;
      animation: typing 1.4s infinite ease-in-out;
    }
    
    .typing-indicator span:nth-child(2) {
      animation-delay: 0.2s;
    }
    
    .typing-indicator span:nth-child(3) {
      animation-delay: 0.4s;
    }
    
    @keyframes typing {
      0%, 60%, 100% { transform: translateY(0); }
      30% { transform: translateY(-5px); }
    }
  </style>
</head>
<body>
  <!-- زر المنشورات -->
  <a href="posts.html" class="fixed-posts-btn">
    <i class="fa-solid fa-pen-to-square"></i>
    <span>منشورات</span>
  </a>
  <!-- زر القصص -->
  <a href="store.html" class="fixed-stories-btn">
    <i class="fa-solid fa-book-open"></i>
    <span>القصص </span>
  </a>
  <!-- زر الرسائل الخاصة -->
  <button class="private-messages-btn" onclick="togglePrivateMessagesPopup()">
    <i class="fa-solid fa-comments"></i>
    <span>الرسائل الخاصة</span>
    <span id="private-badge" class="badge"></span>
  </button>
  
  <!-- نافذة طلب إذن الإشعارات -->
  <div class="permission-popup" id="permission-popup">
    <p>هل تسمح لتطبيقنا بإرسال الإشعارات إليك؟</p>
    <p>سيساعد هذا في إعلامك بالرسائل الجديدة مباشرةً.</p>
    <button onclick="requestNotificationPermission()">نعم، أسمح</button>
    <button onclick="closePermissionPopup()" style="background: #dc3545; margin-left: 10px;">لاحقًا</button>
  </div>
  
  <div class="container">
    <!-- الشريط الجانبي -->
    <div class="sidebar" id="sidebar">
      <div class="group-list" id="group-list"></div>
      <div class="fixed-buttons">
        <!-- زر الملف الشخصي الجديد -->
        <button class="profile-btn-sidebar" onclick="openProfilePopup()">
          <i class="fa-solid fa-user-circle"></i>
        </button>
        <button class="settings-btn-sidebar" onclick="showSettingsPopup()">
          <i class="fa-solid fa-cog"></i>
        </button>
        <button class="rooms-btn-sidebar" onclick="toggleRoomsPopup()">
          <i class="fa-solid fa-users"></i>
        </button>
        <button class="create-group-btn" onclick="openCreateGroupPopup()">+</button>
      </div>
    </div>
    <!-- منطقة الدردشة العامة -->
    <div class="chat-container">
      <div class="chat-area" id="messages"></div>
      <!-- منطقة الرد على الرسالة -->
      <div id="reply-preview-container" style="display: none; padding: 0 10px;">
        <div class="reply-preview">
          <span id="reply-preview-text"></span>
          <span class="close-reply" onclick="cancelReply()">✕</span>
        </div>
      </div>
      <div class="message-input">
        <button class="attach-image-btn" id="attach-image-btn">
          <i class="fa-solid fa-camera"></i>
        </button>
        <input type="file" id="image-upload" accept="image/*" style="display: none;">
        <div id="upload-indicator" class="upload-indicator">
          <i class="fa-solid fa-spinner fa-spin"></i>
        </div>
        <textarea id="message-input" placeholder="اكتب رسالة..." rows="3"></textarea>
        <button onclick="sendMessage()">إرسال</button>
      </div>
    </div>
  </div>
  <!-- نافذة الرومات -->
  <div class="rooms-popup" id="rooms-popup">
    <h3>الرومات المتاحة</h3>
    <div class="rooms-grid" id="rooms-grid"></div>
    <button onclick="toggleRoomsPopup()">إغلاق</button>
  </div>
  <!-- نافذة إنشاء مجموعة -->
  <div class="create-group-popup" id="create-group-popup">
    <h3>إنشاء مجموعة جديدة</h3>
    <input type="text" id="group-name" placeholder="اسم المجموعة">
    <div style="margin: 15px 0;">
      <img id="group-image-preview" class="group-image-preview" src="" style="display: none;">
      <button id="upload-group-image-btn" style="background: #4CAF50; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;">اختر صورة للمجموعة</button>
      <input type="file" id="group-image-file" accept="image/*" style="display: none;">
    </div>
    <p style="text-align: center; margin: 10px 0;">أو</p>
    <input type="text" id="group-image" placeholder="رابط صورة المجموعة (اختياري)">
    <button onclick="createGroup()">إنشاء</button>
    <button onclick="closeCreateGroupPopup()">إغلاق</button>
  </div>
  <!-- نافذة خيارات المجموعة -->
  <div class="group-options-popup" id="group-options-popup">
    <button id="edit-group-btn">تعديل المجموعة</button>
    <button id="delete-group-btn">حذف المجموعة</button>
    <button class="cancel-btn" onclick="closeGroupOptionsPopup()">إلغاء</button>
  </div>
  <!-- نافذة تعديل المجموعة -->
  <div class="edit-group-popup" id="edit-group-popup">
    <h3>تعديل المجموعة</h3>
    <input type="text" id="edit-group-name" placeholder="اسم المجموعة">
    <div style="margin: 15px 0;">
      <img id="edit-group-image-preview" class="group-image-preview" src="" style="display: none;">
      <button id="edit-upload-group-image-btn" style="background: #4CAF50; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;">تغيير صورة المجموعة</button>
      <input type="file" id="edit-group-image-file" accept="image/*" style="display: none;">
    </div>
    <p style="text-align: center; margin: 10px 0;">أو</p>
    <input type="text" id="edit-group-image" placeholder="رابط صورة المجموعة (اختياري)">
    <button onclick="saveGroupEdits()">حفظ التعديلات</button>
    <button onclick="closeEditGroupPopup()">إلغاء</button>
  </div>
  <!-- نافذة الإعدادات -->
  <div class="settings-popup" id="settings-popup">
    <h3>الإعدادات</h3>
    <button id="chat-settings-btn">إعدادات المحادثة</button>
    <button id="privacy-settings-btn">خصوصية والأمان</button>
    <button id="toggle-theme">المظهر</button>
    <button id="change-bg-btn">تغيير الخلفية</button>
    <button id="change-name-btn">تغيير الاسم</button>
    <!-- زر إعدادات الإشعارات الجديد -->
    <button id="notification-settings-btn">الاشعارات</button>
    <button id="logout-btn">تسجيل الخروج</button>
    <button id="faq-btn" onclick="window.location.href='what.html'">أسئلة شائعة</button>
    <button id="close-settings-btn" onclick="closeSettingsPopup()">إغلاق</button>
  </div>
  
  <!-- نافذة إعدادات الإشعارات الجديدة -->
  <div class="notification-settings-popup" id="notification-settings-popup">
    <h3>إعدادات الإشعارات</h3>
    
    <!-- إشعارات الرسائل الخاصة -->
    <div class="notification-setting">
      <label>
        <span>الاشعارات من رسائل خاصة</span>
        <div class="notification-toggle">
          <input type="checkbox" id="private-messages-notification-toggle" checked>
          <span class="notification-slider"></span>
        </div>
      </label>
    </div>
    
    <!-- نغمة الاشعارات -->
    <div class="notification-setting">
      <h4>نغمة الاشعارات</h4>
      <div id="sound-options-container">
        <!-- سيتم ملء هذا القسم بالأصوات باستخدام JavaScript -->
      </div>
    </div>
    
    <button onclick="saveNotificationSettings()">حفظ الإعدادات</button>
    <button onclick="closeNotificationSettingsPopup()">إغلاق</button>
  </div>
  
  <!-- نافذة خصوصية والأمان -->
  <div class="privacy-settings-popup" id="privacy-settings-popup">
    <h3>خصوصية والأمان</h3>
    
    <!-- آخر ظهور ومتصل -->
    <div class="privacy-setting">
      <h4><i class="fa-solid fa-eye"></i> آخر ظهور ومتصل</h4>
      <div class="privacy-options">
        <div class="privacy-option" data-value="everyone" onclick="selectPrivacyOption(this, 'lastSeen')">
          <div class="option-icon"><i class="fa-solid fa-users"></i></div>
          <div class="option-text">الجميع</div>
          <div class="option-check"><i class="fa-solid fa-check"></i></div>
        </div>
        <div class="privacy-option" data-value="me" onclick="selectPrivacyOption(this, 'lastSeen')">
          <div class="option-icon"><i class="fa-solid fa-user"></i></div>
          <div class="option-text">أنا فقط</div>
          <div class="option-check"><i class="fa-solid fa-check"></i></div>
        </div>
        <div class="privacy-option" data-value="friends" onclick="selectPrivacyOption(this, 'lastSeen')">
          <div class="option-icon"><i class="fa-solid fa-user-group"></i></div>
          <div class="option-text">أصدقائي فقط</div>
          <div class="option-check"><i class="fa-solid fa-check"></i></div>
        </div>
      </div>
    </div>
    
    <!-- الوصف -->
    <div class="privacy-setting">
      <h4><i class="fa-solid fa-id-card"></i> الوصف</h4>
      <div class="privacy-options">
        <div class="privacy-option" data-value="everyone" onclick="selectPrivacyOption(this, 'bio')">
          <div class="option-icon"><i class="fa-solid fa-users"></i></div>
          <div class="option-text">الجميع</div>
          <div class="option-check"><i class="fa-solid fa-check"></i></div>
        </div>
        <div class="privacy-option" data-value="me" onclick="selectPrivacyOption(this, 'bio')">
          <div class="option-icon"><i class="fa-solid fa-user"></i></div>
          <div class="option-text">أنا فقط</div>
          <div class="option-check"><i class="fa-solid fa-check"></i></div>
        </div>
        <div class="privacy-option" data-value="friends" onclick="selectPrivacyOption(this, 'bio')">
          <div class="option-icon"><i class="fa-solid fa-user-group"></i></div>
          <div class="option-text">أصدقائي فقط</div>
          <div class="option-check"><i class="fa-solid fa-check"></i></div>
        </div>
      </div>
    </div>
    
    <!-- المراسلة -->
    <div class="privacy-setting">
      <h4><i class="fa-solid fa-comment-dots"></i> المراسلة</h4>
      <div class="privacy-options">
        <div class="privacy-option" data-value="everyone" onclick="selectPrivacyOption(this, 'messaging')">
          <div class="option-icon"><i class="fa-solid fa-users"></i></div>
          <div class="option-text">الجميع</div>
          <div class="option-check"><i class="fa-solid fa-check"></i></div>
        </div>
        <div class="privacy-option" data-value="invite" onclick="selectPrivacyOption(this, 'messaging')">
          <div class="option-icon"><i class="fa-solid fa-envelope"></i></div>
          <div class="option-text">بطلب دعوة</div>
          <div class="option-check"><i class="fa-solid fa-check"></i></div>
        </div>
      </div>
    </div>
    
    <button onclick="savePrivacySettings()">حفظ التغييرات</button>
    <button onclick="closePrivacySettingsPopup()">إغلاق</button>
  </div>
  
  <!-- نافذة إعدادات المحادثة الجديدة -->
  <div class="chat-settings-popup" id="chat-settings-popup">
    <h3>إعدادات المحادثة</h3>
    
    <!-- حجم الخط -->
    <div class="setting-item">
      <label class="setting-label">حجم الخط</label>
      <div class="slider-container">
        <input type="range" id="font-size-slider" min="12" max="24" step="1" value="16">
        <span id="font-size-value" class="slider-value">16</span>
      </div>
      
      <!-- مثال حجم الخط -->
      <div class="font-size-example">
        <h4>مثال حجم الخط:</h4>
        <p id="font-size-example">هذا مثال لحجم الخط في المحادثة</p>
      </div>
    </div>
    
    <!-- زاوية الرسالة -->
    <div class="setting-item">
      <label class="setting-label">زاوية الرسالة</label>
      <div class="slider-container">
        <input type="range" id="message-radius-slider" min="0" max="30" step="1" value="10">
        <span id="message-radius-value" class="slider-value">10</span>
      </div>
      
      <!-- مثال زاوية الرسالة -->
      <div class="message-radius-example">
        <h4>مثال زاوية الرسالة:</h4>
        <div class="example-bubble" id="message-radius-example">
          هذه رسالة توضح زوايا الرسائل
        </div>
      </div>
    </div>
    
    <!-- لون الاسم -->
    <div class="setting-item">
      <label class="setting-label">لون الاسم</label>
      <div style="display: flex; align-items: center; gap: 10px;">
        <span class="color-preview" id="username-color-preview" style="background-color: #7289da;"></span>
        <input type="color" id="username-color-picker" value="#7289da" style="flex: 1; height: 40px;">
      </div>
    </div>
    
    <!-- نوع الخط -->
    <div class="setting-item">
      <label class="setting-label">نوع الخط</label>
      <select id="font-family-select" onchange="updateFontPreview()">
        <!-- الخطوط العربية -->
        <optgroup label="الخطوط العربية">
          <option value="Tajawal, sans-serif" style="font-family: 'Tajawal'">تاجوال</option>
          <option value="Almarai, sans-serif" style="font-family: 'Almarai'">المراعي</option>
          <option value="Changa, sans-serif" style="font-family: 'Changa'">تشانغا</option>
          <option value="Cairo, sans-serif" style="font-family: 'Cairo'">القاهرة</option>
          <option value="El Messiri, serif" style="font-family: 'El Messiri'">المسيري</option>
          <option value="Reem Kufi, sans-serif" style="font-family: 'Reem Kufi'">ريم كوفي</option>
          <option value="Lemonada, cursive" style="font-family: 'Lemonada'">ليمونادا</option>
          <option value="Amiri, serif" style="font-family: 'Amiri'">أميري</option>
          <option value="Scheherazade New, serif" style="font-family: 'Scheherazade New'">شهرزاد جديدة</option>
          <option value="Markazi Text, serif" style="font-family: 'Markazi Text'">مركزية نص</option>
          <option value="Noto Naskh Arabic, serif" style="font-family: 'Noto Naskh Arabic'">نوتو نسخ عربي</option>
          <option value="Harmattan, sans-serif" style="font-family: 'Harmattan'">حرمل</option>
          <option value="Lateef, serif" style="font-family: 'Lateef'">لطيف</option>
          <option value="Rakkas, cursive" style="font-family: 'Rakkas'">ركاز</option>
          <option value="Mirza, serif" style="font-family: 'Mirza'">مرزا</option>
          <option value="Katibeh, cursive" style="font-family: 'Katibeh'">كاتبة</option>
          <option value="Aref Ruqaa, serif" style="font-family: 'Aref Ruqaa'">عارف رقعة</option>
          <option value="Jomhuria, cursive" style="font-family: 'Jomhuria'">جمهورية</option>
          <option value="Mada, sans-serif" style="font-family: 'Mada'">مدى</option>
          <option value="Baloo Bhaijaan 2, cursive" style="font-family: 'Baloo Bhaijaan 2'">بالو بهيجان</option>
          <option value="Rubik, sans-serif" style="font-family: 'Rubik'">روبيك</option>
          <option value="'Droid Arabic Naskh', sans-serif" style="font-family: 'Droid Arabic Naskh'">درويد نسخ</option>
          <option value="'Droid Arabic Kufi', sans-serif" style="font-family: 'Droid Arabic Kufi'">درويد كوفي</option>
          <option value="'Arabic Typesetting', serif" style="font-family: 'Arabic Typesetting'">تنضيد عربي</option>
          <option value="'Traditional Arabic', serif" style="font-family: 'Traditional Arabic'">عربي تقليدي</option>
          <option value="'Simplified Arabic', sans-serif" style="font-family: 'Simplified Arabic'">عربي مبسط</option>
          <option value="'DecoType Naskh', serif" style="font-family: 'DecoType Naskh'">ديكوتايب نسخ</option>
          <option value="'Kufam', sans-serif" style="font-family: 'Kufam'">كفام</option>
          <option value="'Lalezar', cursive" style="font-family: 'Lalezar'">لالزار</option>
        </optgroup>
        
        <!-- الخطوط الإنجليزية -->
        <optgroup label="English Fonts">
          <option value="Roboto, sans-serif" style="font-family: 'Roboto'">Roboto</option>
          <option value="Montserrat, sans-serif" style="font-family: 'Montserrat'">Montserrat</option>
          <option value="Poppins, sans-serif" style="font-family: 'Poppins'">Poppins</option>
          <option value="Open Sans, sans-serif" style="font-family: 'Open Sans'">Open Sans</option>
          <option value="Raleway, sans-serif" style="font-family: 'Raleway'">Raleway</option>
          <option value="Lato, sans-serif" style="font-family: 'Lato'">Lato</option>
          <option value="Roboto Condensed, sans-serif" style="font-family: 'Roboto Condensed'">Roboto Condensed</option>
          <option value="Source Sans Pro, sans-serif" style="font-family: 'Source Sans Pro'">Source Sans Pro</option>
          <option value="Ubuntu, sans-serif" style="font-family: 'Ubuntu'">Ubuntu</option>
          <option value="Oswald, sans-serif" style="font-family: 'Oswald'">Oswald</option>
          <option value="Playfair Display, serif" style="font-family: 'Playfair Display'">Playfair Display</option>
          <option value="Merriweather, serif" style="font-family: 'Merriweather'">Merriweather</option>
          <option value="Arial, sans-serif" style="font-family: 'Arial'">Arial</option>
          <option value="Verdana, sans-serif" style="font-family: 'Verdana'">Verdana</option>
          <option value="Georgia, serif" style="font-family: 'Georgia'">Georgia</option>
          <option value="Times New Roman, serif" style="font-family: 'Times New Roman'">Times New Roman</option>
          <option value="Courier New, monospace" style="font-family: 'Courier New'">Courier New</option>
          <option value="Impact, sans-serif" style="font-family: 'Impact'">Impact</option>
          <option value="Comic Sans MS, cursive" style="font-family: 'Comic Sans MS'">Comic Sans</option>
          <option value="Trebuchet MS, sans-serif" style="font-family: 'Trebuchet MS'">Trebuchet</option>
        </optgroup>
      </select>
      <div id="font-preview-container" style="margin-top: 10px; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
        <p id="font-preview" style="font-size: 18px;">هذا مثال للنص يظهر بنوع الخط المحدد</p>
      </div>
    </div>
    
    <!-- أزرار التحكم -->
    <button onclick="saveChatSettings()">حفظ الإعدادات</button>
    <button onclick="closeChatSettingsPopup()">إغلاق</button>
  </div>
  
  <!-- نافذة تغيير الخلفية -->
  <div class="settings-popup" id="background-popup">
    <h3>اختر الخلفية</h3>
    <div class="background-options" id="background-options-container"></div>
    <button id="apply-bg-btn">تعيين</button>
    <!-- زر إزالة الخلفية الجديد -->
    <button id="remove-bg-btn" style="background: #dc3545; color: white; margin-top: 10px;">إزالة الخلفية</button>
    <button onclick="closeBackgroundPopup()">إغلاق</button>
  </div>
  
  <!-- نافذة تغيير المظهر -->
  <div class="theme-popup" id="theme-popup">
    <h3>اختر مظهر التطبيق</h3>
    
    <div class="theme-option" data-theme="light" onclick="selectTheme('light')">
      <div class="theme-icon"><i class="fa-solid fa-sun"></i></div>
      <div class="theme-text">الوضع الفاتح</div>
      <div class="theme-check"><i class="fa-solid fa-check"></i></div>
    </div>
    
    <div class="theme-option" data-theme="dark" onclick="selectTheme('dark')">
      <div class="theme-icon"><i class="fa-solid fa-moon"></i></div>
      <div class="theme-text">الوضع الداكن</div>
      <div class="theme-check"><i class="fa-solid fa-check"></i></div>
    </div>
    
    <button onclick="applyTheme()">تطبيق</button>
    <button onclick="closeThemePopup()">إغلاق</button>
  </div>
  
  <!-- نافذة تغيير الاسم -->
  <div class="settings-popup" id="change-name-popup">
    <h3>تغيير اسم المستخدم</h3>
    <input type="text" id="new-name" placeholder="أدخل الاسم الجديد">
    <button onclick="changeName()">تغيير الاسم</button>
    <button onclick="closeChangeNamePopup()">إغلاق</button>
  </div>
  <!-- نافذة تعديل الرسالة العامة -->
  <div class="settings-popup" id="edit-message-popup">
    <h3>تعديل الرسالة</h3>
    <textarea id="edit-message-input" rows="3"></textarea>
    <div style="margin-top:10px;">
      <button onclick="updateMessage()">تعديل</button>
      <button onclick="deleteEditedMessage()" style="background: #dc3545;">حذف رسالة</button>
      <button onclick="closeEditPopup()" style="background: #dc3545;">إغلاق</button>
    </div>
  </div>
  <!-- نافذة تعديل الرسالة الخاصة -->
  <div class="edit-private-message-popup" id="edit-private-message-popup">
    <h3>تعديل الرسالة</h3>
    <textarea id="edit-private-message-input" rows="3"></textarea>
    <div style="margin-top:10px;">
      <button onclick="updatePrivateMessage()">تعديل</button>
      <button onclick="deletePrivateMessage()" style="background: #dc3545;">حذف رسالة</button>
      <button onclick="closePrivateEditPopup()" style="background: #dc3545;">إغلاق</button>
    </div>
  </div>
  <!-- نافذة الإيموجي -->
  <div id="emoji-popup">
    <span class="emoji-option">👍</span>
    <span class="emoji-option">❤️</span>
    <span class="emoji-option">😂</span>
    <span class="emoji-option">😮</span>
    <span class="emoji-option">😢</span>
    <span class="emoji-option">😡</span>
  </div>
  <!-- صفحة الملف الشخصي الاحترافية -->
  <div id="profile-modal">
    <div class="modal-content">
      <!-- عنصر الحالة هنا يُعرض الحالة الحقيقية -->
      <p id="user-status" class="user-status-indicator"></p>
      <div id="profile-modal-body"></div>
      <button class="modal-close" onclick="closeProfileModal()">إغلاق</button>
    </div>
  </div>
  <!-- نافذة الرسائل الخاصة (قائمة الدردشات الخاصة) -->
  <div class="private-messages-popup" id="private-messages-popup">
    <div class="popup-header">
      <h3>الرسائل الخاصة</h3>
      <button class="close-btn" onclick="togglePrivateMessagesPopup()">×</button>
    </div>
    <div class="invites-tab" id="invites-tab">
      <div class="invites-tab-btn active" onclick="switchPrivateTab('chats')">المحادثات</div>
      <div class="invites-tab-btn" onclick="switchPrivateTab('invites')">الدعوات</div>
    </div>
    <div class="private-messages-list" id="private-chats-list">
      <!-- سيتم تحميل محادثات الرسائل الخاصة هنا -->
    </div>
    <div class="private-messages-list" id="private-invites-list" style="display: none;">
      <!-- سيتم تحميل الدعوات الواردة هنا -->
    </div>
  </div>
  <!-- نافذة الدردشة الخاصة -->
  <div class="private-chat-popup" id="private-chat-popup">
    <div class="chat-container">
      <div class="chat-header" id="private-chat-header">
        <div style="display:flex; align-items:center;">
          <i class="fa-solid fa-arrow-left back-icon" onclick="closePrivateChatPopup()"></i>
          <div class="chat-header-user">
            <img id="private-chat-avatar" class="chat-header-avatar" src="" alt="">
            <span id="private-chat-title">الدردشة الخاصة</span>
          </div>
        </div>
        <!-- عرض حالة المستخدم الآخر في الدردشة الخاصة -->
        <span id="chat-user-status" class="chat-user-status"></span>
      </div>
      <div class="chat-area" id="private-chat-area"></div>
      <!-- مؤشر الكتابة في الرسائل الخاصة -->
      <div id="typing-indicator" style="display: none;" class="typing-indicator">
        <span></span>
        <span></span>
        <span></span>
        <span style="margin-right: 8px;">يكتب الآن...</span>
      </div>
      <!-- منطقة الرد على الرسالة في الدردشة الخاصة -->
      <div id="private-reply-preview-container" style="display: none; padding: 0 10px;">
        <div class="reply-preview">
          <span id="private-reply-preview-text"></span>
          <span class="close-reply" onclick="cancelPrivateReply()">✕</span>
        </div>
      </div>
      <div class="message-input">
        <button class="attach-image-btn" id="private-attach-image-btn">
          <i class="fa-solid fa-camera"></i>
        </button>
        <input type="file" id="private-image-upload" accept="image/*" style="display: none;">
        <div id="private-upload-indicator" class="upload-indicator">
          <i class="fa-solid fa-spinner fa-spin"></i>
        </div>
        <textarea id="private-message-input" placeholder="اكتب رسالة..." rows="3"></textarea>
        <button onclick="sendPrivateMessage()">إرسال</button>
      </div>
    </div>
  </div>
  
  <!-- نافذة عرض الصورة -->
  <div class="image-modal" id="image-modal">
    <span class="close-image-modal" id="close-image-modal">&times;</span>
    <div class="image-modal-container">
      <img class="image-modal-content" id="full-size-image" src="">
      <div class="image-modal-controls">
        <button class="zoom-btn" id="zoom-in-btn"><i class="fa-solid fa-magnifying-glass-plus"></i></button>
        <button class="zoom-btn" id="zoom-out-btn"><i class="fa-solid fa-magnifying-glass-minus"></i></button>
        <button class="zoom-btn" id="reset-zoom-btn"><i class="fa-solid fa-arrows-rotate"></i></button>
        <button class="download-btn" id="download-btn"><i class="fa-solid fa-download"></i></button>
      </div>
    </div>
    <div class="full-image-caption" id="full-image-caption"></div>
  </div>
  
  <!-- نافذة إضافة نص للصورة -->
  <div class="image-caption-popup" id="image-caption-popup">
    <h3>أضف نصاً للصورة</h3>
    <textarea id="image-caption-input" placeholder="اكتب وصفاً للصورة (اختياري)"></textarea>
    <button onclick="sendImageWithCaption()">إرسال</button>
    <button onclick="closeImageCaptionPopup()" style="background: #dc3545; margin-top: 10px;">إلغاء</button>
  </div>
  
  <!-- مؤشر التحميل -->
  <div class="upload-indicator-container" id="upload-indicator-container">
    <div class="upload-spinner"></div>
  </div>
  
  <!-- نافذة الدعوة للمراسلة -->
  <div class="invite-popup" id="invite-popup">
    <h3>لا يمكنك مراسلة هذا المستخدم</h3>
    <p id="invite-message"></p>
    <div class="invite-buttons">
      <button class="invite-btn invite-send" id="send-invite-btn">إرسال دعوة</button>
      <button class="invite-btn invite-cancel" id="cancel-invite-btn">إلغاء</button>
    </div>
  </div>

  <!-- سكربتات Firebase والمكتبات الأخرى -->
  <script>
    // صورة افتراضية
    const defaultProfileImage = "https://www.gravatar.com/avatar/?d=mp";
    // مفتاح API الخاص بمعاينة الروابط
    const LINK_PREVIEW_API_KEY = "951325d26926d6d2ea4d2ce782629764";
    
    // مفاتيح Backendless API
    const BACKENDLESS_APP_ID = "1A59C778-783C-4A9B-8167-648ECCFDF394";
    const BACKENDLESS_API_KEY = "BBEAFC43-F642-44A3-B89A-245CA24C6D87";
    
    let currentUser = null;
    let currentGroup = 'general';
    let selectedGroupId = null;
    let selectedGroupData = {};
    let editingMessageId = null;
    let selectedBg = '';
    let selectedMessageForReaction = null;
    let currentImageToSend = null;
    let isPrivateImage = false;
    
    // المتغيرات الخاصة بالدردشة الخاصة
    let currentPrivateChatUser = null;
    let privateChatId = null;
    let editingPrivateMessageId = null;
    
    // إعدادات الخصوصية الحالية
    let privacySettings = {
      lastSeen: 'everyone',
      bio: 'everyone',
      messaging: 'everyone'
    };
    
    // إعدادات الإشعارات الحالية
    let notificationSettings = {
      privateMessages: true,
      notificationSound: 'default'
    };
    
    // تهيئة Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyBwwrBtf6AtW7R36FX4j2GQZVEdJldFq7o",
      authDomain: "you-unblock.firebaseapp.com",
      projectId: "you-unblock",
      storageBucket: "you-unblock",
      messagingSenderId: "306278978440",
      appId: "1:306278978440:web:4ca87c3856e107a30be03d"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // متغيرات لصور المجموعات
    let selectedGroupImageFile = null;
    let selectedEditGroupImageFile = null;
    
    // نغمات الإشعارات
    const notificationSounds = {
      'default': { name: 'نغمة افتراضية', url: 'https://assets.mixkit.co/sfx/preview/mixkit-message-pop-alert-2354.mp3' },
      'soft': { name: 'نغمة ناعمة', url: 'https://assets.mixkit.co/sfx/preview/mixkit-software-interface-start-2574.mp3' },
      'chime': { name: 'نغمة جرس', url: 'https://assets.mixkit.co/sfx/preview/mixkit-magic-chime-1933.mp3' },
      'digital': { name: 'نغمة رقمية', url: 'https://assets.mixkit.co/sfx/preview/mixkit-retro-game-emergency-alarm-1000.mp3' },
      'bubble': { name: 'نغمة فقاعات', url: 'https://assets.mixkit.co/sfx/preview/mixkit-bubble-pop-up-alert-notification-2357.mp3' },
      'alert': { name: 'نغمة تنبيه', url: 'https://assets.mixkit.co/sfx/preview/mixkit-alert-quick-notice-2291.mp3' },
      'bell': { name: 'نغمة جرس قديم', url: 'https://assets.mixkit.co/sfx/preview/mixkit-classic-alarm-995.mp3' },
      'ding': { name: 'نغمة دينغ', url: 'https://assets.mixkit.co/sfx/preview/mixkit-achievement-bell-600.mp3' },
      'trill': { name: 'نغمة رنين', url: 'https://assets.mixkit.co/sfx/preview/mixkit-happy-bells-notification-937.mp3' },
      'tone': { name: 'نغمة بسيطة', url: 'https://assets.mixkit.co/sfx/preview/mixkit-software-interface-start-2574.mp3' }
    };
    
    // كائن لتشغيل الأصوات
    let notificationSoundPlayer = null;

    // قائمة الخلفيات
    const backgrounds = [
      "https://images.unsplash.com/photo-1499002238440-d264edd596ec?q=80&w=2070&auto=format&fit=crop",
      "https://images.unsplash.com/photo-1465146344425-f00d5f5c8f07?q=80&w=2076&auto=format&fit=crop",
      "https://images.unsplash.com/photo-1470071459604-3b5ec3a7fe05?q=80&w=1874&auto=format&fit=crop",
      "https://images.unsplash.com/photo-1441974231531-c6227db76b6e?q=80&w=2071&auto=format&fit=crop",
      "https://images.unsplash.com/photo-1476820865390-c52aeebb9891?q=80&w=2070&auto=format&fit=crop",
      "https://images.unsplash.com/photo-1501854140801-50d01698950b?q=80&w=2048&auto=format&fit=crop",
      "https://images.unsplash.com/photo-1426604966848-d7adac402bff?q=80&w=2070&auto=format&fit=crop",
      "https://images.unsplash.com/photo-1475924156734-496f6cac6ec1?q=80&w=2070&auto=format&fit=crop",
      "https://images.unsplash.com/photo-1433086966358-54859d0ed716?q=80&w=2067&auto=format&fit=crop",
      "https://images.unsplash.com/photo-1418065460487-3e41a6c84dc5?q=80&w=2070&auto=format&fit=crop",
      "https://images.unsplash.com/photo-1470252649378-9c29740c9fa8?q=80&w=2070&auto=format&fit=crop",
      "https://images.unsplash.com/photo-1506905925346-21bda4d32df4?q=80&w=2070&auto=format&fit=crop",
      "https://images.unsplash.com/photo-1431794062232-2a99a5431c6c?q=80&w=2070&auto=format&fit=crop",
      "https://images.unsplash.com/photo-1470071459604-3b5ec3a7fe05?q=80&w=1874&auto=format&fit=crop",
      "https://images.unsplash.com/photo-1506260408121-e353d10b87c7?q=80&w=2128&auto=format&fit=crop"
    ];

    // متغيرات الرد على الرسائل
    let replyingToMessage = null;
    let replyingInPrivate = false;
    
    // متغيرات مؤشر الكتابة في الرسائل الخاصة
    let typingTimeout;
    let isTyping = false;

    /* ==========================
       تحديث حالة المستخدم (online/offline) مع زر الحالة
       ========================== */
    function setUserStatusOnline() {
      if(currentUser && currentUser.id) {
        db.collection('users').doc(currentUser.id).update({
          status: "online",
          lastSeen: firebase.firestore.FieldValue.serverTimestamp()
        });
      }
    }
    function setUserStatusOffline() {
      if(currentUser && currentUser.id) {
        db.collection('users').doc(currentUser.id).update({
          status: "offline",
          lastSeen: firebase.firestore.FieldValue.serverTimestamp()
        });
      }
    }
    
    // تحديث الحالة عند تغيير حالة المصادقة
    auth.onAuthStateChanged(user => {
      if(user) {
        db.collection('users').doc(user.uid).get().then(doc => {
          if(doc.exists) {
            currentUser = doc.data();
            currentUser.id = user.uid;
            setUserStatusOnline();
            
            // تحميل إعدادات الخصوصية
            if (currentUser.privacySettings) {
              privacySettings = currentUser.privacySettings;
            }
            
            // تحميل إعدادات الإشعارات
            if (currentUser.notificationSettings) {
              notificationSettings = currentUser.notificationSettings;
            } else {
              // الإعدادات الافتراضية للإشعارات
              notificationSettings = {
                privateMessages: true,
                notificationSound: 'default'
              };
            }
            
            // تحميل الخلفية المحفوظة للمستخدم
            if (currentUser.background) {
              selectedBg = currentUser.background;
              applyBackgroundToUI(currentUser.background);
            } else {
              // إذا لم يكن هناك خلفية محفوظة، جرب تحميل من localStorage (للتوافق مع الإصدار القديم)
              const savedBg = localStorage.getItem('chatBackground');
              if (savedBg) {
                applyBackgroundToUI(savedBg);
              }
            }
            
            loadGroups();
            currentGroup = localStorage.getItem('lastGroup') || 'general';
            loadMessages();
            loadPrivateMessages(); // تحميل الرسائل الخاصة والدعوات
            loadChatSettings(); // تحميل إعدادات المحادثة
            loadNotificationSettings(); // تحميل إعدادات الإشعارات
            
            // فحص إذن الإشعارات بعد تسجيل الدخول
            checkNotificationPermission();
          } else {
            currentUser = {
              id: user.uid,
              name: user.displayName || "مستخدم مجهول",
              description: "",
              username: "",
              createdAt: new Date().toISOString(),
              photoURL: user.photoURL || defaultProfileImage,
              status: "online",
              privacySettings: privacySettings,
              notificationSettings: notificationSettings // إضافة إعدادات الإشعارات الافتراضية
            };
            db.collection('users').doc(user.uid).set(currentUser);
          }
        });
        window.addEventListener("beforeunload", setUserStatusOffline);
      } else {
        window.location.href = 'login.html';
      }
    });
    
    // تطبيق الخلفية على واجهة المستخدم
    function applyBackgroundToUI(bgUrl) {
      document.querySelectorAll('.chat-area').forEach(elem => {
        elem.style.backgroundImage = bgUrl ? `url(${bgUrl})` : 'none';
      });
    }
    
    /* ==========================
       دالة لتنسيق الوقت المنقضي منذ آخر ظهور
       ========================== */
    function formatLastSeen(lastSeen) {
      if (!lastSeen) return "قبل وقت طويل";
      
      const now = new Date();
      const lastSeenDate = lastSeen.toDate();
      const diffSeconds = Math.floor((now - lastSeenDate) / 1000);
      
      if (diffSeconds < 60) {
        return "قبل ثوانٍ";
      } else if (diffSeconds < 3600) {
        const minutes = Math.floor(diffSeconds / 60);
        return `قبل ${minutes} دقيقة`;
      } else if (diffSeconds < 86400) {
        const hours = Math.floor(diffSeconds / 3600);
        return `قبل ${hours} ساعة`;
      } else if (diffSeconds < 604800) {
        const days = Math.floor(diffSeconds / 86400);
        return `قبل ${days} يوم`;
      } else if (diffSeconds < 2592000) {
        const weeks = Math.floor(diffSeconds / 604800);
        return `قبل ${weeks} أسبوع`;
      } else {
        const months = Math.floor(diffSeconds / 2592000);
        return `قبل ${months} شهر`;
      }
    }
    
    /* ==========================
       عرض الحالة الحقيقية للمستخدم (زر الحالة)
       ========================== */
    function getUserStatus(userId) {
      const userRef = db.collection("users").doc(userId);
      userRef.onSnapshot((doc) => {
        if (doc.exists) {
          const data = doc.data();
          const statusElement = document.getElementById("user-status");
          
          if (data.status === "online") {
            statusElement.innerText = "متصل الآن";
            statusElement.className = "user-status-indicator status-online";
          } else {
            const lastSeenText = formatLastSeen(data.lastSeen);
            statusElement.innerText = lastSeenText;
            statusElement.className = "user-status-indicator status-offline";
          }
        }
      });
    }
    
    function updateChatUserStatus(userId) {
      const statusElement = document.getElementById("chat-user-status");
      db.collection("users").doc(userId).onSnapshot((doc) => {
        if (doc.exists) {
          const data = doc.data();
          if (data.status === "online") {
            statusElement.innerText = "متصل الآن";
            statusElement.style.color = "green";
          } else {
            const lastSeenText = formatLastSeen(data.lastSeen);
            statusElement.innerText = lastSeenText;
            statusElement.style.color = "red";
          }
        }
      });
    }
    
    /* ==========================
       دوال تحميل المجموعات والرسائل والدردشات العامة
       ========================== */
    function loadGroups() {
      db.collection('groups').orderBy('createdAt').onSnapshot(snapshot => {
        const groupList = document.getElementById('group-list');
        groupList.innerHTML = "";
        snapshot.forEach(doc => {
          const data = doc.data();
          const groupCard = document.createElement('div');
          groupCard.className = 'group-card';
          groupCard.dataset.groupId = doc.id;
          if(doc.id === currentGroup) {
            groupCard.classList.add('active');
          }
          if(data.image && data.image.trim() !== "") {
            groupCard.innerHTML = `<img src="${data.image}" class="group-image" alt="${data.name}">`;
          } else {
            groupCard.innerHTML = `<div class="group-initial">${data.name.charAt(0).toUpperCase()}</div>`;
          }
          let pressTimer;
          let longPress = false;
          groupCard.addEventListener('mousedown', (e) => {
            longPress = false;
            pressTimer = setTimeout(() => {
              longPress = true;
              if(data.creatorId === currentUser.id) {
                showGroupOptionsPopup(doc.id, data);
              }
            }, 800);
          });
          groupCard.addEventListener('touchstart', (e) => {
            longPress = false;
            pressTimer = setTimeout(() => {
              longPress = true;
              if(data.creatorId === currentUser.id) {
                showGroupOptionsPopup(doc.id, data);
              }
            }, 800);
          });
          groupCard.addEventListener('mouseup', (e) => {
            clearTimeout(pressTimer);
            if(!longPress) {
              enterGroup(doc.id);
            }
          });
          groupCard.addEventListener('touchend', (e) => {
            clearTimeout(pressTimer);
            if(!longPress) {
              enterGroup(doc.id);
            }
          });
          groupCard.addEventListener('mouseleave', (e) => {
            clearTimeout(pressTimer);
          });
          groupList.appendChild(groupCard);
        });
        populateRoomsPopup();
      });
    }
    
    // دالة تحليل الروابط باستخدام تعبير نمطي
    function extractURLs(text) {
      const urlRegex = /(https?:\/\/[^\s]+)/g;
      return text.match(urlRegex);
    }
    
    // دالة استدعاء API للحصول على معاينة الرابط
    async function getLinkPreview(url) {
      try {
        const response = await fetch(`https://api.linkpreview.net/?key=${LINK_PREVIEW_API_KEY}&q=${encodeURIComponent(url)}`);
        if(response.ok){
          return await response.json();
        }
      } catch(err) {
        console.error("Error fetching link preview:", err);
      }
      return null;
    }
    
    // تحويل الروابط في النص إلى روابط قابلة للنقر
    function linkifyText(text) {
      const urlRegex = /(https?:\/\/[^\s]+)/g;
      return text.replace(urlRegex, url => {
        return `<a href="${url}" target="_blank" class="message-link">${url}</a>`;
      });
    }
    
    // تحميل الرسائل العامة مع دعم عرض معاينة الرابط
    function loadMessages() {
      const messagesContainer = document.getElementById('messages');
      db.collection('groups').doc(currentGroup).collection('messages')
        .orderBy('timestamp')
        .onSnapshot(snapshot => {
          messagesContainer.innerHTML = "";
          snapshot.forEach(doc => {
            const msg = doc.data();
            let timeString = "";
            if(msg.timestamp) {
              timeString = new Date(msg.timestamp.toDate()).toLocaleTimeString();
            }
            if(msg.edited) {
              timeString += " (تم تعديل)";
            }
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message ' + (msg.senderId === currentUser.id ? 'sent' : 'received');
    
            const profileImgDiv = document.createElement('div');
            profileImgDiv.className = 'message-profile';
            let senderPhoto = msg.senderPhoto || defaultProfileImage;
            profileImgDiv.style.backgroundImage = 'url(' + senderPhoto + ')';
            profileImgDiv.addEventListener('click', function(e) {
              e.stopPropagation();
              showProfileModal({ id: msg.senderId, name: msg.senderName, photoURL: senderPhoto });
              if(msg.senderId === currentUser.id){
                getUserStatus(currentUser.id);
              }
            });
            messageDiv.appendChild(profileImgDiv);
    
            const bubbleDiv = document.createElement('div');
            bubbleDiv.className = 'message-bubble';
            
            // التحقق مما إذا كانت الرسالة تحتوي على صورة
            if (msg.isImage) {
              bubbleDiv.innerHTML = `<strong style="color: var(--username-color);">${msg.senderName}:</strong><br>`;
              const imgElement = document.createElement('img');
              imgElement.src = msg.imageUrl;
              imgElement.className = 'thumbnail-image';
              imgElement.onclick = () => openImageModal(msg.imageUrl, msg.text || '');
              bubbleDiv.appendChild(imgElement);
              
              // إذا كان هناك نص، عرضه أسفل الصورة
              if (msg.text) {
                const captionDiv = document.createElement('div');
                captionDiv.className = 'image-caption';
                captionDiv.textContent = msg.text;
                bubbleDiv.appendChild(captionDiv);
              }
              
              bubbleDiv.innerHTML += `<div class="message-time">${timeString}</div>`;
            } else {
              // تحويل الروابط في النص إلى روابط قابلة للنقر
              const linkedText = linkifyText(msg.text);
              
              // إذا كانت الرسالة تحتوي على معاينة رابط فقم بعرضها
              if(msg.linkPreview) {
                bubbleDiv.innerHTML = `<strong style="color: var(--username-color);">${msg.senderName}:</strong> ${linkedText} <div class="message-time">${timeString}</div>`;
                
                const previewLink = document.createElement('a');
                previewLink.href = msg.linkPreview.url;
                previewLink.target = "_blank";
                previewLink.className = "link-preview";
                previewLink.innerHTML = `
                  ${ msg.linkPreview.image ? `<img src="${msg.linkPreview.image}" alt="معاينة">` : '' }
                  <div class="preview-details">
                    <h4>${msg.linkPreview.title || ''}</h4>
                    <p>${msg.linkPreview.description || ''}</p>
                  </div>
                `;
                bubbleDiv.appendChild(previewLink);
              } else {
                bubbleDiv.innerHTML = `<strong style="color: var(--username-color);">${msg.senderName}:</strong> ${linkedText} <div class="message-time">${timeString}</div>`;
              }
            }
    
            messageDiv.appendChild(bubbleDiv);
    
            if(msg.senderId === currentUser.id) {
              const optionsIcon = document.createElement('div');
              optionsIcon.className = 'options-icon';
              optionsIcon.innerHTML = '<i class="fa-solid fa-ellipsis-h"></i>';
              bubbleDiv.appendChild(optionsIcon);
              bubbleDiv.addEventListener('click', function(e) {
                e.stopPropagation();
                let panel = bubbleDiv.querySelector('.options-panel');
                if(panel) {
                  panel.style.display = (panel.style.display === 'block') ? 'none' : 'block';
                }
              });
    
              const optionsPanel = document.createElement('div');
              optionsPanel.className = 'options-panel';
              const editBtn = document.createElement('button');
              editBtn.textContent = 'تعديل';
              editBtn.onclick = function(e) {
                e.stopPropagation();
                openEditPopup(doc.id, msg.text);
                optionsPanel.style.display = 'none';
              };
              const deleteBtn = document.createElement('button');
              deleteBtn.textContent = 'حذف';
              deleteBtn.onclick = function(e) {
                e.stopPropagation();
                deleteMessage(doc.id);
                optionsPanel.style.display = 'none';
              };
              optionsPanel.appendChild(editBtn);
              optionsPanel.appendChild(deleteBtn);
              bubbleDiv.appendChild(optionsPanel);
            }
    
            const emojiIcon = document.createElement('div');
            emojiIcon.className = 'emoji-icon';
            emojiIcon.innerHTML = '<i class="fa-regular fa-face-smile"></i>';
            bubbleDiv.appendChild(emojiIcon);
            emojiIcon.addEventListener('click', function(e) {
              e.stopPropagation();
              selectedMessageForReaction = { id: doc.id, element: messageDiv };
              showEmojiPopupForMessage(messageDiv);
            });
            
            // إضافة زر الرد
            const replyIcon = document.createElement('div');
            replyIcon.className = 'reply-icon';
            replyIcon.innerHTML = '<i class="fa-solid fa-reply"></i>';
            replyIcon.addEventListener('click', function(e) {
              e.stopPropagation();
              replyToMessage(msg, false);
            });
            bubbleDiv.appendChild(replyIcon);
    
            if(msg.reactions) {
              for(let emoji in msg.reactions) {
                let users = msg.reactions[emoji];
                let count = users.length;
                const reactionSpan = document.createElement('span');
                reactionSpan.className = 'reaction';
                reactionSpan.textContent = emoji + (count > 1 ? " " + count : "");
                reactionSpan.addEventListener('click', function(e) {
                  e.stopPropagation();
                  if(!users.includes(currentUser.id)) {
                    let newUsers = [...users, currentUser.id];
                    db.collection('groups').doc(currentGroup).collection('messages').doc(doc.id).update({
                      [`reactions.${emoji}`]: newUsers
                    });
                  }
                });
                reactionSpan.addEventListener('mousedown', function(e) {
                  let pressTimer = setTimeout(() => {
                    if(users.includes(currentUser.id)) {
                      let newUsers = users.filter(id => id !== currentUser.id);
                      let updateObj = {};
                      if(newUsers.length > 0) {
                        updateObj[`reactions.${emoji}`] = newUsers;
                      } else {
                        updateObj[`reactions.${emoji}`] = firebase.firestore.FieldValue.delete();
                      }
                      db.collection('groups').doc(currentGroup).collection('messages').doc(doc.id).update(updateObj);
                    }
                  }, 800);
                  reactionSpan.addEventListener('mouseup', function(e) {
                    clearTimeout(pressTimer);
                  });
                });
                bubbleDiv.appendChild(reactionSpan);
              }
            }
    
            messagesContainer.appendChild(messageDiv);
            
            // إضافة تفاعل السحب لليمين للرد
            const hammer = new Hammer(messageDiv);
            hammer.on('swiperight', function() {
              // إضافة تأثير السحب
              messageDiv.classList.add('swiping');
              setTimeout(() => {
                messageDiv.classList.remove('swiping');
              }, 300);
              
              replyToMessage(msg, false);
            });
          });
          messagesContainer.scrollTop = messagesContainer.scrollHeight;
        });
    }
    
    // إرسال الرسالة العامة مع دعم معاينة الرابط
    function sendMessage() {
      const input = document.getElementById('message-input');
      let text = input.value.trim();
      if(!text) return;
      
      // إضافة الرد إذا كان هناك رد على رسالة
      if (replyingToMessage) {
        const replyText = `رد على ${replyingToMessage.senderName}: ${replyingToMessage.text.substring(0, 30)}${replyingToMessage.text.length > 30 ? '...' : ''}\n${text}`;
        text = replyText;
      }
      
      const messageData = {
        text: text,
        senderId: currentUser.id,
        senderName: currentUser.name,
        senderPhoto: currentUser.photoURL || defaultProfileImage,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      };
      
      const urls = extractURLs(text);
      if(urls && urls.length > 0) {
        getLinkPreview(urls[0]).then(previewData => {
          if(previewData) {
            messageData.linkPreview = previewData;
          }
          db.collection('groups').doc(currentGroup).collection('messages').add(messageData)
            .then(() => {
              input.value = "";
              cancelReply(); // إلغاء الرد بعد الإرسال
            }).catch(err => console.error("Error sending message:", err));
        });
      } else {
        db.collection('groups').doc(currentGroup).collection('messages').add(messageData)
          .then(() => {
            input.value = "";
            cancelReply(); // إلغاء الرد بعد الإرسال
          }).catch(err => console.error("Error sending message:", err));
      }
    }
   
    
    function enterGroup(groupId) {
      currentGroup = groupId;
      localStorage.setItem('lastGroup', groupId);
      loadMessages();
      loadGroups();
    }
    
    function populateRoomsPopup() {
      const container = document.getElementById('rooms-grid');
      container.innerHTML = "";
      db.collection('groups').orderBy('createdAt').get().then(snapshot => {
        snapshot.forEach(doc => {
          const data = doc.data();
          const roomCard = document.createElement('div');
          roomCard.className = 'room-card';
          
          // إضافة أيقونة التعديل للصاحب فقط
          if (data.creatorId === currentUser.id) {
            const editIcon = document.createElement('div');
            editIcon.className = 'room-edit-icon';
            editIcon.innerHTML = '<i class="fas fa-edit"></i>';
            editIcon.addEventListener('click', function(e) {
              e.stopPropagation();
              showGroupOptionsPopup(doc.id, data);
            });
            roomCard.appendChild(editIcon);
          }
          
          if(data.image && data.image.trim() !== "") {
            const img = document.createElement('img');
            img.src = data.image;
            img.alt = data.name;
            roomCard.appendChild(img);
          } else {
            const div = document.createElement('div');
            div.style.fontSize = '24px';
            div.style.color = '#fff';
            div.textContent = data.name.charAt(0).toUpperCase();
            roomCard.appendChild(div);
          }
          const span = document.createElement('span');
          span.textContent = data.name;
          roomCard.appendChild(span);
          roomCard.addEventListener('click', function() {
            enterGroup(doc.id);
            toggleRoomsPopup();
          });
          container.appendChild(roomCard);
        });
      });
    }
    
    function deleteMessage(messageId) {
      if(confirm("هل تريد حذف الرسالة؟")) {
        db.collection('groups').doc(currentGroup).collection('messages').doc(messageId).delete();
      }
    }
    
    function openEditPopup(messageId, currentText) {
      editingMessageId = messageId;
      document.getElementById('edit-message-input').value = currentText;
      document.getElementById('edit-message-popup').style.display = 'block';
    }
    function closeEditPopup() {
      editingMessageId = null;
      document.getElementById('edit-message-popup').style.display = 'none';
    }
    
    function updateMessage() {
      const newText = document.getElementById('edit-message-input').value.trim();
      if(!newText) {
        alert("الرجاء إدخال نص الرسالة");
        return;
      }
      if(editingMessageId) {
        db.collection('groups').doc(currentGroup).collection('messages').doc(editingMessageId).update({
          text: newText,
          edited: true,
          editTimestamp: firebase.firestore.FieldValue.serverTimestamp()
        }).then(() => {
          alert("تم تعديل الرسالة بنجاح");
          closeEditPopup();
        }).catch(err => console.error("Error updating message:", err));
      }
    }
    
    function deleteEditedMessage() {
      if(confirm("هل تريد حذف الرسالة؟")) {
        db.collection('groups').doc(currentGroup).collection('messages').doc(editingMessageId).delete()
          .then(() => {
            alert("تم حذف الرسالة");
            closeEditPopup();
          })
          .catch(err => console.error("Error deleting message:", err));
      }
    }
    
    function showSettingsPopup() {
      document.getElementById('settings-popup').style.display = 'block';
    }
    function closeSettingsPopup() {
      document.getElementById('settings-popup').style.display = 'none';
    }
    function openCreateGroupPopup() {
      document.getElementById('create-group-popup').style.display = 'block';
    }
    function closeCreateGroupPopup() {
      document.getElementById('create-group-popup').style.display = 'none';
    }
    function closeGroupOptionsPopup() {
      document.getElementById('group-options-popup').style.display = 'none';
    }
    
    document.getElementById('delete-group-btn').addEventListener('click', function() {
      if(confirm("هل أنت متأكد من حذف المجموعة؟")) {
        db.collection('groups').doc(selectedGroupId).delete()
          .then(() => {
            closeGroupOptionsPopup();
            if(currentGroup === selectedGroupId) {
              currentGroup = 'general';
              loadMessages();
            }
          })
          .catch(err => console.error("Error deleting group:", err));
      }
    });
    
    document.getElementById('edit-group-btn').addEventListener('click', function() {
      closeGroupOptionsPopup();
      document.getElementById('edit-group-name').value = selectedGroupData.name;
      document.getElementById('edit-group-image').value = selectedGroupData.image || "";
      const preview = document.getElementById('edit-group-image-preview');
      if (selectedGroupData.image) {
        preview.src = selectedGroupData.image;
        preview.style.display = 'block';
      } else {
        preview.style.display = 'none';
      }
      selectedEditGroupImageFile = null;
      document.getElementById('edit-group-popup').style.display = 'block';
    });
    
    function closeEditGroupPopup() {
      document.getElementById('edit-group-popup').style.display = 'none';
    }
    
    async function saveGroupEdits() {
      const newName = document.getElementById('edit-group-name').value.trim();
      let newImage = document.getElementById('edit-group-image').value.trim();
      
      if(!newName) {
        alert("الرجاء إدخال اسم المجموعة");
        return;
      }
      
      // إذا تم اختيار ملف صورة، نرفعه أولاً
      if (selectedEditGroupImageFile) {
        try {
          const imageUrl = await uploadImageToBackendless(selectedEditGroupImageFile);
          if (imageUrl) {
            newImage = imageUrl;
          } else {
            alert("فشل رفع الصورة. سيتم استخدام الرابط اليدوي إن وجد.");
          }
        } catch (error) {
          console.error("Error uploading group image:", error);
          alert("حدث خطأ أثناء رفع الصورة: " + error.message);
        }
      }
      
      // إذا لم يتم رفع صورة ولم يتم إدخال رابط، نترك الصورة كما هي
      const updateData = {
        name: newName
      };
      
      if (newImage) {
        updateData.image = newImage;
      }
      
      db.collection('groups').doc(selectedGroupId).update(updateData)
        .then(() => {
          closeEditGroupPopup();
          selectedEditGroupImageFile = null;
          document.getElementById('edit-group-image-preview').style.display = 'none';
          document.getElementById('edit-group-image-preview').src = "";
          document.getElementById('edit-group-image-file').value = "";
        })
        .catch(err => console.error("Error updating group:", err));
    }
    
    function changeName() {
      const newName = document.getElementById('new-name').value.trim();
      if(newName) {
        currentUser.name = newName;
        db.collection('users').doc(currentUser.id).update({ name: newName });
        alert("تم تغيير الاسم بنجاح!");
        document.getElementById('change-name-popup').style.display = 'none';
        document.getElementById('settings-popup').style.display = 'block';
      } else {
        alert("الرجاء إدخال اسم جديد");
      }
    }
    
    document.getElementById('toggle-theme').addEventListener('click', function() {
      document.getElementById('theme-popup').style.display = 'block';
      document.getElementById('settings-popup').style.display = 'none';
      
      // تحديث الخيارات في نافذة المظهر
      const mode = localStorage.getItem('mode') || 'light';
      const options = document.querySelectorAll('.theme-option');
      options.forEach(option => {
        option.classList.remove('selected');
        if (option.dataset.theme === mode) {
          option.classList.add('selected');
        }
      });
    });
    
    function selectTheme(theme) {
      const options = document.querySelectorAll('.theme-option');
      options.forEach(option => {
        option.classList.remove('selected');
        if (option.dataset.theme === theme) {
          option.classList.add('selected');
        }
      });
    }
    
    function applyTheme() {
      const selectedOption = document.querySelector('.theme-option.selected');
      if (selectedOption) {
        const theme = selectedOption.dataset.theme;
        
        if(theme === 'dark') {
          document.body.classList.add('dark-mode');
          localStorage.setItem('mode', 'dark');
        } else {
          document.body.classList.remove('dark-mode');
          localStorage.setItem('mode', 'light');
        }
        
        closeThemePopup();
      }
    }
    
    function closeThemePopup() {
      document.getElementById('theme-popup').style.display = 'none';
      document.getElementById('settings-popup').style.display = 'block';
    }
    
    document.getElementById('change-bg-btn').addEventListener('click', function() {
      document.getElementById('settings-popup').style.display = 'none';
      document.getElementById('background-popup').style.display = 'block';
      populateBackgroundOptions();
    });
    
    // تعبئة خيارات الخلفيات
    function populateBackgroundOptions() {
      const container = document.getElementById('background-options-container');
      container.innerHTML = '';
      
      // إضافة خيار الخلفية الافتراضية (بدون صورة)
      const defaultOption = document.createElement('div');
      defaultOption.className = 'bg-option default-bg-option';
      defaultOption.innerHTML = '<span>افتراضي</span>';
      defaultOption.addEventListener('click', function() {
        document.querySelectorAll('.bg-option').forEach(opt => {
          opt.classList.remove('selected');
        });
        this.classList.add('selected');
        selectedBg = ''; // قيمة فارغة تعني الخلفية الافتراضية
      });
      container.appendChild(defaultOption);
      
      backgrounds.forEach(bg => {
        const bgOption = document.createElement('div');
        bgOption.className = 'bg-option';
        bgOption.style.backgroundImage = `url(${bg})`;
        bgOption.addEventListener('click', function() {
          document.querySelectorAll('.bg-option').forEach(opt => {
            opt.classList.remove('selected');
          });
          this.classList.add('selected');
          selectedBg = bg;
        });
        container.appendChild(bgOption);
      });
    }
    
    // تطبيق الخلفية وحفظها في قاعدة البيانات
    async function applyBackground() {
      // تطبيق الخلفية على الواجهة
      applyBackgroundToUI(selectedBg);

      // حفظ الخلفية في قاعدة البيانات للمستخدم الحالي
      if (currentUser && currentUser.id) {
        try {
          await db.collection('users').doc(currentUser.id).update({
            background: selectedBg
          });
        } catch (error) {
          console.error("Error saving background:", error);
          alert("حدث خطأ أثناء حفظ الخلفية.");
        }
      }

      localStorage.setItem('chatBackground', selectedBg);
      alert("تم تغيير خلفية الدردشة بنجاح");
      document.getElementById('background-popup').style.display = 'none';
      document.getElementById('settings-popup').style.display = 'block';
    }
    
    // إزالة الخلفية (استعادة الخلفية الافتراضية)
    async function removeBackground() {
      // إزالة الخلفية من الواجهة
      applyBackgroundToUI('');
      
      // إزالة الخلفية من قاعدة البيانات
      if (currentUser && currentUser.id) {
        try {
          await db.collection('users').doc(currentUser.id).update({
            background: firebase.firestore.FieldValue.delete()
          });
        } catch (error) {
          console.error("Error removing background:", error);
          alert("حدث خطأ أثناء إزالة الخلفية.");
        }
      }
      
      localStorage.removeItem('chatBackground');
      alert("تم إزالة الخلفية بنجاح");
      document.getElementById('background-popup').style.display = 'none';
      document.getElementById('settings-popup').style.display = 'block';
    }
    
    document.getElementById('logout-btn').addEventListener('click', function() {
      firebase.auth().signOut().then(() => {
        window.location.href = 'login.html';
      }).catch(err => alert("حدث خطأ أثناء تسجيل الخروج: " + err.message));
    });
    
    function closeChangeNamePopup() {
      document.getElementById('change-name-popup').style.display = 'none';
      document.getElementById('settings-popup').style.display = 'block';
    }
    
    document.getElementById('change-name-btn').addEventListener('click', function() {
      document.getElementById('change-name-popup').style.display = 'block';
      document.getElementById('settings-popup').style.display = 'none';
    });
    
    function closeBackgroundPopup() {
      document.getElementById('background-popup').style.display = 'none';
      document.getElementById('settings-popup').style.display = 'block';
    }
    
    // عرض نافذة خيارات المجموعة
    function showGroupOptionsPopup(groupId, data) {
      selectedGroupId = groupId;
      selectedGroupData = data;
      document.getElementById('group-options-popup').style.display = 'block';
    }
    
    // نافذة الإيموجي
    function showEmojiPopupForMessage(messageElement) {
      const popup = document.getElementById('emoji-popup');
      popup.style.display = 'block';
      const rect = messageElement.getBoundingClientRect();
      const popupWidth = popup.offsetWidth;
      const left = rect.left + rect.width / 2 - popupWidth / 2;
      const top = rect.bottom + 10;
      popup.style.left = left + 'px';
      popup.style.top = top + 'px';
    }
    
    function hideEmojiPopup() {
      document.getElementById('emoji-popup').style.display = 'none';
    }
    
    document.querySelectorAll('#emoji-popup .emoji-option').forEach(emoji => {
      emoji.addEventListener('click', function(e) {
        const selectedEmoji = this.textContent;
        if(selectedMessageForReaction && selectedMessageForReaction.element) {
          db.collection('groups').doc(currentGroup).collection('messages').doc(selectedMessageForReaction.id).get().then(docSnapshot => {
            let msgData = docSnapshot.data();
            let reactions = msgData.reactions || {};
            let users = reactions[selectedEmoji] || [];
            if(!users.includes(currentUser.id)) {
              users.push(currentUser.id);
              let updateObj = {};
              updateObj[`reactions.${selectedEmoji}`] = users;
              db.collection('groups').doc(currentGroup).collection('messages').doc(selectedMessageForReaction.id).update(updateObj);
            }
          });
        }
        hideEmojiPopup();
        e.stopPropagation();
      });
    });
    
    document.addEventListener('click', function(e) {
      const popup = document.getElementById('emoji-popup');
      if(popup.style.display === 'block' && !popup.contains(e.target)) {
        hideEmojiPopup();
      }
    });
    
    // إنشاء مجموعة
    async function createGroup() {
      const groupName = document.getElementById('group-name').value.trim();
      let groupImage = document.getElementById('group-image').value.trim();
      
      if(!groupName) {
        alert("يرجى إدخال اسم المجموعة");
        return;
      }
      
      // إذا تم اختيار ملف صورة، نرفعه أولاً
      if (selectedGroupImageFile) {
        try {
          const imageUrl = await uploadImageToBackendless(selectedGroupImageFile);
          if (imageUrl) {
            groupImage = imageUrl;
          } else {
            alert("فشل رفع الصورة. سيتم استخدام الرابط اليدوي إن وجد.");
          }
        } catch (error) {
          console.error("Error uploading group image:", error);
          alert("حدث خطأ أثناء رفع الصورة: " + error.message);
        }
      }
      
      db.collection('groups').where("creatorId", "==", currentUser.id).get()
        .then(snapshot => {
          if(snapshot.size >= 10) {
            alert("لقد أنشأت 10 مجموعات بالفعل ولا يمكنك إنشاء المزيد.");
            return;
          }
          db.collection('groups').add({
            name: groupName,
            image: groupImage || '',
            creatorId: currentUser.id,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          }).then(() => {
            alert("تم إنشاء المجموعة بنجاح");
            closeCreateGroupPopup();
          }).catch(err => console.error("Error creating group:", err));
        })
        .catch(err => console.error("Error checking group count:", err));
    }
    
    // تهيئة بعض الإعدادات عند تحميل الصفحة
    document.addEventListener("DOMContentLoaded", function() {
      // طلب إذن الإشعارات عند أول استخدام
      if (!("Notification" in window)) {
        console.log("هذا المتصفح لا يدعم الإشعارات");
      } else if (Notification.permission !== "granted" && Notification.permission !== "denied") {
        // سنطلب الإذن من خلال نافذتنا المخصصة لاحقًا
      }
      
      // تهيئة مستمع الإشعارات للرسائل الخاصة
      if (currentUser) {
        setupPrivateMessageNotifications();
      }
      
      // أحداث تحميل الصور للمجموعات
      document.getElementById('upload-group-image-btn').addEventListener('click', function() {
        document.getElementById('group-image-file').click();
      });
      
      document.getElementById('group-image-file').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
          selectedGroupImageFile = file;
          const reader = new FileReader();
          reader.onload = function(e) {
            const preview = document.getElementById('group-image-preview');
            preview.src = e.target.result;
            preview.style.display = 'block';
          };
          reader.readAsDataURL(file);
        }
      });
      
      document.getElementById('edit-upload-group-image-btn').addEventListener('click', function() {
        document.getElementById('edit-group-image-file').click();
      });
      
      document.getElementById('edit-group-image-file').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
          selectedEditGroupImageFile = file;
          const reader = new FileReader();
          reader.onload = function(e) {
            const preview = document.getElementById('edit-group-image-preview');
            preview.src = e.target.result;
            preview.style.display = 'block';
          };
          reader.readAsDataURL(file);
        }
      });
      
      // تهيئة أحداث إعدادات المحادثة
      document.getElementById('chat-settings-btn').addEventListener('click', function() {
        document.getElementById('settings-popup').style.display = 'none';
        document.getElementById('chat-settings-popup').style.display = 'block';
        updateFontPreview(); // تحديث معاينة الخط عند فتح النافذة
        updateExamples(); // تحديث الأمثلة
      });
      
      // أحداث شريط تمرير حجم الخط
      const fontSizeSlider = document.getElementById('font-size-slider');
      const fontSizeValue = document.getElementById('font-size-value');
      
      fontSizeSlider.addEventListener('input', function() {
        fontSizeValue.textContent = this.value;
        updateExamples();
      });
      
      // أحداث شريط تمرير زاوية الرسالة
      const messageRadiusSlider = document.getElementById('message-radius-slider');
      const messageRadiusValue = document.getElementById('message-radius-value');
      
      messageRadiusSlider.addEventListener('input', function() {
        messageRadiusValue.textContent = this.value;
        updateExamples();
      });
      
      // تحديث الأمثلة في إعدادات المحادثة
      function updateExamples() {
        const fontSize = document.getElementById('font-size-slider').value;
        const messageRadius = document.getElementById('message-radius-slider').value;
        
        // تحديث مثال حجم الخط
        document.getElementById('font-size-example').style.fontSize = fontSize + 'px';
        
        // تحديث مثال زاوية الرسالة
        document.getElementById('message-radius-example').style.borderRadius = messageRadius + 'px';
      }
      
      // اختيار لون الاسم
      const usernameColorPicker = document.getElementById('username-color-picker');
      const usernameColorPreview = document.getElementById('username-color-preview');
      
      usernameColorPicker.addEventListener('input', function() {
        usernameColorPreview.style.backgroundColor = this.value;
      });
      
      // تهيئة أحداث إعدادات الخصوصية والأمان
      document.getElementById('privacy-settings-btn').addEventListener('click', function() {
        document.getElementById('settings-popup').style.display = 'none';
        document.getElementById('privacy-settings-popup').style.display = 'block';
        loadPrivacySettings();
      });
      
      // تهيئة أحداث إعدادات الإشعارات
      document.getElementById('notification-settings-btn').addEventListener('click', function() {
        document.getElementById('settings-popup').style.display = 'none';
        document.getElementById('notification-settings-popup').style.display = 'block';
        loadNotificationSettings();
      });
      
      // أحداث زر تطبيق الخلفية
      document.getElementById('apply-bg-btn').addEventListener('click', applyBackground);
      
      // أحداث زر إزالة الخلفية
      document.getElementById('remove-bg-btn').addEventListener('click', removeBackground);
    });
    
    function toggleRoomsPopup() {
      const popup = document.getElementById('rooms-popup');
      popup.style.display = (popup.style.display === 'block') ? 'none' : 'block';
      if(popup.style.display === 'block'){
        populateRoomsPopup();
      }
    }
    
    // --- ميزة تحديث عدد الرسائل غير المقروءة ---
    db.collectionGroup('messages')
      .where('read', '==', false)
      .where('chatParticipants', 'array-contains', currentUser ? currentUser.id : '')
      .where('senderId', '!=', currentUser ? currentUser.id : '')
      .onSnapshot(snapshot => {
         const badge = document.getElementById('private-badge');
         const count = snapshot.size;
         if(count > 0) {
           badge.style.display = 'inline-block';
           badge.textContent = count;
         } else {
           badge.style.display = 'none';
         }
      });
    let unsubscribeUnread;
    function updateUnreadListener() {
      if(unsubscribeUnread) unsubscribeUnread();
      if(!currentUser) return;
      unsubscribeUnread = db.collectionGroup('messages')
        .where('read', '==', false)
        .where('chatParticipants', 'array-contains', currentUser.id)
        .where('senderId', '!=', currentUser.id)
        .onSnapshot(snapshot => {
           const badge = document.getElementById('private-badge');
           const count = snapshot.size;
           if(count > 0) {
             badge.style.display = 'inline-block';
             badge.textContent = count;
           } else {
             badge.style.display = 'none';
           }
        });
    }
    
    auth.onAuthStateChanged(user => {
      if(user) {
        updateUnreadListener();
      }
    });
    
    // --- نهاية ميزة تحديث العداد ---
    
    // الرسائل الخاصة - القائمة
    function togglePrivateMessagesPopup() {
      const popup = document.getElementById('private-messages-popup');
      if(popup.style.display === 'block') {
        popup.style.display = 'none';
      } else {
        popup.style.display = 'block';
        loadPrivateMessages();
      }
    }
    
    function switchPrivateTab(tab) {
      document.querySelectorAll('.invites-tab-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      document.getElementById('private-chats-list').style.display = 'none';
      document.getElementById('private-invites-list').style.display = 'none';
      
      if(tab === 'chats') {
        document.querySelector('.invites-tab-btn:first-child').classList.add('active');
        document.getElementById('private-chats-list').style.display = 'block';
        loadPrivateChats();
      } else {
        document.querySelector('.invites-tab-btn:last-child').classList.add('active');
        document.getElementById('private-invites-list').style.display = 'block';
        loadPrivateInvites();
      }
    }
    
    function loadPrivateMessages() {
      loadPrivateChats();
      loadPrivateInvites();
    }
    
    function loadPrivateChats() {
      const listContainer = document.getElementById('private-chats-list');
      listContainer.innerHTML = "";
      db.collection('private_chats').where("participants", "array-contains", currentUser.id)
        .get()
        .then(snapshot => {
          if(snapshot.empty) {
            listContainer.innerHTML = "<p>لا توجد رسائل خاصة.</p>";
            return;
          }
          snapshot.forEach(doc => {
            const data = doc.data();
            let otherUserId = data.participants.filter(id => id !== currentUser.id)[0];
            db.collection('users').doc(otherUserId).get().then(userDoc => {
              if (userDoc.exists) {
                let userData = userDoc.data();
                
                // جلب آخر رسالة في هذه المحادثة
                db.collection('private_chats').doc(doc.id).collection('messages')
                  .orderBy('timestamp', 'desc')
                  .limit(1)
                  .get()
                  .then(messagesSnapshot => {
                    let lastMessage = "لا توجد رسائل";
                    if (!messagesSnapshot.empty) {
                      const lastMsgData = messagesSnapshot.docs[0].data();
                      // إذا كانت الرسالة تحتوي على صورة، نعرض "صورة"
                      if (lastMsgData.isImage) {
                        lastMessage = "صورة";
                      } else {
                        // نأخذ جزء من النص إذا كان طويلاً
                        lastMessage = lastMsgData.text.substring(0, 30) + (lastMsgData.text.length > 30 ? "..." : "");
                      }
                    }
                    
                    const item = document.createElement('div');
                    item.className = 'private-message-item';
                    item.innerHTML = `
                      <img src="${userData.photoURL || defaultProfileImage}" class="pm-user-avatar" alt="${userData.name}">
                      <div class="pm-user-info">
                        <div class="pm-user-name">${userData.name}</div>
                        <div class="pm-last-message">${lastMessage}</div>
                      </div>
                    `;
                    item.onclick = function() {
                      openPrivateChat(otherUserId);
                      document.getElementById('private-messages-popup').style.display = 'none';
                    };
                    listContainer.appendChild(item);
                  });
              }
            });
          });
        })
        .catch(err => console.error("Error loading private messages:", err));
    }
    
    function loadPrivateInvites() {
      const listContainer = document.getElementById('private-invites-list');
      listContainer.innerHTML = "";
      db.collection('invitations')
        .where('toUserId', '==', currentUser.id)
        .where('status', '==', 'pending')
        .get()
        .then(snapshot => {
          if(snapshot.empty) {
            listContainer.innerHTML = "<p>لا توجد دعوات واردة.</p>";
            return;
          }
          snapshot.forEach(doc => {
            const data = doc.data();
            db.collection('users').doc(data.fromUserId).get().then(userDoc => {
              if (userDoc.exists) {
                let userData = userDoc.data();
                const inviteItem = document.createElement('div');
                inviteItem.className = 'invite-item';
                inviteItem.innerHTML = `
                  <div>
                    <strong>${userData.name}</strong>
                    <p>يريد مراسلتك</p>
                  </div>
                  <div class="invite-actions">
                    <button class="invite-action-btn invite-accept" data-id="${doc.id}">قبول</button>
                    <button class="invite-action-btn invite-reject" data-id="${doc.id}">رفض</button>
                  </div>
                `;
                listContainer.appendChild(inviteItem);
                
                // إضافة أحداث للأزرار
                inviteItem.querySelector('.invite-accept').addEventListener('click', function(e) {
                  e.stopPropagation();
                  acceptInvitation(this.dataset.id);
                });
                
                inviteItem.querySelector('.invite-reject').addEventListener('click', function(e) {
                  e.stopPropagation();
                  rejectInvitation(this.dataset.id);
                });
              }
            });
          });
        })
        .catch(err => console.error("Error loading private invites:", err));
    }
    
    function acceptInvitation(inviteId) {
      db.collection('invitations').doc(inviteId).update({
        status: 'accepted'
      }).then(() => {
        loadPrivateInvites();
        showNotification("تم قبول الدعوة بنجاح");
      }).catch(err => {
        console.error("Error accepting invitation:", err);
        alert("حدث خطأ أثناء قبول الدعوة");
      });
    }
    
    function rejectInvitation(inviteId) {
      db.collection('invitations').doc(inviteId).update({
        status: 'rejected'
      }).then(() => {
        loadPrivateInvites();
      }).catch(err => {
        console.error("Error rejecting invitation:", err);
        alert("حدث خطأ أثناء رفض الدعوة");
      });
    }
    
    // الرسائل الخاصة - النافذة المدمجة
    function openPrivateChat(userId) {
      closeProfileModal();
      currentPrivateChatUser = userId;
      db.collection('users').doc(userId).get().then(doc => {
        if(doc.exists) {
          let userData = doc.data();
          // تحديث العنوان ليشمل الصورة والاسم
          document.getElementById('private-chat-title').textContent = userData.name;
          document.getElementById('private-chat-avatar').src = userData.photoURL || defaultProfileImage;
          privateChatId = [currentUser.id, userId].sort().join("_");
          loadPrivateChatMessages();
          document.getElementById('private-chat-popup').style.display = 'block';
          updateChatUserStatus(userId);
          markPrivateChatMessagesAsRead();
          
          // إضافة مستمع لحالة الكتابة للمستخدم الآخر
          setupTypingIndicator();
          
          // إضافة أحداث الكتابة لحقل الإدخال
          setupTypingEvents();
        } else {
          alert("المستخدم غير موجود");
        }
      }).catch(err => console.error("Error fetching private chat user:", err));
    }
    
    function loadPrivateChatMessages() {
      const chatArea = document.getElementById('private-chat-area');
      db.collection('private_chats').doc(privateChatId).collection('messages')
         .orderBy('timestamp')
         .onSnapshot(snapshot => {
           chatArea.innerHTML = "";
           // متغير لتخزين آخر رسالة للمستخدم الحالي
           let lastUserMessage = null;
           
           // تحديد آخر رسالة للمستخدم الحالي
           snapshot.forEach(doc => {
             const msg = doc.data();
             if (msg.senderId === currentUser.id) {
               if (!lastUserMessage || (msg.timestamp && lastUserMessage.data.timestamp && 
                   msg.timestamp.toMillis() > lastUserMessage.data.timestamp.toMillis())) {
                 lastUserMessage = { id: doc.id, data: msg };
               }
             }
           });
           
           // عرض الرسائل
           snapshot.forEach(doc => {
             const msg = doc.data();
             let timeString = "";
             if(msg.timestamp) {
               timeString = new Date(msg.timestamp.toDate()).toLocaleTimeString();
             }
             const messageDiv = document.createElement('div');
             messageDiv.className = 'message ' + (msg.senderId === currentUser.id ? 'sent' : 'received');
    
             const profileImgDiv = document.createElement('div');
             profileImgDiv.className = 'message-profile';
             let senderPhoto = msg.senderPhoto || defaultProfileImage;
             profileImgDiv.style.backgroundImage = 'url(' + senderPhoto + ')';
             profileImgDiv.addEventListener('click', function(e) {
               e.stopPropagation();
               showProfileModal({ id: msg.senderId, name: msg.senderName, photoURL: senderPhoto });
             });
             messageDiv.appendChild(profileImgDiv);
    
             const bubbleDiv = document.createElement('div');
             bubbleDiv.className = 'message-bubble';
             
             // التحقق مما إذا كانت الرسالة تحتوي على صورة
             if (msg.isImage) {
               bubbleDiv.innerHTML = `<strong style="color: var(--username-color);">${msg.senderName}:</strong><br>`;
               const imgElement = document.createElement('img');
               imgElement.src = msg.imageUrl;
               imgElement.className = 'thumbnail-image';
               imgElement.onclick = () => openImageModal(msg.imageUrl, msg.text || '');
               bubbleDiv.appendChild(imgElement);
               
               // إذا كان هناك نص، عرضه أسفل الصورة
               if (msg.text) {
                 const captionDiv = document.createElement('div');
                 captionDiv.className = 'image-caption';
                 captionDiv.textContent = msg.text;
                 bubbleDiv.appendChild(captionDiv);
               }
               
               bubbleDiv.innerHTML += `<div class="message-time">${timeString}</div>`;
             } else {
               // تحويل الروابط في النص إلى روابط قابلة للنقر
               const linkedText = linkifyText(msg.text);
               bubbleDiv.innerHTML = `<strong style="color: var(--username-color);">${msg.senderName}:</strong> ${linkedText} <div class="message-time">${timeString}</div>`;
             }
             
             // إضافة نص "تمت مشاهدة الآن" إذا كانت هذه الرسالة هي الأخيرة للمستخدم الحالي وتمت مشاهدتها
             if (msg.senderId === currentUser.id && lastUserMessage && 
                 doc.id === lastUserMessage.id && msg.read) {
               const seenText = document.createElement('div');
               seenText.className = 'seen-now-text';
               
               // حساب الوقت منذ المشاهدة
               if (msg.readAt) {
                 const readDate = msg.readAt.toDate();
                 const now = new Date();
                 const diffSeconds = Math.floor((now - readDate) / 1000);
                 
                 if (diffSeconds < 60) {
                   seenText.textContent = 'تمت المشاهدة الآن';
                 } else if (diffSeconds < 3600) {
                   const minutes = Math.floor(diffSeconds / 60);
                   seenText.textContent = `تمت المشاهدة قبل ${minutes} دقيقة`;
                 } else if (diffSeconds < 86400) {
                   const hours = Math.floor(diffSeconds / 3600);
                   seenText.textContent = `تمت المشاهدة قبل ${hours} ساعة`;
                 } else {
                   const days = Math.floor(diffSeconds / 86400);
                   seenText.textContent = `تمت المشاهدة قبل ${days} يوم`;
                 }
               } else {
                 seenText.textContent = 'تمت المشاهدة';
               }
               
               bubbleDiv.appendChild(seenText);
             }
             
             messageDiv.appendChild(bubbleDiv);
    
             if(msg.senderId === currentUser.id) {
               const optionsIcon = document.createElement('div');
               optionsIcon.className = 'options-icon';
               optionsIcon.innerHTML = '<i class="fa-solid fa-ellipsis-h"></i>';
               bubbleDiv.appendChild(optionsIcon);
               bubbleDiv.addEventListener('click', function(e) {
                 e.stopPropagation();
                 let panel = bubbleDiv.querySelector('.options-panel');
                 if(panel) {
                   panel.style.display = (panel.style.display === 'block') ? 'none' : 'block';
                 }
               });
    
               const optionsPanel = document.createElement('div');
               optionsPanel.className = 'options-panel';
               const editBtn = document.createElement('button');
               editBtn.textContent = 'تعديل';
               editBtn.onclick = function(e) {
                 e.stopPropagation();
                 openPrivateEditPopup(doc.id, msg.text);
                 optionsPanel.style.display = 'none';
               };
               const deleteBtn = document.createElement('button');
               deleteBtn.textContent = 'حذف';
               deleteBtn.onclick = function(e) {
                 e.stopPropagation();
                 deletePrivateMessage(doc.id);
                 optionsPanel.style.display = 'none';
               };
               optionsPanel.appendChild(editBtn);
               optionsPanel.appendChild(deleteBtn);
               bubbleDiv.appendChild(optionsPanel);
             }
             
             // إضافة زر الرد للرسالة الخاصة
             const replyIcon = document.createElement('div');
             replyIcon.className = 'reply-icon';
             replyIcon.innerHTML = '<i class="fa-solid fa-reply"></i>';
             replyIcon.addEventListener('click', function(e) {
               e.stopPropagation();
               replyToMessage(msg, true);
             });
             bubbleDiv.appendChild(replyIcon);
             
             // إضافة تفاعل السحب لليمين للرد
             const hammer = new Hammer(messageDiv);
             hammer.on('swiperight', function() {
               // إضافة تأثير السحب
               messageDiv.classList.add('swiping');
               setTimeout(() => {
                 messageDiv.classList.remove('swiping');
               }, 300);
               
               replyToMessage(msg, true);
             });

             chatArea.appendChild(messageDiv);
           });
           chatArea.scrollTop = chatArea.scrollHeight;
         }, err => console.error("Error loading private chat messages:", err));
    }
    
    function sendPrivateMessage() {
      const input = document.getElementById('private-message-input');
      let text = input.value.trim();
      if(!text) return;
      
      // إضافة الرد إذا كان هناك رد على رسالة
      if (replyingToMessage) {
        const replyText = `رد على ${replyingToMessage.senderName}: ${replyingToMessage.text.substring(0, 30)}${replyingToMessage.text.length > 30 ? '...' : ''}\n${text}`;
        text = replyText;
      }
      
      // التحقق من إعدادات الخصوصية للمستخدم
      db.collection('users').doc(currentPrivateChatUser).get().then(userDoc => {
        if (userDoc.exists) {
          const userData = userDoc.data();
          if (userData.privacySettings && userData.privacySettings.messaging === 'invite') {
            // التحقق من وجود دعوة مقبولة
            db.collection('invitations')
              .where('fromUserId', '==', currentUser.id)
              .where('toUserId', '==', currentPrivateChatUser)
              .where('status', '==', 'accepted')
              .get().then(snapshot => {
                if (snapshot.empty) {
                  // لا توجد دعوة مقبولة، عرض نافذة الدعوة
                  showInvitePopup(currentPrivateChatUser, userData.name);
                  return;
                }
                // إذا كانت هناك دعوة مقبولة، نرسل الرسالة
                sendPrivateMessageContent(text);
              });
          } else {
            // إذا كانت الإعدادات تسمح بالمراسلة للجميع، نرسل الرسالة مباشرة
            sendPrivateMessageContent(text);
          }
        } else {
          // إذا لم يتم العثور على المستخدم، نرسل الرسالة مباشرة
          sendPrivateMessageContent(text);
        }
      });
    }
    
    function sendPrivateMessageContent(text) {
      const messageData = {
        text: text,
        senderId: currentUser.id,
        senderName: currentUser.name,
        senderPhoto: currentUser.photoURL || defaultProfileImage,
        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
        read: false,
        chatParticipants: [currentUser.id, currentPrivateChatUser]
      };
      const urls = extractURLs(text);
      if(urls && urls.length > 0){
        getLinkPreview(urls[0]).then(previewData => {
          if(previewData){
            messageData.linkPreview = previewData;
          }
          db.collection('private_chats').doc(privateChatId).set({
            participants: [currentUser.id, currentPrivateChatUser]
          }, { merge: true })
          .then(() => {
            return db.collection('private_chats').doc(privateChatId).collection('messages').add(messageData);
          })
          .then(() => {
            document.getElementById('private-message-input').value = "";
            cancelPrivateReply(); // إلغاء الرد بعد الإرسال
          })
          .catch(err => console.error("Error sending private message:", err));
        });
      } else {
        db.collection('private_chats').doc(privateChatId).set({
          participants: [currentUser.id, currentPrivateChatUser]
        }, { merge: true })
        .then(() => {
          return db.collection('private_chats').doc(privateChatId).collection('messages').add(messageData);
        })
        .then(() => {
          document.getElementById('private-message-input').value = "";
          cancelPrivateReply(); // إلغاء الرد بعد الإرسال
        })
        .catch(err => console.error("Error sending private message:", err));
      }
    }
    
    function closePrivateChatPopup() {
      document.getElementById('private-chat-popup').style.display = 'none';
      currentPrivateChatUser = null;
      privateChatId = null;
    }
    
    function markPrivateChatMessagesAsRead() {
      const batch = firebase.firestore().batch();
      const messagesRef = db.collection('private_chats').doc(privateChatId).collection('messages');
      
      messagesRef
        .where('senderId', '!=', currentUser.id)
        .where('read', '==', false)
        .get().then(snapshot => {
          snapshot.forEach(doc => {
            batch.update(doc.ref, {
              read: true,
              readAt: firebase.firestore.FieldValue.serverTimestamp()
            });
          });
          return batch.commit();
        });
    }
    
    // تعديل الرسائل الخاصة
    function openPrivateEditPopup(messageId, currentText) {
      editingPrivateMessageId = messageId;
      document.getElementById('edit-private-message-input').value = currentText;
      document.getElementById('edit-private-message-popup').style.display = 'block';
    }
    function closePrivateEditPopup() {
      editingPrivateMessageId = null;
      document.getElementById('edit-private-message-popup').style.display = 'none';
    }
    function updatePrivateMessage() {
      const newText = document.getElementById('edit-private-message-input').value.trim();
      if(!newText) {
        alert("الرجاء إدخال نص الرسالة");
        return;
      }
      if(editingPrivateMessageId) {
        db.collection('private_chats').doc(privateChatId).collection('messages').doc(editingPrivateMessageId).update({
          text: newText,
          edited: true,
          editTimestamp: firebase.firestore.FieldValue.serverTimestamp()
        }).then(() => {
          alert("تم تعديل الرسالة بنجاح");
          closePrivateEditPopup();
        }).catch(err => console.error("Error updating private message:", err));
      }
    }
    function deletePrivateMessage(messageId) {
      if(confirm("هل تريد حذف الرسالة؟")) {
        db.collection('private_chats').doc(privateChatId).collection('messages').doc(messageId).delete()
          .then(() => {
            alert("تم حذف الرسالة");
          })
          .catch(err => console.error("Error deleting private message:", err));
      }
    }
    
    // صفحة الملف الشخصي
    function showProfileModal(user) {
      const modalBody = document.getElementById('profile-modal-body');
      modalBody.innerHTML = "";
      if(user.id === currentUser.id) {
        modalBody.innerHTML = `
          <h2>ملفي الشخصي</h2>
          <img src="${currentUser.photoURL || defaultProfileImage}" style="width:120px;height:120px;border-radius:50%;object-fit:cover;margin:0 auto;display:block;">
          <p style="font-size:20px;font-weight:bold;margin-top:15px;">${currentUser.name}</p>
          <p style="font-size:16px;color:#555;">${currentUser.description || "لا يوجد وصف"}</p>
          ${ currentUser.username ? `<p style="font-size:16px;color:#555;">المعرف: @${currentUser.username}</p>` : '' }
          <button onclick="openProfileEdit()" style="margin-top:20px;">تعديل الملف الشخصي</button>
          <button onclick="closeProfileModal()" style="margin-top:10px;background:#dc3545;">إغلاق</button>
        `;
        getUserStatus(currentUser.id);
      } else {
        db.collection('users').doc(user.id).get().then(doc => {
          let data = doc.exists ? doc.data() : {
              name: user.name,
              description: "لا يوجد وصف",
              createdAt: "غير متاح",
              photoURL: user.photoURL || defaultProfileImage
            };
          modalBody.innerHTML = `
            <h2>${data.name}</h2>
            <img src="${data.photoURL || defaultProfileImage}" style="width:120px;height:120px;border-radius:50%;object-fit:cover;margin:0 auto;display:block;">
            <p style="font-size:16px;color:#555;">${data.description || "لا يوجد وصف"}</p>
            <p style="font-size:14px;color:#999;">تاريخ الإنشاء: ${data.createdAt ? new Date(data.createdAt).toLocaleDateString() : "غير متاح"}</p>
            <button onclick="openPrivateChat('${data.id}')" style="margin-top:20px;">رسالة خاصة</button>
            <button onclick="closeProfileModal()" style="margin-top:10px;background:#dc3545;">إغلاق</button>
          `;
          // عرض حالة المستخدم
          const statusElement = document.createElement('p');
          statusElement.id = 'user-status';
          statusElement.className = 'user-status-indicator';
          if (data.status === "online") {
            statusElement.innerText = "متصل الآن";
            statusElement.className = "user-status-indicator status-online";
          } else {
            const lastSeenText = formatLastSeen(data.lastSeen);
            statusElement.innerText = lastSeenText;
            statusElement.className = "user-status-indicator status-offline";
          }
          modalBody.appendChild(statusElement);
        });
      }
      document.getElementById('profile-modal').style.display = 'block';
    }
      
    function closeProfileModal() {
      document.getElementById('profile-modal').style.display = 'none';
    }
    
    // تحرير الملف الشخصي داخل النافذة
    function openProfileEdit() {
      const modalBody = document.getElementById('profile-modal-body');
      modalBody.innerHTML = `
        <h2>تعديل الملف الشخصي</h2>
        <img src="${currentUser.photoURL || defaultProfileImage}" id="edit-profile-pic" style="width:120px;height:120px;border-radius:50%;object-fit:cover;margin:0 auto;display:block;">
        <input type="file" id="edit-profile-photo-file" accept="image/*" style="display:none;">
        <button id="upload-profile-photo-btn" style="margin-top:10px;background:#4CAF50;color:white;border:none;padding:8px;border-radius:5px;">اختر صورة</button>
        <input type="text" id="edit-profile-name" value="${currentUser.name}" placeholder="أدخل اسمك" style="width:100%;padding:10px;margin-top:15px;">
        <textarea id="edit-profile-description" placeholder="أدخل وصف حسابك" style="width:100%;padding:10px;margin-top:10px;">${currentUser.description || ''}</textarea>
        <input type="text" id="edit-profile-username" value="${currentUser.username || ''}" placeholder="أدخل المعرف (username)" style="width:100%;padding:10px;margin-top:10px;">
        <button onclick="saveProfileEdit()" style="margin-top:15px;">حفظ التعديلات</button>
        <button onclick="showProfileModal(currentUser)" style="margin-top:10px;background:#dc3545;">إلغاء</button>
      `;

      // إضافة حدث لزر اختيار الصورة
      document.getElementById('upload-profile-photo-btn').addEventListener('click', function() {
        document.getElementById('edit-profile-photo-file').click();
      });

      // عند اختيار صورة، نعرض معاينة
      document.getElementById('edit-profile-photo-file').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function(e) {
            document.getElementById('edit-profile-pic').src = e.target.result;
          };
          reader.readAsDataURL(file);
        }
      });
    }
    
    // دالة لرفع الصورة إلى Backendless
    async function uploadImageToBackendless(file) {
      // عرض مؤشر التحميل
      document.getElementById('upload-indicator-container').style.display = 'flex';
      
      const formData = new FormData();
      formData.append('file', file);
      formData.append('fileName', file.name);
      
      try {
        const response = await fetch(`https://api.backendless.com/${BACKENDLESS_APP_ID}/${BACKENDLESS_API_KEY}/files/${file.name}`, {
          method: 'POST',
          body: formData
        });
        
        if (!response.ok) {
          throw new Error('فشل رفع الصورة');
        }
        
        const result = await response.json();
        return result.fileURL;
        
      } catch (error) {
        console.error('Error uploading image:', error);
        alert('حدث خطأ أثناء رفع الصورة: ' + error.message);
        return null;
      } finally {
        // إخفاء مؤشر التحميل
        document.getElementById('upload-indicator-container').style.display = 'none';
      }
    }
    
    async function saveProfileEdit() {
      const newName = document.getElementById('edit-profile-name').value.trim();
      const newDesc = document.getElementById('edit-profile-description').value.trim();
      const newUsername = document.getElementById('edit-profile-username').value.trim();
      const fileInput = document.getElementById('edit-profile-photo-file');
      let newPhoto = currentUser.photoURL; // نستخدم الصورة الحالية افتراضيًا

      if (newName === '') {
        alert("يرجى إدخال الاسم");
        return;
      }

      // إذا كان هناك ملف محدد، نرفعه إلى Backendless
      if (fileInput.files.length > 0) {
        const file = fileInput.files[0];
        const imageUrl = await uploadImageToBackendless(file);
        if (imageUrl) {
          newPhoto = imageUrl;
        } else {
          alert("فشل رفع الصورة. سيتم الاحتفاظ بالصورة الحالية.");
        }
      }

      db.collection('users').doc(currentUser.id).update({
        name: newName,
        description: newDesc,
        photoURL: newPhoto,
        username: newUsername
      }).then(() => {
        currentUser.name = newName;
        currentUser.description = newDesc;
        currentUser.photoURL = newPhoto;
        currentUser.username = newUsername;
        alert("تم حفظ التعديلات");
        showProfileModal(currentUser);
      }).catch(err => console.error("Error updating profile:", err));
    }
    
    // زر فتح نافذة تعديل الملف الشخصي من الشريط الجانبي
    function openProfilePopup() {
      openProfileEdit();
      document.getElementById('profile-modal').style.display = 'block';
    }
    
    /* ==========================
       ميزة مشاركة الصور مع النصوص
       ========================== */
    
    // تهيئة زر إرفاق الصورة
    document.getElementById('attach-image-btn').addEventListener('click', function() {
      document.getElementById('image-upload').click();
    });
    
    document.getElementById('image-upload').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (file) {
        currentImageToSend = file;
        isPrivateImage = false;
        document.getElementById('image-caption-input').value = "";
        document.getElementById('image-caption-popup').style.display = 'block';
      }
    });
    
    // تهيئة زر إرفاق الصورة للدردشة الخاصة
    document.getElementById('private-attach-image-btn').addEventListener('click', function() {
      document.getElementById('private-image-upload').click();
    });
    
    document.getElementById('private-image-upload').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (file) {
        currentImageToSend = file;
        isPrivateImage = true;
        document.getElementById('image-caption-input').value = "";
        document.getElementById('image-caption-popup').style.display = 'block';
      }
    });
    
    // إرسال صورة مع نص إلى المجموعة
    async function sendGroupImageMessage(imageUrl, caption) {
      const messageData = {
        isImage: true,
        imageUrl: imageUrl,
        text: caption || '',
        senderId: currentUser.id,
        senderName: currentUser.name,
        senderPhoto: currentUser.photoURL || defaultProfileImage,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      };
      
      await db.collection('groups').doc(currentGroup).collection('messages').add(messageData);
    }
    
    // إرسال صورة مع نص إلى الدردشة الخاصة
    async function sendPrivateImageMessage(imageUrl, caption) {
      if (!privateChatId) return;
      
      const messageData = {
        isImage: true,
        imageUrl: imageUrl,
        text: caption || '',
        senderId: currentUser.id,
        senderName: currentUser.name,
        senderPhoto: currentUser.photoURL || defaultProfileImage,
        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
        read: false,
        chatParticipants: [currentUser.id, currentPrivateChatUser]
      };
      
      await db.collection('private_chats').doc(privateChatId).set({
        participants: [currentUser.id, currentPrivateChatUser]
      }, { merge: true });
      
      await db.collection('private_chats').doc(privateChatId).collection('messages').add(messageData);
    }
    
    // تحسينات لعرض الصور الكامل
    let currentZoom = 1;
    let isDragging = false;
    let startX, startY, scrollLeft, scrollTop;

    function openImageModal(imageUrl, caption = '') {
      const modal = document.getElementById('image-modal');
      const fullSizeImage = document.getElementById('full-size-image');
      const imageCaption = document.getElementById('full-image-caption');
      
      fullSizeImage.src = imageUrl;
      fullSizeImage.dataset.originalSrc = imageUrl; // حفظ الصورة الأصلية للتحميل
      
      if (caption) {
        imageCaption.textContent = caption;
        imageCaption.style.display = 'block';
      } else {
        imageCaption.style.display = 'none';
      }
      
      modal.style.display = 'block';
      
      // إعادة تعيين التكبير
      currentZoom = 1;
      fullSizeImage.style.transform = `scale(${currentZoom})`;
      fullSizeImage.style.cursor = 'grab';
      
      // إضافة تأثير التحميل
      fullSizeImage.style.opacity = '0';
      setTimeout(() => {
        fullSizeImage.style.opacity = '1';
        fullSizeImage.style.transition = 'opacity 0.3s ease';
      }, 100);
      
      // منع التمرير عند فتح الصورة
      document.body.style.overflow = 'hidden';
    }

    // إغلاق نافذة الصورة
    document.getElementById('close-image-modal').addEventListener('click', function() {
      document.getElementById('image-modal').style.display = 'none';
      document.body.style.overflow = 'auto'; // استعادة التمرير
    });

    // إغلاق نافذة الصورة بالنقر خارجها
    document.getElementById('image-modal').addEventListener('click', function(e) {
      if (e.target === this) {
        this.style.display = 'none';
        document.body.style.overflow = 'auto'; // استعادة التمرير
      }
    });

    // التحكم في التكبير
    document.getElementById('zoom-in-btn').addEventListener('click', function() {
      currentZoom += 0.2;
      document.getElementById('full-size-image').style.transform = `scale(${currentZoom})`;
      document.getElementById('full-size-image').style.cursor = 'grab';
    });

    document.getElementById('zoom-out-btn').addEventListener('click', function() {
      if (currentZoom > 0.3) {
        currentZoom -= 0.2;
        document.getElementById('full-size-image').style.transform = `scale(${currentZoom})`;
        document.getElementById('full-size-image').style.cursor = 'grab';
      }
    });

    document.getElementById('reset-zoom-btn').addEventListener('click', function() {
      currentZoom = 1;
      document.getElementById('full-size-image').style.transform = `scale(${currentZoom})`;
      document.getElementById('full-size-image').style.cursor = 'grab';
    });

    // تحميل الصورة
    document.getElementById('download-btn').addEventListener('click', function() {
      const imageUrl = document.getElementById('full-size-image').dataset.originalSrc;
      const a = document.createElement('a');
      a.href = imageUrl;
      a.download = 'image_' + new Date().getTime() + '.jpg';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    });

    // إضافة إمكانية السحب للصورة
    document.getElementById('full-size-image').addEventListener('mousedown', function(e) {
      if (currentZoom > 1) {
        isDragging = true;
        startX = e.pageX - this.offsetLeft;
        startY = e.pageY - this.offsetTop;
        scrollLeft = this.scrollLeft;
        scrollTop = this.scrollTop;
        this.style.cursor = 'grabbing';
      }
    });

    document.addEventListener('mousemove', function(e) {
      if (!isDragging) return;
      
      const image = document.getElementById('full-size-image');
      const x = e.pageX - image.offsetLeft;
      const y = e.pageY - image.offsetTop;
      const walkX = (x - startX) * 2;
      const walkY = (y - startY) * 2;
      
      image.scrollLeft = scrollLeft - walkX;
      image.scrollTop = scrollTop - walkY;
    });

    document.addEventListener('mouseup', function() {
      isDragging = false;
      document.getElementById('full-size-image').style.cursor = 'grab';
    });

    // لمنع الإيماءات الافتراضية على الهاتف
    document.getElementById('full-size-image').addEventListener('touchstart', function(e) {
      if (e.touches.length > 1) {
        e.preventDefault(); // منع التكبير الافتراضي
      }
    }, { passive: false });

    // إضافة إمكانية التكبير باللمس
    document.getElementById('full-size-image').addEventListener('touchmove', function(e) {
      if (e.touches.length === 2) {
        e.preventDefault(); // منع التمرير الافتراضي
        const touch1 = e.touches[0];
        const touch2 = e.touches[1];
        const distance = Math.hypot(
          touch2.pageX - touch1.pageX,
          touch2.pageY - touch1.pageY
        );
        
        if (!this.dataset.lastDistance) {
          this.dataset.lastDistance = distance;
          return;
        }
        
        const scaleFactor = distance / this.dataset.lastDistance;
        currentZoom *= scaleFactor;
        currentZoom = Math.max(0.3, Math.min(currentZoom, 5)); // تحديد الحدود
        
        this.style.transform = `scale(${currentZoom})`;
        this.dataset.lastDistance = distance;
      }
    });

    document.getElementById('full-size-image').addEventListener('touchend', function() {
      delete this.dataset.lastDistance;
    });

    // إضافة حدث الضغط على الصورة المصغرة في الرسائل
    document.addEventListener('click', function(e) {
      if (e.target.classList.contains('thumbnail-image')) {
        const imageUrl = e.target.src;
        const caption = e.target.nextElementSibling?.textContent || '';
        openImageModal(imageUrl, caption);
      }
    });

    // إغلاق نافذة إضافة نص للصورة
    function closeImageCaptionPopup() {
      document.getElementById('image-caption-popup').style.display = 'none';
      currentImageToSend = null;
    }
    
    // إرسال الصورة مع النص
    async function sendImageWithCaption() {
      if (!currentImageToSend) return;
      
      const caption = document.getElementById('image-caption-input').value.trim();
      const imageUrl = await uploadImageToBackendless(currentImageToSend);
      
      if (imageUrl) {
        if (isPrivateImage) {
          await sendPrivateImageMessage(imageUrl, caption);
        } else {
          await sendGroupImageMessage(imageUrl, caption);
        }
        closeImageCaptionPopup();
      }
    }
    
    /* ==========================
       إعدادات المحادثة الجديدة
       ========================== */
    
    // تحميل إعدادات المحادثة من localStorage
    function loadChatSettings() {
      const fontSize = localStorage.getItem('chatFontSize') || '16';
      const messageRadius = localStorage.getItem('chatMessageRadius') || '10';
      const usernameColor = localStorage.getItem('chatUsernameColor') || '#7289da';
      const fontFamily = localStorage.getItem('chatFontFamily') || 'Tajawal, sans-serif';
      
      // تطبيق الإعدادات
      document.documentElement.style.setProperty('--font-size', `${fontSize}px`);
      document.documentElement.style.setProperty('--message-border-radius', `${messageRadius}px`);
      document.documentElement.style.setProperty('--username-color', usernameColor);
      document.body.style.fontFamily = fontFamily;
      
      // تحديث واجهة إعدادات المحادثة
      const fontSizeSlider = document.getElementById('font-size-slider');
      const fontSizeValue = document.getElementById('font-size-value');
      const messageRadiusSlider = document.getElementById('message-radius-slider');
      const messageRadiusValue = document.getElementById('message-radius-value');
      const usernameColorPicker = document.getElementById('username-color-picker');
      const usernameColorPreview = document.getElementById('username-color-preview');
      const fontFamilySelect = document.getElementById('font-family-select');
      
      fontSizeSlider.value = fontSize;
      fontSizeValue.textContent = fontSize;
      messageRadiusSlider.value = messageRadius;
      messageRadiusValue.textContent = messageRadius;
      usernameColorPicker.value = usernameColor;
      usernameColorPreview.style.backgroundColor = usernameColor;
      
      // اختيار الخط الصحيح في القائمة المنسدلة
      fontFamilySelect.value = fontFamily;
    }
    
    // تحديث معاينة الخط
    function updateFontPreview() {
      const fontFamilySelect = document.getElementById('font-family-select');
      const fontPreview = document.getElementById('font-preview');
      const selectedFont = fontFamilySelect.value;
      fontPreview.style.fontFamily = selectedFont;
    }
    
    // حفظ إعدادات المحادثة في localStorage
    function saveChatSettings() {
      const fontSize = document.getElementById('font-size-slider').value;
      const messageRadius = document.getElementById('message-radius-slider').value;
      const usernameColor = document.getElementById('username-color-picker').value;
      const fontFamily = document.getElementById('font-family-select').value;
      
      localStorage.setItem('chatFontSize', fontSize);
      localStorage.setItem('chatMessageRadius', messageRadius);
      localStorage.setItem('chatUsernameColor', usernameColor);
      localStorage.setItem('chatFontFamily', fontFamily);
      
      // تطبيق الإعدادات مباشرة
      document.documentElement.style.setProperty('--font-size', `${fontSize}px`);
      document.documentElement.style.setProperty('--message-border-radius', `${messageRadius}px`);
      document.documentElement.style.setProperty('--username-color', usernameColor);
      document.body.style.fontFamily = fontFamily;
      
      alert("تم حفظ إعدادات المحادثة بنجاح!");
      closeChatSettingsPopup();
    }
    
    // إغلاق نافذة إعدادات المحادثة
    function closeChatSettingsPopup() {
      document.getElementById('chat-settings-popup').style.display = 'none';
      document.getElementById('settings-popup').style.display = 'block';
    }
    
    /* ==========================
       إعدادات الخصوصية والأمان الجديدة
       ========================== */
    
    // تحميل إعدادات الخصوصية
    function loadPrivacySettings() {
      // إزالة التحديد من جميع الخيارات
      document.querySelectorAll('.privacy-option').forEach(option => {
        option.classList.remove('selected');
      });
      
      // تحديد الخيارات الحالية
      document.querySelectorAll('.privacy-option').forEach(option => {
        const type = option.parentElement.parentElement.querySelector('h4').dataset.type;
        if (option.dataset.value === privacySettings[type]) {
          option.classList.add('selected');
        }
      });
    }
    
    // اختيار خيار خصوصية
    function selectPrivacyOption(element, type) {
      // إزالة التحديد من جميع خيارات هذا النوع
      const container = element.parentElement;
      container.querySelectorAll('.privacy-option').forEach(option => {
        option.classList.remove('selected');
      });
      
      // تحديد الخيار المختار
      element.classList.add('selected');
      
      // تحديث الإعدادات المؤقتة
      privacySettings[type] = element.dataset.value;
    }
    
    // حفظ إعدادات الخصوصية
    function savePrivacySettings() {
      if (currentUser && currentUser.id) {
        db.collection('users').doc(currentUser.id).update({
          privacySettings: privacySettings
        }).then(() => {
          alert("تم حفظ إعدادات الخصوصية بنجاح!");
          closePrivacySettingsPopup();
        }).catch(error => {
          console.error("Error saving privacy settings:", error);
          alert("حدث خطأ أثناء حفظ الإعدادات.");
        });
      }
    }
    
    // إغلاق نافذة الخصوصية والأمان
    function closePrivacySettingsPopup() {
      document.getElementById('privacy-settings-popup').style.display = 'none';
      document.getElementById('settings-popup').style.display = 'block';
    }
    
    /* ==========================
       نظام الدعوة للمراسلة
       ========================== */
    
    function showInvitePopup(userId, userName) {
      const invitePopup = document.getElementById('invite-popup');
      const inviteMessage = document.getElementById('invite-message');
      
      inviteMessage.innerHTML = `
        المستخدم <strong>${userName}</strong> لا يقبل المراسلة إلا بعد دعوة.
        يمكنك إرسال دعوة إليه لمراسلتك.
      `;
      
      invitePopup.style.display = 'block';
      
      // إعداد أحداث الأزرار
      document.getElementById('send-invite-btn').onclick = function() {
        sendInvitation(userId);
        invitePopup.style.display = 'none';
      };
      
      document.getElementById('cancel-invite-btn').onclick = function() {
        invitePopup.style.display = 'none';
      };
    }
    
    function sendInvitation(toUserId) {
      db.collection('invitations').add({
        fromUserId: currentUser.id,
        toUserId: toUserId,
        status: 'pending',
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      }).then(() => {
        showNotification(`تم إرسال دعوة إلى المستخدم بنجاح.`);
        
        // إرسال إشعار للمستخدم المستهدف
        sendInviteNotification(toUserId);
      }).catch(err => {
        console.error("Error sending invitation:", err);
        alert('حدث خطأ أثناء إرسال الدعوة.');
      });
    }
    
    function sendInviteNotification(toUserId) {
      db.collection('users').doc(toUserId).get().then(userDoc => {
        if (userDoc.exists) {
          const userData = userDoc.data();
          const notification = {
            title: 'دعوة مراسلة جديدة',
            body: `يريد المستخدم ${currentUser.name} مراسلتك. هل توافق؟`,
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            read: false,
            type: 'invite',
            fromUserId: currentUser.id
          };
          
          db.collection('users').doc(toUserId).collection('notifications').add(notification);
        }
      });
    }
    
    function showNotification(message) {
      const notification = document.createElement('div');
      notification.className = 'invite-notification';
      notification.innerHTML = `
        <i class="fas fa-check-circle"></i>
        <span>${message}</span>
      `;
      document.body.appendChild(notification);
      
      // إزالة الإشعار بعد 3 ثواني
      setTimeout(() => {
        notification.remove();
      }, 3000);
    }
    
    /* ==========================
       إعدادات الإشعارات الجديدة
       ========================== */
    
    // تحميل إعدادات الإشعارات
    function loadNotificationSettings() {
      // تحديث حالة التبديل للإشعارات
      const toggle = document.getElementById('private-messages-notification-toggle');
      toggle.checked = notificationSettings.privateMessages;
      
      // ملء خيارات الأصوات
      const container = document.getElementById('sound-options-container');
      container.innerHTML = "";
      
      for (const key in notificationSounds) {
        const sound = notificationSounds[key];
        const option = document.createElement('div');
        option.className = 'sound-option';
        if (key === notificationSettings.notificationSound) {
          option.classList.add('selected');
        }
        option.dataset.sound = key;
        option.innerHTML = `
          <i class="fa-solid fa-music"></i>
          <span class="sound-name">${sound.name}</span>
          <span class="sound-check"><i class="fa-solid fa-check"></i></span>
        `;
        option.addEventListener('click', function() {
          document.querySelectorAll('.sound-option').forEach(opt => {
            opt.classList.remove('selected');
          });
          this.classList.add('selected');
          
          // تشغيل الصوت لتجريبه
          playNotificationSound(key);
        });
        container.appendChild(option);
      }
    }
    
    // حفظ إعدادات الإشعارات
    function saveNotificationSettings() {
      // الحصول على الإعدادات من النموذج
      const privateMessagesToggle = document.getElementById('private-messages-notification-toggle').checked;
      const selectedSound = document.querySelector('.sound-option.selected')?.dataset.sound || 'default';
      
      // تحديث الإعدادات
      notificationSettings.privateMessages = privateMessagesToggle;
      notificationSettings.notificationSound = selectedSound;
      
      // حفظ الإعدادات في قاعدة البيانات
      if (currentUser && currentUser.id) {
        db.collection('users').doc(currentUser.id).update({
          notificationSettings: notificationSettings
        }).then(() => {
          alert("تم حفظ إعدادات الإشعارات بنجاح!");
          closeNotificationSettingsPopup();
        }).catch(error => {
          console.error("Error saving notification settings:", error);
          alert("حدث خطأ أثناء حفظ الإعدادات.");
        });
      }
    }
    
    // إغلاق نافذة إعدادات الإشعارات
    function closeNotificationSettingsPopup() {
      document.getElementById('notification-settings-popup').style.display = 'none';
      document.getElementById('settings-popup').style.display = 'block';
    }
    
    // تشغيل نغمة الإشعار
    function playNotificationSound(soundKey) {
      if (notificationSoundPlayer) {
        notificationSoundPlayer.stop();
      }
      
      const sound = notificationSounds[soundKey];
      if (sound && sound.url) {
        notificationSoundPlayer = new Howl({
          src: [sound.url],
          html5: true
        });
        notificationSoundPlayer.play();
      } else {
        console.error('Sound not found for key:', soundKey);
      }
    }
    
    /* ==========================
       نظام إذن الإشعارات الجديد
       ========================== */
    
    // فحص إذن الإشعارات
    function checkNotificationPermission() {
      // إذا لم يتم دعم الإشعارات في المتصفح
      if (!('Notification' in window)) {
        console.log('هذا المتصفح لا يدعم الإشعارات');
        return;
      }
      
      // إذا لم يتم طلب الإذن بعد ولم يتم رفضه مسبقًا
      if (Notification.permission === 'default') {
        // عرض نافذة طلب الإذن المخصصة
        showPermissionPopup();
      }
    }
    
    // عرض نافذة طلب إذن الإشعارات
    function showPermissionPopup() {
      const popup = document.getElementById('permission-popup');
      popup.style.display = 'block';
    }
    
    // إغلاق نافذة طلب الإذن
    function closePermissionPopup() {
      document.getElementById('permission-popup').style.display = 'none';
    }
    
    // طلب إذن الإشعارات من المستخدم
    function requestNotificationPermission() {
      Notification.requestPermission().then(permission => {
        closePermissionPopup();
        if (permission === 'granted') {
          console.log('تم منح إذن الإشعارات');
          setupPrivateMessageNotifications();
        } else {
          console.log('تم رفض إذن الإشعارات');
        }
      });
    }
    
    // إرسال إشعار عند استلام رسالة خاصة
    function setupPrivateMessageNotifications() {
      if (!currentUser || !notificationSettings.privateMessages) return;
      
      // إذا لم يتم منح إذن الإشعارات، لا تفعل شيئًا
      if (Notification.permission !== 'granted') return;
      
      // الاستماع إلى الرسائل الجديدة في الدردشات الخاصة
      db.collectionGroup('messages')
        .where('chatParticipants', 'array-contains', currentUser.id)
        .where('senderId', '!=', currentUser.id)
        .where('read', '==', false)
        .onSnapshot(snapshot => {
          snapshot.docChanges().forEach(change => {
            if (change.type === 'added') {
              const msg = change.doc.data();
              
              // التحقق من أن الرسالة جديدة وليست قديمة
              const now = new Date();
              const msgTime = msg.timestamp.toDate();
              const diffSeconds = Math.floor((now - msgTime) / 1000);
              
              if (diffSeconds < 10) { // رسالة جديدة خلال 10 ثواني
                // الحصول على بيانات المرسل
                db.collection('users').doc(msg.senderId).get().then(userDoc => {
                  if (userDoc.exists) {
                    const sender = userDoc.data();
                    
                    // إرسال الإشعار
                    sendNotification(sender.name, msg.text);
                    
                    // تشغيل نغمة الإشعار
                    if (notificationSettings.notificationSound) {
                      playNotificationSound(notificationSettings.notificationSound);
                    }
                  }
                });
              }
            }
          });
        });
    }
    
    // إرسال الإشعار إلى المستخدم
    function sendNotification(title, body) {
      // إذا لم يتم منح الإذن، لا ترسل الإشعار
      if (Notification.permission !== 'granted') return;
      
      const options = {
        body: body,
        icon: currentUser.photoURL || defaultProfileImage
      };
      
      new Notification(title, options);
    }
    
    /* ==========================
       ميزة الرد على الرسائل
       ========================== */
    function replyToMessage(message, isPrivate) {
      // حفظ الرسالة التي نرد عليها
      replyingToMessage = message;
      replyingInPrivate = isPrivate;
      
      // إنشاء نص الرد
      const replyText = `رد على ${message.senderName}: ${message.text.substring(0, 30)}${message.text.length > 30 ? '...' : ''}`;
      
      // عرض منطقة الرد
      if (isPrivate) {
        document.getElementById('private-reply-preview-container').style.display = 'block';
        document.getElementById('private-reply-preview-text').textContent = replyText;
      } else {
        document.getElementById('reply-preview-container').style.display = 'block';
        document.getElementById('reply-preview-text').textContent = replyText;
      }
      
      // تحريك المؤشر إلى حقل الإدخال
      const input = isPrivate ? 
        document.getElementById('private-message-input') : 
        document.getElementById('message-input');
      input.focus();
    }
    
    function cancelReply() {
      replyingToMessage = null;
      document.getElementById('reply-preview-container').style.display = 'none';
    }
    
    function cancelPrivateReply() {
      replyingToMessage = null;
      document.getElementById('private-reply-preview-container').style.display = 'none';
    }
    
    /* ==========================
       ميزة مؤشر الكتابة في الرسائل الخاصة
       ========================== */
    function setupTypingEvents() {
      const input = document.getElementById('private-message-input');
      
      input.addEventListener('input', function() {
        if (!isTyping) {
          isTyping = true;
          // تحديث حالة الكتابة للمستخدم الآخر
          db.collection('private_chats').doc(privateChatId).update({
            [`typing.${currentUser.id}`]: true,
            lastTypingTime: firebase.firestore.FieldValue.serverTimestamp()
          });
        }
        
        // إعادة تعيين المؤقت
        clearTimeout(typingTimeout);
        typingTimeout = setTimeout(stopTyping, 3000);
      });
    }
    
    function stopTyping() {
      if (isTyping) {
        isTyping = false;
        db.collection('private_chats').doc(privateChatId).update({
          [`typing.${currentUser.id}`]: firebase.firestore.FieldValue.delete()
        });
      }
    }
    
    function setupTypingIndicator() {
      const typingRef = db.collection('private_chats').doc(privateChatId);
      typingRef.onSnapshot(function(doc) {
        if (doc.exists) {
          const data = doc.data();
          const typing = data.typing || {};
          const otherUserId = currentPrivateChatUser;
          
          if (typing[otherUserId]) {
            // عرض مؤشر الكتابة
            document.getElementById('typing-indicator').style.display = 'block';
          } else {
            // إخفاء مؤشر الكتابة
            document.getElementById('typing-indicator').style.display = 'none';
          }
        }
      });
    }
  </script>
</body>
</html>
