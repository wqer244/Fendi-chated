<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ù…Ø¹ Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ ÙˆØ®ÙŠØ§Ø±Ø§Øª ØªØ¹Ø¯ÙŠÙ„ ÙˆØ­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</title>
  <!--Ù…Ù†Ø¹ ØªÙƒØ¨ÙŠØ± Ø§Ùˆ ØªØµØºÙŠØ± ÙÙŠ Ù…ÙˆÙ‚Ø¹ÙŠ -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <!-- Ø®Ø·ÙˆØ· ØªØ§Ø¬ÙˆØ§Ù„ ÙˆØ±ÙˆØ¨ÙˆØª -->
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;500&display=swap" rel="stylesheet">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- Ø³ÙƒØ±Ø¨ØªØ§Øª Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
  <style>
    /* Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© ÙˆØ§Ù„Ø£Ù„ÙˆØ§Ù† */
    :root {
      --primary-bg: #36393f;
      --secondary-bg: #2f3136;
      --tertiary-bg: #202225;
      --accent-color: #7289da;
    }
    body.dark-mode {
      --primary-bg: #18191a;
      --secondary-bg: #242526;
      --tertiary-bg: #3a3b3c;
      --accent-color: #7289da;
    }
    body {
      margin: 0;
      padding: 0;
      background: var(--primary-bg);
      color: #dcddde;
      font-family: 'Tajawal', sans-serif;
      direction: rtl;
      overflow: hidden;
    }
    /* ØªØ®Ø·ÙŠØ· Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ */
    .container {
      display: flex;
      height: 100vh;
    }
    .sidebar {
      position: relative;
      width: 80px;
      background: var(--secondary-bg);
      padding-top: 10px;
      overflow: hidden;
    }
    .group-list {
      padding: 0 5px;
      overflow-y: auto;
      height: calc(100% - 120px);
    }
    .group-card {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      margin: 10px auto;
      cursor: pointer;
      transition: transform 0.3s;
      border: 2px solid transparent;
      position: relative;
    }
    .group-card.active {
      transform: scale(1.1);
    }
    .group-card.active::before {
      content: "";
      position: absolute;
      left: -5px;
      top: 50%;
      transform: translateY(-50%);
      width: 5px;
      height: 60%;
      background: green;
      border-radius: 5px;
    }
    .group-image {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      object-fit: cover;
    }
    .group-initial {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      background: var(--accent-color);
      color: #fff;
      font-size: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
    }
    .fixed-buttons {
      position: absolute;
      bottom: 0;
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      padding-bottom: 10px;
    }
    .fixed-buttons button {
      background: var(--accent-color);
      color: #fff;
      border: none;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      transition: transform 0.3s, background 0.3s;
    }
    .fixed-buttons button:hover {
      transform: scale(1.1);
    }
    /* Ø²Ø± Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª */
    .fixed-posts-btn {
      position: fixed;
      top: 1px;
      left: 50%;
      transform: translateX(-50%);
      background: #007BFF;
      color: #fff;
      padding: 3px 5px;
      border-radius: 5px;
      text-decoration: none;
      font-size: 18px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      z-index: 1200;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: background 0.3s;
    }
    .fixed-posts-btn:hover {
      background: #0056b3;
    }
    /* Ø²Ø± Ø§Ù„Ù‚ØµØµ */
    .fixed-stories-btn {
      position: fixed;
      top: 0px;
      right: 30px;
      background: #28a745;
      color: #fff;
      padding: 5px 5px;
      border-radius: 5px;
      text-decoration: none;
      font-size: 15px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      z-index: 1200;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: background 0.3s;
    }
    .fixed-stories-btn:hover {
      background: #218838;
    }
    /* Ø²Ø± Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø®Ø§ØµØ© */
    .private-messages-btn {
      position: fixed;
      top: 1px;
      right: 250px;
      background: #7289da;
      color: #fff;
      border: none;
      padding: -1px 10px;
      border-radius: 5px;
      font-size: 12px;
      cursor: pointer;
      z-index: 1300;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: background 0.3s;
    }
    .private-messages-btn:hover {
      background: #5d6dcc;
    }
    .private-messages-btn .badge {
      display: none;
      background: red;
      color: white;
      border-radius: 50%;
      padding: 2px 6px;
      font-size: 12px;
      margin-left: 5px;
    }
    /* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø¹Ø§Ù…Ø© */
    .chat-container {
      flex: 1;
      background: var(--primary-bg);
      display: flex;
      flex-direction: column;
    }
    .chat-area {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      background-size: cover;
      background-position: center;
    }
    /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø±Ø³Ø§Ù„Ø© */
    .message {
      position: relative;
      margin-bottom: 20px;
      display: flex;
      align-items: flex-start;
      gap: 10px;
    }
    .message-profile {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background-size: cover;
      background-position: center;
      flex-shrink: 0;
      cursor: pointer;
    }
    .message-bubble {
      background: var(--secondary-bg);
      padding: 10px;
      border-radius: 10px;
      position: relative;
      flex: 1;
      overflow: hidden;
      white-space: pre-wrap; /* Ù„Ø¶Ù…Ø§Ù† Ø¹Ø±Ø¶ ÙÙˆØ§ØµÙ„ Ø§Ù„Ø£Ø³Ø·Ø± Ø¨Ø´ÙƒÙ„ Ù…Ø±ØªØ¨ */
    }
    .message.sent .message-bubble {
      background: var(--accent-color);
      color: #fff;
    }
    .message-time {
      font-size: 12px;
      color: #aaa;
      margin-top: 5px;
    }
    /* ØªÙØ§Ø¹Ù„Ø§Øª Ø§Ù„Ø±Ø³Ø§Ù„Ø© ÙˆØ§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ */
    .reaction {
      display: inline-block;
      margin-top: 5px;
      padding: 2px 6px;
      background: rgba(0,0,0,0.2);
      border-radius: 12px;
      font-size: 14px;
      cursor: pointer;
    }
    .options-icon {
      position: absolute;
      top: 5px;
      right: 190px;
      cursor: pointer;
      color: inherit;
    }
    .options-panel {
      position: absolute;
      top: 30px;
      right: 100px;
      background: rgba(0,0,0,0.8);
      border-radius: 5px;
      padding: 5px;
      display: none;
      z-index: 10;
    }
    .options-panel button {
      background: transparent;
      border: none;
      color: #fff;
      cursor: pointer;
      margin: 2px;
      font-size: 14px;
    }
    .emoji-icon {
      position: absolute;
      bottom: 5px;
      right: 190px;
      cursor: pointer;
      font-size: 18px;
      color: inherit;
    }
    /* Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ (Ø§Ø³ØªØ®Ø¯Ø§Ù… textarea Ù„Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø·ÙˆÙŠÙ„Ø©) */
    .message-input {
      display: flex;
      padding: 10px;
      background: var(--tertiary-bg);
      border-top: 1px solid var(--secondary-bg);
    }
    .message-input textarea {
      flex: 1;
      padding: 1px;
      border: none;
      border-radius: 5px;
      background: var(--secondary-bg);
      color: #dcddde;
      resize: none;
      font-family: inherit;
    }
    .message-input button {
      padding: 10px 20px;
      margin-left: 10px;
      background: var(--accent-color);
      border: none;
      border-radius: 5px;
      color: #fff;
      cursor: pointer;
      transition: background 0.3s;
    }
    .message-input button:hover {
      background: #5d6dcc;
    }
    /* Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ */
    #emoji-popup {
      position: fixed;
      display: none;
      background: #fff;
      border: 1px solid #ccc;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      border-radius: 20px;
      padding: 5px 10px;
      z-index: 2500;
    }
    #emoji-popup .emoji-option {
      font-size: 24px;
      cursor: pointer;
      margin: 0 5px;
      transition: transform 0.2s;
    }
    #emoji-popup .emoji-option:hover {
      transform: scale(1.2);
    }
    /* Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© */
    .settings-popup,
    .create-group-popup,
    .group-options-popup,
    .edit-group-popup,
    .rooms-popup,
    .background-popup,
    .change-name-popup,
    .edit-message-popup,
    .edit-private-message-popup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #fff;
      border: 1px solid #ccc;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      display: none;
      text-align: center;
      z-index: 2300;
      border-radius: 8px;
      width: 400px;
      padding: 20px;
    }
    .edit-private-message-popup {
      z-index: 3100;
      width: 90%;
      max-width: 400px;
    }
    .settings-popup h3,
    .create-group-popup h3,
    .edit-group-popup h3,
    .rooms-popup h3,
    .background-popup h3,
    .change-name-popup h3,
    .edit-message-popup h3,
    .edit-private-message-popup h3 {
      margin-top: 0;
    }
    .create-group-popup input,
    .edit-group-popup input,
    .settings-popup input,
    .settings-popup textarea,
    .change-name-popup input {
      width: 100%;
      padding: 10px;
      margin-bottom: 10px;
      border: none;
      border-radius: 5px;
      background: var(--primary-bg);
      color: #dcddde;
    }
    .create-group-popup button,
    .edit-group-popup button,
    .settings-popup button,
    .change-name-popup button,
    .edit-message-popup button,
    .edit-private-message-popup button {
      width: 100%;
      padding: 10px;
      background: var(--accent-color);
      border: none;
      border-radius: 5px;
      color: #fff;
      cursor: pointer;
      margin-bottom: 10px;
      transition: background 0.3s;
    }
    .create-group-popup button:hover,
    .edit-group-popup button:hover,
    .settings-popup button:hover,
    .change-name-popup button:hover,
    .edit-message-popup button:hover,
    .edit-private-message-popup button:hover {
      background: #5d6dcc;
    }
    .group-options-popup button {
      width: 100%;
      padding: 10px;
      margin: 5px 0;
      background: var(--accent-color);
      border: none;
      border-radius: 5px;
      color: #fff;
      cursor: pointer;
      transition: background 0.3s;
    }
    .group-options-popup button:hover {
      background: #5d6dcc;
    }
    .group-options-popup .cancel-btn {
      background: #dc3545;
    }
    .group-options-popup .cancel-btn:hover {
      background: #c33a2f;
    }
    .settings-popup button {
      width: 100%;
      padding: 12px;
      margin: 8px 0;
      border: none;
      border-radius: 5px;
      font-size: 16px;
      cursor: pointer;
      transition: background 0.3s;
    }
    /* ØªØ­Ø³ÙŠÙ† Ø²Ø± Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ */
    .modal-close {
      background: #dc3545;
      border: none;
      color: #fff;
      padding: 8px 12px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      margin-top: 20px;
    }
    #toggle-dark-mode {
      background: #6c757d;
      color: #fff;
    }
    #toggle-dark-mode:hover {
      background: #5a6268;
    }
    #change-bg-btn {
      background: var(--accent-color);
      color: #fff;
    }
    #change-bg-btn:hover {
      background: #5d6dcc;
    }
    #change-name-btn {
      background: #17a2b8;
      color: #fff;
    }
    #change-name-btn:hover {
      background: #138496;
    }
    #logout-btn {
      background: #dc3545;
      color: #fff;
    }
    #logout-btn:hover {
      background: #c82333;
    }
    #close-settings-btn {
      background: #6c757d;
      color: #fff;
    }
    #close-settings-btn:hover {
      background: #5a6268;
    }
    .rooms-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      max-height: 300px;
      overflow-y: auto;
      margin: 20px 0;
    }
    .room-card {
      width: 80px;
      height: 80px;
      background: var(--secondary-bg);
      border: 1px solid #4a4e57;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      border-radius: 8px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: transform 0.3s, box-shadow 0.3s;
      padding: 5px;
    }
    .room-card:hover {
      transform: scale(1.1);
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    }
    .room-card img {
      width: 100%;
      height: 50px;
      object-fit: cover;
      border-radius: 4px;
      margin-bottom: 5px;
    }
    .room-card span {
      font-size: 12px;
      text-align: center;
      color: #fff;
    }
    @media (max-width: 768px) {
      .sidebar {
        width: 60px;
      }
      .fixed-buttons button {
        width: 40px;
        height: 40px;
        font-size: 18px;
      }
      .group-card {
        width: 50px;
        height: 50px;
      }
      .group-initial {
        font-size: 20px;
      }
      .settings-popup,
      .create-group-popup,
      .group-options-popup,
      .edit-group-popup,
      .rooms-popup {
        width: 90%;
      }
      .settings-popup button {
        font-size: 14px;
        padding: 10px;
      }
    }
    #background-popup {
      max-height: 80vh;
      overflow-y: auto;
    }
    #background-options-container {
      max-height: 300px;
      overflow-y: auto;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
      margin-bottom: 10px;
    }
    .bg-option.selected {
      border: 2px solid red;
    }
    /* ØªØµÙ…ÙŠÙ… ØµÙØ­Ø© Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ© */
    #profile-modal {
      display: none;
      position: fixed;
      z-index: 3500;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      overflow-y: auto;
    }
    #profile-modal .modal-content {
      background: #fff;
      margin: 5% auto;
      padding: 30px;
      border-radius: 10px;
      width: 90%;
      max-width: 500px;
      box-shadow: 0 0 20px rgba(0,0,0,0.3);
      text-align: center;
    }
    #profile-modal .modal-content h2 {
      margin-top: 0;
      font-size: 24px;
      color: #333;
    }
    /* Ù†Ø§ÙØ°Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø®Ø§ØµØ© */
    .private-messages-popup {
      display: none;
      position: fixed;
      top: 50px;
      right: 10px;
      width: 300px;
      max-height: 80vh;
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 8px;
      z-index: 1400;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
    .private-messages-popup .popup-header {
      background: #7289da;
      color: #fff;
      padding: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .private-messages-popup .private-messages-list {
      padding: 10px;
      overflow-y: auto;
      max-height: calc(80vh - 50px);
    }
    .private-message-item {
      padding: 8px;
      border-bottom: 1px solid #ddd;
      cursor: pointer;
    }
    .private-message-item:hover {
      background: #f0f0f0;
    }
    .close-btn {
      background: none;
      border: none;
      color: #fff;
      font-size: 20px;
      cursor: pointer;
    }
    /* Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø®Ø§ØµØ© */
    .private-chat-popup {
      display: none;
      position: fixed;
      z-index: 3000;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
    }
    .private-chat-popup .chat-container {
      background: #fff;
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
    }
    .private-chat-popup .chat-header {
      background: #7289da;
      color: #fff;
      padding: 15px;
      text-align: left;
      font-size: 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .private-chat-popup .chat-header .back-icon {
      margin-right: 10px;
      cursor: pointer;
      font-size: 24px;
    }
    .private-chat-popup .chat-header .chat-user-status {
      font-size: 14px;
      color: #fff;
    }
    .private-chat-popup .chat-area {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      background: #f9f9f9;
    }
    .private-chat-popup .message-input {
      display: flex;
      padding: 10px;
      background: #ddd;
    }
    .private-chat-popup .message-input textarea {
      flex: 1;
      padding: 10px;
      border: none;
      border-radius: 5px;
      margin-right: 10px;
      resize: none;
      font-family: inherit;
    }
    .private-chat-popup .message-input button {
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      background: #7289da;
      color: #fff;
      cursor: pointer;
    }
    /* ØªÙ†Ø³ÙŠÙ‚ Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø±Ø§Ø¨Ø· */
    .link-preview {
      border: 1px solid #ccc;
      border-radius: 5px;
      margin-top: 5px;
      display: flex;
      text-decoration: none;
      color: inherit;
      overflow: hidden;
    }
    .link-preview img {
      width: 100px;
      height: 100px;
      object-fit: cover;
    }
    .link-preview .preview-details {
      padding: 5px;
      flex: 1;
    }
    .link-preview .preview-details h4 {
      margin: 0 0 5px;
      font-size: 16px;
    }
    .link-preview .preview-details p {
      margin: 0;
      font-size: 14px;
      color: #555;
    }
    body {
      user-select: none;
      -webkit-user-select: none;
      /* Ù„Ù„Ù…ØªØµÙØ­Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© */
      -moz-user-select: none;
      -ms-user-select: none;
    }
    /* ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ù‚Ø±Ø§Ø¡Ø§Øª */
    .seen-status {
      position: absolute;
      bottom: 5px;
      left: 10px;
      font-size: 12px;
    }
    
    .seen-icon {
      color: #888;
      cursor: pointer;
      transition: color 0.3s;
    }
    
    .seen-icon.seen {
      color: #ff4444;
    }
    
    .seen-users-popup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
      z-index: 9999;
    }
    
    .seen-user {
      display: flex;
      align-items: center;
      margin: 10px 0;
    }
    
    .seen-user img {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      margin-left: 10px;
    }
    
    /* Ø²Ø± Ø¥Ø±ÙØ§Ù‚ Ø§Ù„ØµÙˆØ±Ø© */
    .attach-image-btn {
      background: #4caf50;
      color: white;
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      margin-left: 10px;
      transition: transform 0.3s;
    }
    
    .attach-image-btn:hover {
      transform: scale(1.1);
    }
    
    /* Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ */
    .upload-indicator {
      display: none;
      margin-left: 10px;
      font-size: 20px;
      color: #7289da;
    }
    
    /* Ø§Ù„ØµÙˆØ± ÙÙŠ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© */
    .thumbnail-image {
      max-width: 200px;
      max-height: 200px;
      border-radius: 8px;
      cursor: pointer;
      transition: transform 0.2s;
      object-fit: cover;
      display: block;
      margin-top: 5px;
    }
    
    .thumbnail-image:hover {
      transform: scale(1.03);
    }
    
    .image-caption {
      margin-top: 8px;
      font-size: 15px;
      color: #e0e0e0;
      padding: 5px 0;
      max-width: 200px;
      word-break: break-word;
    }
    
    /* Ù†Ø§ÙØ°Ø© Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±Ø© */
    .image-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      z-index: 4000;
      text-align: center;
      overflow: auto;
      padding: 20px;
      box-sizing: border-box;
    }
    
    .image-modal-content {
      max-width: 100%;
      max-height: 80vh;
      margin: auto;
      display: block;
      border: 1px solid #444;
      box-shadow: 0 0 30px rgba(0, 0, 0, 0.8);
    }
    
    .full-image-caption {
      color: white;
      text-align: center;
      padding: 15px;
      font-size: 18px;
      max-width: 80%;
      margin: 0 auto;
    }
    
    .close-image-modal {
      position: absolute;
      top: 20px;
      right: 20px;
      color: white;
      font-size: 40px;
      cursor: pointer;
      opacity: 0.7;
      transition: opacity 0.3s;
      z-index: 4100;
    }
    
    .close-image-modal:hover {
      opacity: 1;
    }
    
    /* Ù†Ø§ÙØ°Ø© Ø¥Ø¶Ø§ÙØ© Ù†Øµ Ù„Ù„ØµÙˆØ±Ø© */
    .image-caption-popup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 20px;
      border-radius: 10px;
      z-index: 4500;
      width: 90%;
      max-width: 400px;
      display: none;
    }
    
    .image-caption-popup textarea {
      width: 100%;
      height: 100px;
      margin-bottom: 15px;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      resize: vertical;
    }
    
    /* Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„ */
    .upload-indicator-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 5000;
      display: none;
      justify-content: center;
      align-items: center;
    }
    
    .upload-spinner {
      width: 80px;
      height: 80px;
      border: 8px solid #f3f3f3;
      border-top: 8px solid #7289da;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Ø²Ø± Ø§Ù„Ø­Ø§Ù„Ø© ÙÙŠ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ */
    .user-status-indicator {
      font-size: 14px;
      padding: 3px 8px;
      border-radius: 10px;
      display: inline-block;
      margin-top: 5px;
    }
    
    .status-online {
      background-color: #4CAF50;
      color: white;
    }
    
    .status-offline {
      background-color: #f44336;
      color: white;
    }
    
    .status-idle {
      background-color: #FF9800;
      color: white;
    }
  </style>
</head>
<script>
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/sw.js')
            .then(() => console.log("âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Service Worker Ø¨Ù†Ø¬Ø§Ø­"))
            .catch((error) => console.log("âŒ ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Service Worker", error));
    }
</script>

<body>
  <!-- Ø²Ø± Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª -->
  <a href="posts.html" class="fixed-posts-btn">
    <i class="fa-solid fa-pen-to-square"></i>
    <span>Ù…Ù†Ø´ÙˆØ±Ø§Øª</span>
  </a>
  <!-- Ø²Ø± Ø§Ù„Ù‚ØµØµ -->
  <a href="store.html" class="fixed-stories-btn">
    <i class="fa-solid fa-book-open"></i>
    <span>Ø§Ù„Ù‚ØµØµ </span>
  </a>
  <!-- Ø²Ø± Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø®Ø§ØµØ© -->
  <button class="private-messages-btn" onclick="togglePrivateMessagesPopup()">
    <i class="fa-solid fa-comments"></i>
    <span>Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø®Ø§ØµØ©</span>
    <span id="private-badge" class="badge"></span>
  </button>
  <div class="container">
    <!-- Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ -->
    <div class="sidebar" id="sidebar">
      <div class="group-list" id="group-list"></div>
      <div class="fixed-buttons">
        <!-- Ø²Ø± Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ Ø§Ù„Ø¬Ø¯ÙŠØ¯ -->
        <button class="profile-btn-sidebar" onclick="openProfilePopup()">
          <i class="fa-solid fa-user-circle"></i>
        </button>
        <button class="settings-btn-sidebar" onclick="showSettingsPopup()">
          <i class="fa-solid fa-cog"></i>
        </button>
        <button class="rooms-btn-sidebar" onclick="toggleRoomsPopup()">
          <i class="fa-solid fa-users"></i>
        </button>
        <button class="create-group-btn" onclick="openCreateGroupPopup()">+</button>
      </div>
    </div>
    <!-- Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø¹Ø§Ù…Ø© -->
    <div class="chat-container">
      <div class="chat-area" id="messages"></div>
      <div class="message-input">
        <button class="attach-image-btn" id="attach-image-btn">
          <i class="fa-solid fa-camera"></i>
        </button>
        <input type="file" id="image-upload" accept="image/*" style="display: none;">
        <div id="upload-indicator" class="upload-indicator">
          <i class="fa-solid fa-spinner fa-spin"></i>
        </div>
        <textarea id="message-input" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©..." rows="3"></textarea>
        <button onclick="sendMessage()">Ø¥Ø±Ø³Ø§Ù„</button>
      </div>
    </div>
  </div>
  <!-- Ù†Ø§ÙØ°Ø© Ø§Ù„Ø±ÙˆÙ…Ø§Øª -->
  <div class="rooms-popup" id="rooms-popup">
    <h3>Ø§Ù„Ø±ÙˆÙ…Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©</h3>
    <div class="rooms-grid" id="rooms-grid"></div>
    <button onclick="toggleRoomsPopup()">Ø¥ØºÙ„Ø§Ù‚</button>
  </div>
  <!-- Ù†Ø§ÙØ°Ø© Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù…ÙˆØ¹Ø© -->
  <div class="create-group-popup" id="create-group-popup">
    <h3>Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù…ÙˆØ¹Ø© Ø¬Ø¯ÙŠØ¯Ø©</h3>
    <input type="text" id="group-name" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©">
    <input type="text" id="group-image" placeholder="Ø±Ø§Ø¨Ø· ØµÙˆØ±Ø© Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
    <button onclick="createGroup()">Ø¥Ù†Ø´Ø§Ø¡</button>
    <button onclick="closeCreateGroupPopup()">Ø¥ØºÙ„Ø§Ù‚</button>
  </div>
  <!-- Ù†Ø§ÙØ°Ø© Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© -->
  <div class="group-options-popup" id="group-options-popup">
    <button id="edit-group-btn">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</button>
    <button id="delete-group-btn">Ø­Ø°Ù Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</button>
    <button class="cancel-btn" onclick="closeGroupOptionsPopup()">Ø¥Ù„ØºØ§Ø¡</button>
  </div>
  <!-- Ù†Ø§ÙØ°Ø© ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© -->
  <div class="edit-group-popup" id="edit-group-popup">
    <h3>ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</h3>
    <input type="text" id="edit-group-name" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©">
    <input type="text" id="edit-group-image" placeholder="Ø±Ø§Ø¨Ø· ØµÙˆØ±Ø© Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
    <button onclick="saveGroupEdits()">Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
    <button onclick="closeEditGroupPopup()">Ø¥Ù„ØºØ§Ø¡</button>
  </div>
  <!-- Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª -->
  <div class="settings-popup" id="settings-popup">
    <h3>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</h3>
    <button id="toggle-dark-mode">Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¯Ø§ÙƒÙ†</button>
    <button id="change-bg-btn">ØªØºÙŠÙŠØ± Ø§Ù„Ø®Ù„ÙÙŠØ©</button>
    <button id="change-name-btn">ØªØºÙŠÙŠØ± Ø§Ù„Ø§Ø³Ù…</button>
    <button id="logout-btn">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
    <button id="faq-btn" onclick="window.location.href='what.html'">Ø£Ø³Ø¦Ù„Ø© Ø´Ø§Ø¦Ø¹Ø©</button>
    <button id="close-settings-btn" onclick="closeSettingsPopup()">Ø¥ØºÙ„Ø§Ù‚</button>
  </div>
  <!-- Ù†Ø§ÙØ°Ø© ØªØºÙŠÙŠØ± Ø§Ù„Ø®Ù„ÙÙŠØ© -->
  <div class="settings-popup" id="background-popup">
    <h3>Ø§Ø®ØªØ± Ø§Ù„Ø®Ù„ÙÙŠØ©</h3>
    <div class="background-options" id="background-options-container"></div>
    <button id="apply-bg-btn">ØªØ¹ÙŠÙŠÙ†</button>
    <button onclick="closeBackgroundPopup()">Ø¥ØºÙ„Ø§Ù‚</button>
  </div>
  <!-- Ù†Ø§ÙØ°Ø© ØªØºÙŠÙŠØ± Ø§Ù„Ø§Ø³Ù… -->
  <div class="settings-popup" id="change-name-popup">
    <h3>ØªØºÙŠÙŠØ± Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</h3>
    <input type="text" id="new-name" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯">
    <button onclick="changeName()">ØªØºÙŠÙŠØ± Ø§Ù„Ø§Ø³Ù…</button>
    <button onclick="closeChangeNamePopup()">Ø¥ØºÙ„Ø§Ù‚</button>
  </div>
  <!-- Ù†Ø§ÙØ°Ø© ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø¹Ø§Ù…Ø© -->
  <div class="settings-popup" id="edit-message-popup">
    <h3>ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©</h3>
    <textarea id="edit-message-input" rows="3"></textarea>
    <div style="margin-top:10px;">
      <button onclick="updateMessage()">ØªØ¹Ø¯ÙŠÙ„</button>
      <button onclick="deleteEditedMessage()" style="background: #dc3545;">Ø­Ø°Ù Ø±Ø³Ø§Ù„Ø©</button>
      <button onclick="closeEditPopup()" style="background: #dc3545;">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
  </div>
  <!-- Ù†Ø§ÙØ°Ø© ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø®Ø§ØµØ© -->
  <div class="edit-private-message-popup" id="edit-private-message-popup">
    <h3>ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©</h3>
    <textarea id="edit-private-message-input" rows="3"></textarea>
    <div style="margin-top:10px;">
      <button onclick="updatePrivateMessage()">ØªØ¹Ø¯ÙŠÙ„</button>
      <button onclick="deletePrivateMessage()" style="background: #dc3545;">Ø­Ø°Ù Ø±Ø³Ø§Ù„Ø©</button>
      <button onclick="closePrivateEditPopup()" style="background: #dc3545;">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
  </div>
  <!-- Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ -->
  <div id="emoji-popup">
    <span class="emoji-option">ğŸ‘</span>
    <span class="emoji-option">â¤ï¸</span>
    <span class="emoji-option">ğŸ˜‚</span>
    <span class="emoji-option">ğŸ˜®</span>
    <span class="emoji-option">ğŸ˜¢</span>
    <span class="emoji-option">ğŸ˜¡</span>
  </div>
  <!-- ØµÙØ­Ø© Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ© -->
  <div id="profile-modal">
    <div class="modal-content">
      <!-- Ø¹Ù†ØµØ± Ø§Ù„Ø­Ø§Ù„Ø© Ù‡Ù†Ø§ ÙŠÙØ¹Ø±Ø¶ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ© -->
      <p id="user-status" class="user-status-indicator"></p>
      <div id="profile-modal-body"></div>
      <button class="modal-close" onclick="closeProfileModal()">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
  </div>
  <!-- Ù†Ø§ÙØ°Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø®Ø§ØµØ© (Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø§Øª Ø§Ù„Ø®Ø§ØµØ©) -->
  <div class="private-messages-popup" id="private-messages-popup">
    <div class="popup-header">
      <h3>Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø®Ø§ØµØ©</h3>
      <button class="close-btn" onclick="togglePrivateMessagesPopup()">Ã—</button>
    </div>
    <div class="private-messages-list" id="private-messages-list">
      <!-- Ø³ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø®Ø§ØµØ© Ù‡Ù†Ø§ -->
    </div>
  </div>
  <!-- Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø®Ø§ØµØ© -->
  <div class="private-chat-popup" id="private-chat-popup">
    <div class="chat-container">
      <div class="chat-header" id="private-chat-header">
        <div style="display:flex; align-items:center;">
          <i class="fa-solid fa-arrow-left back-icon" onclick="closePrivateChatPopup()"></i>
          <span id="private-chat-title">Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø®Ø§ØµØ©</span>
        </div>
        <!-- Ø¹Ø±Ø¶ Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¢Ø®Ø± ÙÙŠ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø®Ø§ØµØ© -->
        <span id="chat-user-status" class="chat-user-status"></span>
      </div>
      <div class="chat-area" id="private-chat-area"></div>
      <div class="message-input">
        <button class="attach-image-btn" id="private-attach-image-btn">
          <i class="fa-solid fa-camera"></i>
        </button>
        <input type="file" id="private-image-upload" accept="image/*" style="display: none;">
        <div id="private-upload-indicator" class="upload-indicator">
          <i class="fa-solid fa-spinner fa-spin"></i>
        </div>
        <textarea id="private-message-input" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©..." rows="3"></textarea>
        <button onclick="sendPrivateMessage()">Ø¥Ø±Ø³Ø§Ù„</button>
      </div>
    </div>
  </div>
  
  <!-- Ù†Ø§ÙØ°Ø© Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±Ø© -->
  <div class="image-modal" id="image-modal">
    <span class="close-image-modal" id="close-image-modal">&times;</span>
    <img class="image-modal-content" id="full-size-image" src="">
    <div class="full-image-caption" id="full-image-caption"></div>
  </div>
  
  <!-- Ù†Ø§ÙØ°Ø© Ø¥Ø¶Ø§ÙØ© Ù†Øµ Ù„Ù„ØµÙˆØ±Ø© -->
  <div class="image-caption-popup" id="image-caption-popup">
    <h3>Ø£Ø¶Ù Ù†ØµØ§Ù‹ Ù„Ù„ØµÙˆØ±Ø©</h3>
    <textarea id="image-caption-input" placeholder="Ø§ÙƒØªØ¨ ÙˆØµÙØ§Ù‹ Ù„Ù„ØµÙˆØ±Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"></textarea>
    <button onclick="sendImageWithCaption()">Ø¥Ø±Ø³Ø§Ù„</button>
    <button onclick="closeImageCaptionPopup()" style="background: #dc3545; margin-top: 10px;">Ø¥Ù„ØºØ§Ø¡</button>
  </div>
  
  <!-- Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„ -->
  <div class="upload-indicator-container" id="upload-indicator-container">
    <div class="upload-spinner"></div>
  </div>

  <!-- Ø³ÙƒØ±Ø¨ØªØ§Øª Firebase ÙˆØ§Ù„Ù…ÙƒØªØ¨Ø§Øª Ø§Ù„Ø£Ø®Ø±Ù‰ -->
  <script>
    // ØµÙˆØ±Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
    const defaultProfileImage = "https://www.gravatar.com/avatar/?d=mp";
    // Ù…ÙØªØ§Ø­ API Ø§Ù„Ø®Ø§Øµ Ø¨Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø±ÙˆØ§Ø¨Ø·
    const LINK_PREVIEW_API_KEY = "951325d26926d6d2ea4d2ce782629764";
    
    // Ù…ÙØ§ØªÙŠØ­ Backendless API
    const BACKENDLESS_APP_ID = "1A59C778-783C-4A9B-8167-648ECCFDF394";
    const BACKENDLESS_API_KEY = "BBEAFC43-F642-44A3-B89A-245CA24C6D87";
    
    let currentUser = null;
    let currentGroup = 'general';
    let selectedGroupId = null;
    let selectedGroupData = {};
    let editingMessageId = null;
    let selectedBg = '';
    let selectedMessageForReaction = null;
    let currentImageToSend = null;
    let isPrivateImage = false;
    
    // Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø®Ø§ØµØ©
    let currentPrivateChatUser = null;
    let privateChatId = null;
    let editingPrivateMessageId = null;
    
    // ØªÙ‡ÙŠØ¦Ø© Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyBwwrBtf6AtW7R36FX4j2GQZVEdJldFq7o",
      authDomain: "you-unblock.firebaseapp.com",
      projectId: "you-unblock",
      storageBucket: "you-unblock",
      messagingSenderId: "306278978440",
      appId: "1:306278978440:web:4ca87c3856e107a30be03d"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    /* ==========================
       ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (online/offline) Ù…Ø¹ Ø²Ø± Ø§Ù„Ø­Ø§Ù„Ø©
       ========================== */
    function setUserStatusOnline() {
      if(currentUser && currentUser.id) {
        db.collection('users').doc(currentUser.id).update({
          status: "online",
          lastSeen: firebase.firestore.FieldValue.serverTimestamp()
        });
      }
    }
    function setUserStatusOffline() {
      if(currentUser && currentUser.id) {
        db.collection('users').doc(currentUser.id).update({
          status: "offline",
          lastSeen: firebase.firestore.FieldValue.serverTimestamp()
        });
      }
    }
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©
    auth.onAuthStateChanged(user => {
      if(user) {
        db.collection('users').doc(user.uid).get().then(doc => {
          if(doc.exists) {
            currentUser = doc.data();
            currentUser.id = user.uid;
            setUserStatusOnline();
          } else {
            currentUser = {
              id: user.uid,
              name: user.displayName || "Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø¬Ù‡ÙˆÙ„",
              description: "",
              username: "",
              createdAt: new Date().toISOString(),
              photoURL: user.photoURL || defaultProfileImage,
              status: "online"
            };
            db.collection('users').doc(user.uid).set(currentUser);
          }
          loadGroups();
          currentGroup = localStorage.getItem('lastGroup') || 'general';
          loadMessages();
          loadPrivateMessages();
        });
        window.addEventListener("beforeunload", setUserStatusOffline);
      } else {
        window.location.href = 'login.html';
      }
    });
    
    /* ==========================
       Ø¯Ø§Ù„Ø© Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ù†Ù‚Ø¶ÙŠ Ù…Ù†Ø° Ø¢Ø®Ø± Ø¸Ù‡ÙˆØ±
       ========================== */
    function formatLastSeen(lastSeen) {
      if (!lastSeen) return "Ù‚Ø¨Ù„ ÙˆÙ‚Øª Ø·ÙˆÙŠÙ„";
      
      const now = new Date();
      const lastSeenDate = lastSeen.toDate();
      const diffSeconds = Math.floor((now - lastSeenDate) / 1000);
      
      if (diffSeconds < 60) {
        return "Ù‚Ø¨Ù„ Ø«ÙˆØ§Ù†Ù";
      } else if (diffSeconds < 3600) {
        const minutes = Math.floor(diffSeconds / 60);
        return `Ù‚Ø¨Ù„ ${minutes} Ø¯Ù‚ÙŠÙ‚Ø©`;
      } else if (diffSeconds < 86400) {
        const hours = Math.floor(diffSeconds / 3600);
        return `Ù‚Ø¨Ù„ ${hours} Ø³Ø§Ø¹Ø©`;
      } else if (diffSeconds < 604800) {
        const days = Math.floor(diffSeconds / 86400);
        return `Ù‚Ø¨Ù„ ${days} ÙŠÙˆÙ…`;
      } else if (diffSeconds < 2592000) {
        const weeks = Math.floor(diffSeconds / 604800);
        return `Ù‚Ø¨Ù„ ${weeks} Ø£Ø³Ø¨ÙˆØ¹`;
      } else {
        const months = Math.floor(diffSeconds / 2592000);
        return `Ù‚Ø¨Ù„ ${months} Ø´Ù‡Ø±`;
      }
    }
    
    /* ==========================
       Ø¹Ø±Ø¶ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ø²Ø± Ø§Ù„Ø­Ø§Ù„Ø©)
       ========================== */
    function getUserStatus(userId) {
      const userRef = db.collection("users").doc(userId);
      userRef.onSnapshot((doc) => {
        if (doc.exists) {
          const data = doc.data();
          const statusElement = document.getElementById("user-status");
          
          if (data.status === "online") {
            statusElement.innerText = "Ù…ØªØµÙ„ Ø§Ù„Ø¢Ù†";
            statusElement.className = "user-status-indicator status-online";
          } else {
            const lastSeenText = formatLastSeen(data.lastSeen);
            statusElement.innerText = lastSeenText;
            statusElement.className = "user-status-indicator status-offline";
          }
        }
      });
    }
    
    function updateChatUserStatus(userId) {
      const statusElement = document.getElementById("chat-user-status");
      db.collection("users").doc(userId).onSnapshot((doc) => {
        if (doc.exists) {
          const data = doc.data();
          if (data.status === "online") {
            statusElement.innerText = "Ù…ØªØµÙ„ Ø§Ù„Ø¢Ù†";
            statusElement.style.color = "green";
          } else {
            const lastSeenText = formatLastSeen(data.lastSeen);
            statusElement.innerText = lastSeenText;
            statusElement.style.color = "red";
          }
        }
      });
    }
    
    /* ==========================
       Ø¯ÙˆØ§Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª ÙˆØ§Ù„Ø±Ø³Ø§Ø¦Ù„ ÙˆØ§Ù„Ø¯Ø±Ø¯Ø´Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©
       ========================== */
    function loadGroups() {
      db.collection('groups').orderBy('createdAt').onSnapshot(snapshot => {
        const groupList = document.getElementById('group-list');
        groupList.innerHTML = "";
        snapshot.forEach(doc => {
          const data = doc.data();
          const groupCard = document.createElement('div');
          groupCard.className = 'group-card';
          groupCard.dataset.groupId = doc.id;
          if(doc.id === currentGroup) {
            groupCard.classList.add('active');
          }
          if(data.image && data.image.trim() !== "") {
            groupCard.innerHTML = `<img src="${data.image}" class="group-image" alt="${data.name}">`;
          } else {
            groupCard.innerHTML = `<div class="group-initial">${data.name.charAt(0).toUpperCase()}</div>`;
          }
          let pressTimer;
          let longPress = false;
          groupCard.addEventListener('mousedown', (e) => {
            longPress = false;
            pressTimer = setTimeout(() => {
              longPress = true;
              if(data.creatorId === currentUser.id) {
                showGroupOptionsPopup(doc.id, data);
              }
            }, 800);
          });
          groupCard.addEventListener('touchstart', (e) => {
            longPress = false;
            pressTimer = setTimeout(() => {
              longPress = true;
              if(data.creatorId === currentUser.id) {
                showGroupOptionsPopup(doc.id, data);
              }
            }, 800);
          });
          groupCard.addEventListener('mouseup', (e) => {
            clearTimeout(pressTimer);
            if(!longPress) {
              enterGroup(doc.id);
            }
          });
          groupCard.addEventListener('touchend', (e) => {
            clearTimeout(pressTimer);
            if(!longPress) {
              enterGroup(doc.id);
            }
          });
          groupCard.addEventListener('mouseleave', (e) => {
            clearTimeout(pressTimer);
          });
          groupList.appendChild(groupCard);
        });
        populateRoomsPopup();
      });
    }
    
    // Ø¯Ø§Ù„Ø© ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø±ÙˆØ§Ø¨Ø· Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… ØªØ¹Ø¨ÙŠØ± Ù†Ù…Ø·ÙŠ
    function extractURLs(text) {
      const urlRegex = /(https?:\/\/[^\s]+)/g;
      return text.match(urlRegex);
    }
    
    // Ø¯Ø§Ù„Ø© Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ API Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø±Ø§Ø¨Ø·
    async function getLinkPreview(url) {
      try {
        const response = await fetch(`https://api.linkpreview.net/?key=${LINK_PREVIEW_API_KEY}&q=${encodeURIComponent(url)}`);
        if(response.ok){
          return await response.json();
        }
      } catch(err) {
        console.error("Error fetching link preview:", err);
      }
      return null;
    }
    
    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¹Ø§Ù…Ø© Ù…Ø¹ Ø¯Ø¹Ù… Ø¹Ø±Ø¶ Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø±Ø§Ø¨Ø·
    function loadMessages() {
      const messagesContainer = document.getElementById('messages');
      db.collection('groups').doc(currentGroup).collection('messages')
        .orderBy('timestamp')
        .onSnapshot(snapshot => {
          messagesContainer.innerHTML = "";
          snapshot.forEach(doc => {
            const msg = doc.data();
            let timeString = "";
            if(msg.timestamp) {
              timeString = new Date(msg.timestamp.toDate()).toLocaleTimeString();
            }
            if(msg.edited) {
              timeString += " (ØªÙ… ØªØ¹Ø¯ÙŠÙ„)";
            }
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message ' + (msg.senderId === currentUser.id ? 'sent' : 'received');
    
            const profileImgDiv = document.createElement('div');
            profileImgDiv.className = 'message-profile';
            let senderPhoto = msg.senderPhoto || defaultProfileImage;
            profileImgDiv.style.backgroundImage = 'url(' + senderPhoto + ')';
            profileImgDiv.addEventListener('click', function(e) {
              e.stopPropagation();
              showProfileModal({ id: msg.senderId, name: msg.senderName, photoURL: senderPhoto });
              if(msg.senderId === currentUser.id){
                getUserStatus(currentUser.id);
              }
            });
            messageDiv.appendChild(profileImgDiv);
    
            const bubbleDiv = document.createElement('div');
            bubbleDiv.className = 'message-bubble';
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø±Ø³Ø§Ù„Ø© ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ ØµÙˆØ±Ø©
            if (msg.isImage) {
              bubbleDiv.innerHTML = `<strong>${msg.senderName}:</strong><br>`;
              const imgElement = document.createElement('img');
              imgElement.src = msg.imageUrl;
              imgElement.className = 'thumbnail-image';
              imgElement.onclick = () => openImageModal(msg.imageUrl, msg.text || '');
              bubbleDiv.appendChild(imgElement);
              
              // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ù†ØµØŒ Ø¹Ø±Ø¶Ù‡ Ø£Ø³ÙÙ„ Ø§Ù„ØµÙˆØ±Ø©
              if (msg.text) {
                const captionDiv = document.createElement('div');
                captionDiv.className = 'image-caption';
                captionDiv.textContent = msg.text;
                bubbleDiv.appendChild(captionDiv);
              }
              
              bubbleDiv.innerHTML += `<div class="message-time">${timeString}</div>`;
            } else {
              bubbleDiv.innerHTML = `<strong>${msg.senderName}:</strong> ${msg.text} <div class="message-time">${timeString}</div>`;
              
              // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø±Ø³Ø§Ù„Ø© ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ù…Ø¹Ø§ÙŠÙ†Ø© Ø±Ø§Ø¨Ø· ÙÙ‚Ù… Ø¨Ø¹Ø±Ø¶Ù‡Ø§
              if(msg.linkPreview) {
                const previewLink = document.createElement('a');
                previewLink.href = msg.linkPreview.url;
                previewLink.target = "_blank";
                previewLink.className = "link-preview";
                previewLink.innerHTML = `
                  ${ msg.linkPreview.image ? `<img src="${msg.linkPreview.image}" alt="Ù…Ø¹Ø§ÙŠÙ†Ø©">` : '' }
                  <div class="preview-details">
                    <h4>${msg.linkPreview.title || ''}</h4>
                    <p>${msg.linkPreview.description || ''}</p>
                  </div>
                `;
                bubbleDiv.appendChild(previewLink);
              }
            }
    
            messageDiv.appendChild(bubbleDiv);
    
            if(msg.senderId === currentUser.id) {
              const optionsIcon = document.createElement('div');
              optionsIcon.className = 'options-icon';
              optionsIcon.innerHTML = '<i class="fa-solid fa-ellipsis-h"></i>';
              bubbleDiv.appendChild(optionsIcon);
              bubbleDiv.addEventListener('click', function(e) {
                e.stopPropagation();
                let panel = bubbleDiv.querySelector('.options-panel');
                if(panel) {
                  panel.style.display = (panel.style.display === 'block') ? 'none' : 'block';
                }
              });
    
              const optionsPanel = document.createElement('div');
              optionsPanel.className = 'options-panel';
              const editBtn = document.createElement('button');
              editBtn.textContent = 'ØªØ¹Ø¯ÙŠÙ„';
              editBtn.onclick = function(e) {
                e.stopPropagation();
                openEditPopup(doc.id, msg.text);
                optionsPanel.style.display = 'none';
              };
              const deleteBtn = document.createElement('button');
              deleteBtn.textContent = 'Ø­Ø°Ù';
              deleteBtn.onclick = function(e) {
                e.stopPropagation();
                deleteMessage(doc.id);
                optionsPanel.style.display = 'none';
              };
              optionsPanel.appendChild(editBtn);
              optionsPanel.appendChild(deleteBtn);
              bubbleDiv.appendChild(optionsPanel);
            }
    
            const emojiIcon = document.createElement('div');
            emojiIcon.className = 'emoji-icon';
            emojiIcon.innerHTML = '<i class="fa-regular fa-face-smile"></i>';
            bubbleDiv.appendChild(emojiIcon);
            emojiIcon.addEventListener('click', function(e) {
              e.stopPropagation();
              selectedMessageForReaction = { id: doc.id, element: messageDiv };
              showEmojiPopupForMessage(messageDiv);
            });
    
            if(msg.reactions) {
              for(let emoji in msg.reactions) {
                let users = msg.reactions[emoji];
                let count = users.length;
                const reactionSpan = document.createElement('span');
                reactionSpan.className = 'reaction';
                reactionSpan.textContent = emoji + (count > 1 ? " " + count : "");
                reactionSpan.addEventListener('click', function(e) {
                  e.stopPropagation();
                  if(!users.includes(currentUser.id)) {
                    let newUsers = [...users, currentUser.id];
                    db.collection('groups').doc(currentGroup).collection('messages').doc(doc.id).update({
                      [`reactions.${emoji}`]: newUsers
                    });
                  }
                });
                reactionSpan.addEventListener('mousedown', function(e) {
                  let pressTimer = setTimeout(() => {
                    if(users.includes(currentUser.id)) {
                      let newUsers = users.filter(id => id !== currentUser.id);
                      let updateObj = {};
                      if(newUsers.length > 0) {
                        updateObj[`reactions.${emoji}`] = newUsers;
                      } else {
                        updateObj[`reactions.${emoji}`] = firebase.firestore.FieldValue.delete();
                      }
                      db.collection('groups').doc(currentGroup).collection('messages').doc(doc.id).update(updateObj);
                    }
                  }, 800);
                  reactionSpan.addEventListener('mouseup', function(e) {
                    clearTimeout(pressTimer);
                  });
                });
                bubbleDiv.appendChild(reactionSpan);
              }
            }
    
            messagesContainer.appendChild(messageDiv);
          });
          messagesContainer.scrollTop = messagesContainer.scrollHeight;
        });
    }
    
    // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø¹Ø§Ù…Ø© Ù…Ø¹ Ø¯Ø¹Ù… Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø±Ø§Ø¨Ø·
    function sendMessage() {
      const input = document.getElementById('message-input');
      const text = input.value.trim();
      if(!text) return;
      const messageData = {
        text: text,
        senderId: currentUser.id,
        senderName: currentUser.name,
        senderPhoto: currentUser.photoURL || defaultProfileImage,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
        
      };
      const urls = extractURLs(text);
      if(urls && urls.length > 0) {
        getLinkPreview(urls[0]).then(previewData => {
          if(previewData) {
            messageData.linkPreview = previewData;
          }
          db.collection('groups').doc(currentGroup).collection('messages').add(messageData)
            .then(() => {
              input.value = "";
            }).catch(err => console.error("Error sending message:", err));
        });
      } else {
        db.collection('groups').doc(currentGroup).collection('messages').add(messageData)
          .then(() => {
            input.value = "";
          }).catch(err => console.error("Error sending message:", err));
      }
    }
   
    
    function enterGroup(groupId) {
      currentGroup = groupId;
      localStorage.setItem('lastGroup', groupId);
      loadMessages();
      loadGroups();
    }
    
    function populateRoomsPopup() {
      const container = document.getElementById('rooms-grid');
      container.innerHTML = "";
      db.collection('groups').orderBy('createdAt').get().then(snapshot => {
        snapshot.forEach(doc => {
          const data = doc.data();
          const roomCard = document.createElement('div');
          roomCard.className = 'room-card';
          if(data.image && data.image.trim() !== "") {
            const img = document.createElement('img');
            img.src = data.image;
            img.alt = data.name;
            roomCard.appendChild(img);
          } else {
            const div = document.createElement('div');
            div.style.fontSize = '24px';
            div.style.color = '#fff';
            div.textContent = data.name.charAt(0).toUpperCase();
            roomCard.appendChild(div);
          }
          const span = document.createElement('span');
          span.textContent = data.name;
          roomCard.appendChild(span);
          roomCard.addEventListener('click', function() {
            enterGroup(doc.id);
            toggleRoomsPopup();
          });
          container.appendChild(roomCard);
        });
      });
    }
    
    function deleteMessage(messageId) {
      if(confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø©ØŸ")) {
        db.collection('groups').doc(currentGroup).collection('messages').doc(messageId).delete();
      }
    }
    
    function openEditPopup(messageId, currentText) {
      editingMessageId = messageId;
      document.getElementById('edit-message-input').value = currentText;
      document.getElementById('edit-message-popup').style.display = 'block';
    }
    function closeEditPopup() {
      editingMessageId = null;
      document.getElementById('edit-message-popup').style.display = 'none';
    }
    
    function updateMessage() {
      const newText = document.getElementById('edit-message-input').value.trim();
      if(!newText) {
        alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù†Øµ Ø§Ù„Ø±Ø³Ø§Ù„Ø©");
        return;
      }
      if(editingMessageId) {
        db.collection('groups').doc(currentGroup).collection('messages').doc(editingMessageId).update({
          text: newText,
          edited: true,
          editTimestamp: firebase.firestore.FieldValue.serverTimestamp()
        }).then(() => {
          alert("ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­");
          closeEditPopup();
        }).catch(err => console.error("Error updating message:", err));
      }
    }
    
    function deleteEditedMessage() {
      if(confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø©ØŸ")) {
        db.collection('groups').doc(currentGroup).collection('messages').doc(editingMessageId).delete()
          .then(() => {
            alert("ØªÙ… Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø©");
            closeEditPopup();
          })
          .catch(err => console.error("Error deleting message:", err));
      }
    }
    
    function showSettingsPopup() {
      document.getElementById('settings-popup').style.display = 'block';
    }
    function closeSettingsPopup() {
      document.getElementById('settings-popup').style.display = 'none';
    }
    function openCreateGroupPopup() {
      document.getElementById('create-group-popup').style.display = 'block';
    }
    function closeCreateGroupPopup() {
      document.getElementById('create-group-popup').style.display = 'none';
    }
    function closeGroupOptionsPopup() {
      document.getElementById('group-options-popup').style.display = 'none';
    }
    
    document.getElementById('delete-group-btn').addEventListener('click', function() {
      if(confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©ØŸ")) {
        db.collection('groups').doc(selectedGroupId).delete()
          .then(() => {
            closeGroupOptionsPopup();
            if(currentGroup === selectedGroupId) {
              currentGroup = 'general';
              loadMessages();
            }
          })
          .catch(err => console.error("Error deleting group:", err));
      }
    });
    
    document.getElementById('edit-group-btn').addEventListener('click', function() {
      closeGroupOptionsPopup();
      document.getElementById('edit-group-name').value = selectedGroupData.name;
      document.getElementById('edit-group-image').value = selectedGroupData.image || "";
      document.getElementById('edit-group-popup').style.display = 'block';
    });
    
    function closeEditGroupPopup() {
      document.getElementById('edit-group-popup').style.display = 'none';
    }
    
    function saveGroupEdits() {
      const newName = document.getElementById('edit-group-name').value.trim();
      const newImage = document.getElementById('edit-group-image').value.trim();
      if(!newName) {
        alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©");
        return;
      }
      db.collection('groups').doc(selectedGroupId).update({
        name: newName,
        image: newImage || ''
      }).then(() => {
        closeEditGroupPopup();
      }).catch(err => console.error("Error updating group:", err));
    }
    
    function changeName() {
      const newName = document.getElementById('new-name').value.trim();
      if(newName) {
        currentUser.name = newName;
        db.collection('users').doc(currentUser.id).update({ name: newName });
        alert("ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ø§Ø³Ù… Ø¨Ù†Ø¬Ø§Ø­!");
        document.getElementById('change-name-popup').style.display = 'none';
        document.getElementById('settings-popup').style.display = 'block';
      } else {
        alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø¬Ø¯ÙŠØ¯");
      }
    }
    
    document.getElementById('toggle-dark-mode').addEventListener('click', function() {
      if(document.body.classList.contains('dark-mode')) {
        document.body.classList.remove('dark-mode');
        localStorage.setItem('mode', 'light');
        this.textContent = 'Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¯Ø§ÙƒÙ†';
      } else {
        document.body.classList.add('dark-mode');
        localStorage.setItem('mode', 'dark');
        this.textContent = 'Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„ÙØ§ØªØ­';
      }
    });
    
    document.getElementById('change-bg-btn').addEventListener('click', function() {
      document.getElementById('settings-popup').style.display = 'none';
      document.getElementById('background-popup').style.display = 'block';
    });
    
    document.getElementById('apply-bg-btn').addEventListener('click', function() {
      if(!selectedBg) {
        alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø®Ù„ÙÙŠØ©");
        return;
      }
      document.querySelectorAll('.chat-area').forEach(elem => {
        elem.style.backgroundImage = `url(${selectedBg})`;
      });
      localStorage.setItem('chatBackground', selectedBg);
      alert("ØªÙ… ØªØºÙŠÙŠØ± Ø®Ù„ÙÙŠØ© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø¨Ù†Ø¬Ø§Ø­");
      document.getElementById('background-popup').style.display = 'none';
      document.getElementById('settings-popup').style.display = 'block';
    });
    
    document.getElementById('logout-btn').addEventListener('click', function() {
      firebase.auth().signOut().then(() => {
        window.location.href = 'login.html';
      }).catch(err => alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬: " + err.message));
    });
    
    function closeChangeNamePopup() {
      document.getElementById('change-name-popup').style.display = 'none';
      document.getElementById('settings-popup').style.display = 'block';
    }
    
    document.getElementById('change-name-btn').addEventListener('click', function() {
      document.getElementById('change-name-popup').style.display = 'block';
      document.getElementById('settings-popup').style.display = 'none';
    });
    
    function closeBackgroundPopup() {
      document.getElementById('background-popup').style.display = 'none';
      document.getElementById('settings-popup').style.display = 'block';
    }
    
    // Ø¹Ø±Ø¶ Ù†Ø§ÙØ°Ø© Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©
    function showGroupOptionsPopup(groupId, data) {
      selectedGroupId = groupId;
      selectedGroupData = data;
      document.getElementById('group-options-popup').style.display = 'block';
    }
    
    // Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ
    function showEmojiPopupForMessage(messageElement) {
      const popup = document.getElementById('emoji-popup');
      popup.style.display = 'block';
      const rect = messageElement.getBoundingClientRect();
      const popupWidth = popup.offsetWidth;
      const left = rect.left + rect.width / 2 - popupWidth / 2;
      const top = rect.bottom + 10;
      popup.style.left = left + 'px';
      popup.style.top = top + 'px';
    }
    
    function hideEmojiPopup() {
      document.getElementById('emoji-popup').style.display = 'none';
    }
    
    document.querySelectorAll('#emoji-popup .emoji-option').forEach(emoji => {
      emoji.addEventListener('click', function(e) {
        const selectedEmoji = this.textContent;
        if(selectedMessageForReaction && selectedMessageForReaction.element) {
          db.collection('groups').doc(currentGroup).collection('messages').doc(selectedMessageForReaction.id).get().then(docSnapshot => {
            let msgData = docSnapshot.data();
            let reactions = msgData.reactions || {};
            let users = reactions[selectedEmoji] || [];
            if(!users.includes(currentUser.id)) {
              users.push(currentUser.id);
              let updateObj = {};
              updateObj[`reactions.${selectedEmoji}`] = users;
              db.collection('groups').doc(currentGroup).collection('messages').doc(selectedMessageForReaction.id).update(updateObj);
            }
          });
        }
        hideEmojiPopup();
        e.stopPropagation();
      });
    });
    
    document.addEventListener('click', function(e) {
      const popup = document.getElementById('emoji-popup');
      if(popup.style.display === 'block' && !popup.contains(e.target)) {
        hideEmojiPopup();
      }
    });
    
    // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù…ÙˆØ¹Ø©
    function createGroup() {
      const groupName = document.getElementById('group-name').value.trim();
      const groupImage = document.getElementById('group-image').value.trim();
      if(!groupName) {
        alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©");
        return;
      }
      db.collection('groups').where("creatorId", "==", currentUser.id).get()
        .then(snapshot => {
          if(snapshot.size >= 10) {
            alert("Ù„Ù‚Ø¯ Ø£Ù†Ø´Ø£Øª 10 Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ø¨Ø§Ù„ÙØ¹Ù„ ÙˆÙ„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø²ÙŠØ¯.");
            return;
          }
          db.collection('groups').add({
            name: groupName,
            image: groupImage || '',
            creatorId: currentUser.id,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          }).then(() => {
            alert("ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø¨Ù†Ø¬Ø§Ø­");
            closeCreateGroupPopup();
          }).catch(err => console.error("Error creating group:", err));
        })
        .catch(err => console.error("Error checking group count:", err));
    }
    
    // ØªÙ‡ÙŠØ¦Ø© Ø¨Ø¹Ø¶ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
    document.addEventListener("DOMContentLoaded", function() {
      const mode = localStorage.getItem('mode');
      if(mode === 'dark') {
        document.body.classList.add('dark-mode');
        document.getElementById('toggle-dark-mode').textContent = 'Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„ÙØ§ØªØ­';
      } else {
        document.body.classList.remove('dark-mode');
        document.getElementById('toggle-dark-mode').textContent = 'Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¯Ø§ÙƒÙ†';
      }
      const chatBg = localStorage.getItem('chatBackground');
      if(chatBg) {
        document.querySelectorAll('.chat-area').forEach(elem => {
          elem.style.backgroundImage = `url(${chatBg})`;
        });
      }
      const containerBg = document.getElementById('background-options-container');
      for(let i = 1; i <= 100; i++) {
        const img = document.createElement('img');
        img.src = `https://picsum.photos/seed/${i}/1000/600`;
        img.alt = `Ø®Ù„ÙÙŠØ© ${i}`;
        img.className = 'bg-option';
        img.setAttribute('data-bg', `https://picsum.photos/seed/${i}/1000/600`);
        img.style.width = '100px';
        img.style.height = '100px';
        img.style.objectFit = 'cover';
        img.style.cursor = 'pointer';
        img.style.border = '2px solid transparent';
        img.style.borderRadius = '8px';
        img.addEventListener('click', function() {
          document.querySelectorAll('.bg-option').forEach(i => i.classList.remove('selected'));
          this.classList.add('selected');
          selectedBg = this.getAttribute('data-bg');
        });
        containerBg.appendChild(img);
      }
    });
    
    function toggleRoomsPopup() {
      const popup = document.getElementById('rooms-popup');
      popup.style.display = (popup.style.display === 'block') ? 'none' : 'block';
      if(popup.style.display === 'block'){
        populateRoomsPopup();
      }
    }
    
    // --- Ù…ÙŠØ²Ø© ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø¯ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ØºÙŠØ± Ø§Ù„Ù…Ù‚Ø±ÙˆØ¡Ø© ---
    db.collectionGroup('messages')
      .where('read', '==', false)
      .where('chatParticipants', 'array-contains', currentUser ? currentUser.id : '')
      .where('senderId', '!=', currentUser ? currentUser.id : '')
      .onSnapshot(snapshot => {
         const badge = document.getElementById('private-badge');
         const count = snapshot.size;
         if(count > 0) {
           badge.style.display = 'inline-block';
           badge.textContent = count;
         } else {
           badge.style.display = 'none';
         }
      });
    let unsubscribeUnread;
    function updateUnreadListener() {
      if(unsubscribeUnread) unsubscribeUnread();
      if(!currentUser) return;
      unsubscribeUnread = db.collectionGroup('messages')
        .where('read', '==', false)
        .where('chatParticipants', 'array-contains', currentUser.id)
        .where('senderId', '!=', currentUser.id)
        .onSnapshot(snapshot => {
           const badge = document.getElementById('private-badge');
           const count = snapshot.size;
           if(count > 0) {
             badge.style.display = 'inline-block';
             badge.textContent = count;
           } else {
             badge.style.display = 'none';
           }
        });
    }
    
    auth.onAuthStateChanged(user => {
      if(user) {
        updateUnreadListener();
      }
    });
    
    // --- Ù†Ù‡Ø§ÙŠØ© Ù…ÙŠØ²Ø© ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯ ---
    
    // Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø®Ø§ØµØ© - Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
    function togglePrivateMessagesPopup() {
      const popup = document.getElementById('private-messages-popup');
      if(popup.style.display === 'block') {
        popup.style.display = 'none';
      } else {
        popup.style.display = 'block';
        loadPrivateMessages();
      }
    }
    
    function loadPrivateMessages() {
      const listContainer = document.getElementById('private-messages-list');
      listContainer.innerHTML = "";
      db.collection('private_chats').where("participants", "array-contains", currentUser.id)
        .get()
        .then(snapshot => {
          if(snapshot.empty) {
            listContainer.innerHTML = "<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„ Ø®Ø§ØµØ©.</p>";
            return;
          }
          snapshot.forEach(doc => {
            const data = doc.data();
            let otherUserId = data.participants.filter(id => id !== currentUser.id)[0];
            db.collection('users').doc(otherUserId).get().then(userDoc => {
              let userData = userDoc.data();
              const item = document.createElement('div');
              item.className = 'private-message-item';
              item.textContent = userData.name;
              item.onclick = function() {
                openPrivateChat(otherUserId);
                document.getElementById('private-messages-popup').style.display = 'none';
              };
              listContainer.appendChild(item);
            });
          });
        })
        .catch(err => console.error("Error loading private messages:", err));
    }
    
    // Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø®Ø§ØµØ© - Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ø¯Ù…Ø¬Ø©
    function openPrivateChat(userId) {
      closeProfileModal();
      currentPrivateChatUser = userId;
      db.collection('users').doc(userId).get().then(doc => {
        if(doc.exists) {
          let userData = doc.data();
          document.getElementById('private-chat-title').textContent = "Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ù…Ø¹ " + userData.name;
          privateChatId = [currentUser.id, userId].sort().join("_");
          loadPrivateChatMessages();
          document.getElementById('private-chat-popup').style.display = 'block';
          updateChatUserStatus(userId);
          markPrivateChatMessagesAsRead();
        } else {
          alert("Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯");
        }
      }).catch(err => console.error("Error fetching private chat user:", err));
    }
    
    function loadPrivateChatMessages() {
      const chatArea = document.getElementById('private-chat-area');
      db.collection('private_chats').doc(privateChatId).collection('messages')
         .orderBy('timestamp')
         .onSnapshot(snapshot => {
           chatArea.innerHTML = "";
           snapshot.forEach(doc => {
             const msg = doc.data();
             let timeString = "";
             if(msg.timestamp) {
               timeString = new Date(msg.timestamp.toDate()).toLocaleTimeString();
             }
             const messageDiv = document.createElement('div');
             messageDiv.className = 'message ' + (msg.senderId === currentUser.id ? 'sent' : 'received');
    
             const profileImgDiv = document.createElement('div');
             profileImgDiv.className = 'message-profile';
             let senderPhoto = msg.senderPhoto || defaultProfileImage;
             profileImgDiv.style.backgroundImage = 'url(' + senderPhoto + ')';
             profileImgDiv.addEventListener('click', function(e) {
               e.stopPropagation();
               showProfileModal({ id: msg.senderId, name: msg.senderName, photoURL: senderPhoto });
             });
             messageDiv.appendChild(profileImgDiv);
    
             const bubbleDiv = document.createElement('div');
             bubbleDiv.className = 'message-bubble';
             
             // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø±Ø³Ø§Ù„Ø© ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ ØµÙˆØ±Ø©
             if (msg.isImage) {
               bubbleDiv.innerHTML = `<strong>${msg.senderName}:</strong><br>`;
               const imgElement = document.createElement('img');
               imgElement.src = msg.imageUrl;
               imgElement.className = 'thumbnail-image';
               imgElement.onclick = () => openImageModal(msg.imageUrl, msg.text || '');
               bubbleDiv.appendChild(imgElement);
               
               // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ù†ØµØŒ Ø¹Ø±Ø¶Ù‡ Ø£Ø³ÙÙ„ Ø§Ù„ØµÙˆØ±Ø©
               if (msg.text) {
                 const captionDiv = document.createElement('div');
                 captionDiv.className = 'image-caption';
                 captionDiv.textContent = msg.text;
                 bubbleDiv.appendChild(captionDiv);
               }
               
               bubbleDiv.innerHTML += `<div class="message-time">${timeString}</div>`;
             } else {
               bubbleDiv.innerHTML = `<strong>${msg.senderName}:</strong> ${msg.text} <div class="message-time">${timeString}</div>`;
             }
             
             messageDiv.appendChild(bubbleDiv);
    
             if(msg.senderId === currentUser.id) {
               const optionsIcon = document.createElement('div');
               optionsIcon.className = 'options-icon';
               optionsIcon.innerHTML = '<i class="fa-solid fa-ellipsis-h"></i>';
               bubbleDiv.appendChild(optionsIcon);
               bubbleDiv.addEventListener('click', function(e) {
                 e.stopPropagation();
                 let panel = bubbleDiv.querySelector('.options-panel');
                 if(panel) {
                   panel.style.display = (panel.style.display === 'block') ? 'none' : 'block';
                 }
               });
    
               const optionsPanel = document.createElement('div');
               optionsPanel.className = 'options-panel';
               const editBtn = document.createElement('button');
               editBtn.textContent = 'ØªØ¹Ø¯ÙŠÙ„';
               editBtn.onclick = function(e) {
                 e.stopPropagation();
                 openPrivateEditPopup(doc.id, msg.text);
                 optionsPanel.style.display = 'none';
               };
               const deleteBtn = document.createElement('button');
               deleteBtn.textContent = 'Ø­Ø°Ù';
               deleteBtn.onclick = function(e) {
                 e.stopPropagation();
                 deletePrivateMessage(doc.id);
                 optionsPanel.style.display = 'none';
               };
               optionsPanel.appendChild(editBtn);
               optionsPanel.appendChild(deleteBtn);
               bubbleDiv.appendChild(optionsPanel);
             }
    
             chatArea.appendChild(messageDiv);
           });
           chatArea.scrollTop = chatArea.scrollHeight;
         }, err => console.error("Error loading private chat messages:", err));
    }
    
    function sendPrivateMessage() {
      const input = document.getElementById('private-message-input');
      const text = input.value.trim();
      if(!text) return;
      const messageData = {
        text: text,
        senderId: currentUser.id,
        senderName: currentUser.name,
        senderPhoto: currentUser.photoURL || defaultProfileImage,
        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
        read: false,
        chatParticipants: [currentUser.id, currentPrivateChatUser]
      };
      const urls = extractURLs(text);
      if(urls && urls.length > 0){
        getLinkPreview(urls[0]).then(previewData => {
          if(previewData){
            messageData.linkPreview = previewData;
          }
          db.collection('private_chats').doc(privateChatId).set({
            participants: [currentUser.id, currentPrivateChatUser]
          }, { merge: true })
          .then(() => {
            return db.collection('private_chats').doc(privateChatId).collection('messages').add(messageData);
          })
          .then(() => {
            input.value = "";
          })
          .catch(err => console.error("Error sending private message:", err));
        });
      } else {
        db.collection('private_chats').doc(privateChatId).set({
          participants: [currentUser.id, currentPrivateChatUser]
        }, { merge: true })
        .then(() => {
          return db.collection('private_chats').doc(privateChatId).collection('messages').add(messageData);
        })
        .then(() => {
          input.value = "";
        })
        .catch(err => console.error("Error sending private message:", err));
      }
    }
    
    function closePrivateChatPopup() {
      document.getElementById('private-chat-popup').style.display = 'none';
      currentPrivateChatUser = null;
      privateChatId = null;
    }
    
    function markPrivateChatMessagesAsRead() {
      db.collection('private_chats').doc(privateChatId).collection('messages')
        .where('senderId', '!=', currentUser.id)
        .where('read', '==', false)
        .get().then(snapshot => {
          snapshot.forEach(doc => {
            doc.ref.update({ read: true });
          });
        });
    }
    
    // ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø®Ø§ØµØ©
    function openPrivateEditPopup(messageId, currentText) {
      editingPrivateMessageId = messageId;
      document.getElementById('edit-private-message-input').value = currentText;
      document.getElementById('edit-private-message-popup').style.display = 'block';
    }
    function closePrivateEditPopup() {
      editingPrivateMessageId = null;
      document.getElementById('edit-private-message-popup').style.display = 'none';
    }
    function updatePrivateMessage() {
      const newText = document.getElementById('edit-private-message-input').value.trim();
      if(!newText) {
        alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù†Øµ Ø§Ù„Ø±Ø³Ø§Ù„Ø©");
        return;
      }
      if(editingPrivateMessageId) {
        db.collection('private_chats').doc(privateChatId).collection('messages').doc(editingPrivateMessageId).update({
          text: newText,
          edited: true,
          editTimestamp: firebase.firestore.FieldValue.serverTimestamp()
        }).then(() => {
          alert("ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­");
          closePrivateEditPopup();
        }).catch(err => console.error("Error updating private message:", err));
      }
    }
    function deletePrivateMessage(messageId) {
      if(confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø©ØŸ")) {
        db.collection('private_chats').doc(privateChatId).collection('messages').doc(messageId).delete()
          .then(() => {
            alert("ØªÙ… Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø©");
          })
          .catch(err => console.error("Error deleting private message:", err));
      }
    }
    
    // ØµÙØ­Ø© Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ
    function showProfileModal(user) {
      const modalBody = document.getElementById('profile-modal-body');
      modalBody.innerHTML = "";
      if(user.id === currentUser.id) {
        modalBody.innerHTML = `
          <h2>Ù…Ù„ÙÙŠ Ø§Ù„Ø´Ø®ØµÙŠ</h2>
          <img src="${currentUser.photoURL || defaultProfileImage}" style="width:120px;height:120px;border-radius:50%;object-fit:cover;margin:0 auto;display:block;">
          <p style="font-size:20px;font-weight:bold;margin-top:15px;">${currentUser.name}</p>
          <p style="font-size:16px;color:#555;">${currentUser.description || "Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ"}</p>
          ${ currentUser.username ? `<p style="font-size:16px;color:#555;">Ø§Ù„Ù…Ø¹Ø±Ù: @${currentUser.username}</p>` : '' }
          <button onclick="openProfileEdit()" style="margin-top:20px;">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</button>
          <button onclick="closeProfileModal()" style="margin-top:10px;background:#dc3545;">Ø¥ØºÙ„Ø§Ù‚</button>
        `;
        getUserStatus(currentUser.id);
      } else {
        db.collection('users').doc(user.id).get().then(doc => {
          let data = doc.exists ? doc.data() : {
              name: user.name,
              description: "Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ",
              createdAt: "ØºÙŠØ± Ù…ØªØ§Ø­",
              photoURL: user.photoURL || defaultProfileImage
            };
          modalBody.innerHTML = `
            <h2>${data.name}</h2>
            <img src="${data.photoURL || defaultProfileImage}" style="width:120px;height:120px;border-radius:50%;object-fit:cover;margin:0 auto;display:block;">
            <p style="font-size:16px;color:#555;">${data.description || "Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ"}</p>
            <p style="font-size:14px;color:#999;">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡: ${data.createdAt ? new Date(data.createdAt).toLocaleDateString() : "ØºÙŠØ± Ù…ØªØ§Ø­"}</p>
            <button onclick="openPrivateChat('${data.id}')" style="margin-top:20px;">Ø±Ø³Ø§Ù„Ø© Ø®Ø§ØµØ©</button>
            <button onclick="closeProfileModal()" style="margin-top:10px;background:#dc3545;">Ø¥ØºÙ„Ø§Ù‚</button>
          `;
          // Ø¹Ø±Ø¶ Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
          const statusElement = document.createElement('p');
          statusElement.id = 'user-status';
          statusElement.className = 'user-status-indicator';
          if (data.status === "online") {
            statusElement.innerText = "Ù…ØªØµÙ„ Ø§Ù„Ø¢Ù†";
            statusElement.className = "user-status-indicator status-online";
          } else {
            const lastSeenText = formatLastSeen(data.lastSeen);
            statusElement.innerText = lastSeenText;
            statusElement.className = "user-status-indicator status-offline";
          }
          modalBody.appendChild(statusElement);
        });
      }
      document.getElementById('profile-modal').style.display = 'block';
    }
      
    function closeProfileModal() {
      document.getElementById('profile-modal').style.display = 'none';
    }
    
    // ØªØ­Ø±ÙŠØ± Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù†Ø§ÙØ°Ø©
    function openProfileEdit() {
      const modalBody = document.getElementById('profile-modal-body');
      modalBody.innerHTML = `
        <h2>ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</h2>
        <img src="${currentUser.photoURL || defaultProfileImage}" id="edit-profile-pic" style="width:120px;height:120px;border-radius:50%;object-fit:cover;margin:0 auto;display:block;">
        <input type="file" id="edit-profile-photo-file" accept="image/*" style="display:none;">
        <button id="upload-profile-photo-btn" style="margin-top:10px;background:#4CAF50;color:white;border:none;padding:8px;border-radius:5px;">Ø§Ø®ØªØ± ØµÙˆØ±Ø©</button>
        <input type="text" id="edit-profile-name" value="${currentUser.name}" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ" style="width:100%;padding:10px;margin-top:15px;">
        <textarea id="edit-profile-description" placeholder="Ø£Ø¯Ø®Ù„ ÙˆØµÙ Ø­Ø³Ø§Ø¨Ùƒ" style="width:100%;padding:10px;margin-top:10px;">${currentUser.description || ''}</textarea>
        <input type="text" id="edit-profile-username" value="${currentUser.username || ''}" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¹Ø±Ù (username)" style="width:100%;padding:10px;margin-top:10px;">
        <button onclick="saveProfileEdit()" style="margin-top:15px;">Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
        <button onclick="showProfileModal(currentUser)" style="margin-top:10px;background:#dc3545;">Ø¥Ù„ØºØ§Ø¡</button>
      `;

      // Ø¥Ø¶Ø§ÙØ© Ø­Ø¯Ø« Ù„Ø²Ø± Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØµÙˆØ±Ø©
      document.getElementById('upload-profile-photo-btn').addEventListener('click', function() {
        document.getElementById('edit-profile-photo-file').click();
      });

      // Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ±Ø©ØŒ Ù†Ø¹Ø±Ø¶ Ù…Ø¹Ø§ÙŠÙ†Ø©
      document.getElementById('edit-profile-photo-file').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function(e) {
            document.getElementById('edit-profile-pic').src = e.target.result;
          };
          reader.readAsDataURL(file);
        }
      });
    }
    
    // Ø¯Ø§Ù„Ø© Ù„Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© Ø¥Ù„Ù‰ Backendless
    async function uploadProfileImageToBackendless(file) {
      // Ø¹Ø±Ø¶ Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„
      document.getElementById('upload-indicator-container').style.display = 'flex';
      
      const formData = new FormData();
      formData.append('file', file);
      formData.append('fileName', file.name);
      
      try {
        const response = await fetch(`https://api.backendless.com/${BACKENDLESS_APP_ID}/${BACKENDLESS_API_KEY}/files/${file.name}`, {
          method: 'POST',
          body: formData
        });
        
        if (!response.ok) {
          throw new Error('ÙØ´Ù„ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©');
        }
        
        const result = await response.json();
        return result.fileURL;
        
      } catch (error) {
        console.error('Error uploading image:', error);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©: ' + error.message);
        return null;
      } finally {
        // Ø¥Ø®ÙØ§Ø¡ Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„
        document.getElementById('upload-indicator-container').style.display = 'none';
      }
    }
    
    async function saveProfileEdit() {
      const newName = document.getElementById('edit-profile-name').value.trim();
      const newDesc = document.getElementById('edit-profile-description').value.trim();
      const newUsername = document.getElementById('edit-profile-username').value.trim();
      const fileInput = document.getElementById('edit-profile-photo-file');
      let newPhoto = currentUser.photoURL; // Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø§ÙØªØ±Ø§Ø¶ÙŠÙ‹Ø§

      if (newName === '') {
        alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù…");
        return;
      }

      // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ù…Ù„Ù Ù…Ø­Ø¯Ø¯ØŒ Ù†Ø±ÙØ¹Ù‡ Ø¥Ù„Ù‰ Backendless
      if (fileInput.files.length > 0) {
        const file = fileInput.files[0];
        const imageUrl = await uploadProfileImageToBackendless(file);
        if (imageUrl) {
          newPhoto = imageUrl;
        } else {
          alert("ÙØ´Ù„ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©. Ø³ÙŠØªÙ… Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©.");
        }
      }

      db.collection('users').doc(currentUser.id).update({
        name: newName,
        description: newDesc,
        photoURL: newPhoto,
        username: newUsername
      }).then(() => {
        currentUser.name = newName;
        currentUser.description = newDesc;
        currentUser.photoURL = newPhoto;
        currentUser.username = newUsername;
        alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª");
        showProfileModal(currentUser);
      }).catch(err => console.error("Error updating profile:", err));
    }
    
    // Ø²Ø± ÙØªØ­ Ù†Ø§ÙØ°Ø© ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ Ù…Ù† Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ
    function openProfilePopup() {
      openProfileEdit();
      document.getElementById('profile-modal').style.display = 'block';
    }
    
    /* ==========================
       Ù…ÙŠØ²Ø© Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„ØµÙˆØ± Ù…Ø¹ Ø§Ù„Ù†ØµÙˆØµ
       ========================== */
    
    // ØªÙ‡ÙŠØ¦Ø© Ø²Ø± Ø¥Ø±ÙØ§Ù‚ Ø§Ù„ØµÙˆØ±Ø©
    document.getElementById('attach-image-btn').addEventListener('click', function() {
      document.getElementById('image-upload').click();
    });
    
    document.getElementById('image-upload').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (file) {
        currentImageToSend = file;
        isPrivateImage = false;
        document.getElementById('image-caption-input').value = "";
        document.getElementById('image-caption-popup').style.display = 'block';
      }
    });
    
    // ØªÙ‡ÙŠØ¦Ø© Ø²Ø± Ø¥Ø±ÙØ§Ù‚ Ø§Ù„ØµÙˆØ±Ø© Ù„Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø®Ø§ØµØ©
    document.getElementById('private-attach-image-btn').addEventListener('click', function() {
      document.getElementById('private-image-upload').click();
    });
    
    document.getElementById('private-image-upload').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (file) {
        currentImageToSend = file;
        isPrivateImage = true;
        document.getElementById('image-caption-input').value = "";
        document.getElementById('image-caption-popup').style.display = 'block';
      }
    });
    
    // Ø¯Ø§Ù„Ø© Ù„Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© Ø¥Ù„Ù‰ Backendless
    async function uploadImageToBackendless(file) {
      // Ø¹Ø±Ø¶ Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„
      document.getElementById('upload-indicator-container').style.display = 'flex';
      
      const formData = new FormData();
      formData.append('file', file);
      formData.append('fileName', file.name);
      
      try {
        const response = await fetch(`https://api.backendless.com/${BACKENDLESS_APP_ID}/${BACKENDLESS_API_KEY}/files/${file.name}`, {
          method: 'POST',
          body: formData
        });
        
        if (!response.ok) {
          throw new Error('ÙØ´Ù„ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©');
        }
        
        const result = await response.json();
        return result.fileURL;
        
      } catch (error) {
        console.error('Error uploading image:', error);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©: ' + error.message);
        return null;
      } finally {
        // Ø¥Ø®ÙØ§Ø¡ Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„
        document.getElementById('upload-indicator-container').style.display = 'none';
      }
    }
    
    // Ø¥Ø±Ø³Ø§Ù„ ØµÙˆØ±Ø© Ù…Ø¹ Ù†Øµ Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©
    async function sendGroupImageMessage(imageUrl, caption) {
      const messageData = {
        isImage: true,
        imageUrl: imageUrl,
        text: caption || '',
        senderId: currentUser.id,
        senderName: currentUser.name,
        senderPhoto: currentUser.photoURL || defaultProfileImage,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      };
      
      await db.collection('groups').doc(currentGroup).collection('messages').add(messageData);
    }
    
    // Ø¥Ø±Ø³Ø§Ù„ ØµÙˆØ±Ø© Ù…Ø¹ Ù†Øµ Ø¥Ù„Ù‰ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø®Ø§ØµØ©
    async function sendPrivateImageMessage(imageUrl, caption) {
      if (!privateChatId) return;
      
      const messageData = {
        isImage: true,
        imageUrl: imageUrl,
        text: caption || '',
        senderId: currentUser.id,
        senderName: currentUser.name,
        senderPhoto: currentUser.photoURL || defaultProfileImage,
        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
        read: false,
        chatParticipants: [currentUser.id, currentPrivateChatUser]
      };
      
      await db.collection('private_chats').doc(privateChatId).set({
        participants: [currentUser.id, currentPrivateChatUser]
      }, { merge: true });
      
      await db.collection('private_chats').doc(privateChatId).collection('messages').add(messageData);
    }
    
    // ÙØªØ­ Ø§Ù„ØµÙˆØ±Ø© ÙÙŠ Ù†Ø§ÙØ°Ø© ÙƒØ§Ù…Ù„Ø© Ù…Ø¹ Ø§Ù„Ù†Øµ
    function openImageModal(imageUrl, caption = '') {
      const modal = document.getElementById('image-modal');
      const fullSizeImage = document.getElementById('full-size-image');
      const imageCaption = document.getElementById('full-image-caption');
      fullSizeImage.src = imageUrl;
      imageCaption.textContent = caption;
      modal.style.display = 'block';
    }
    
    // Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© Ø§Ù„ØµÙˆØ±Ø©
    document.getElementById('close-image-modal').addEventListener('click', function() {
      document.getElementById('image-modal').style.display = 'none';
    });
    
    // Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© Ø§Ù„ØµÙˆØ±Ø© Ø¨Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬Ù‡Ø§
    document.getElementById('image-modal').addEventListener('click', function(e) {
      if (e.target === this) {
        this.style.display = 'none';
      }
    });
    
    // Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© Ø¥Ø¶Ø§ÙØ© Ù†Øµ Ù„Ù„ØµÙˆØ±Ø©
    function closeImageCaptionPopup() {
      document.getElementById('image-caption-popup').style.display = 'none';
      currentImageToSend = null;
    }
    
    // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØµÙˆØ±Ø© Ù…Ø¹ Ø§Ù„Ù†Øµ
    async function sendImageWithCaption() {
      if (!currentImageToSend) return;
      
      const caption = document.getElementById('image-caption-input').value.trim();
      const imageUrl = await uploadImageToBackendless(currentImageToSend);
      
      if (imageUrl) {
        if (isPrivateImage) {
          await sendPrivateImageMessage(imageUrl, caption);
        } else {
          await sendGroupImageMessage(imageUrl, caption);
        }
        closeImageCaptionPopup();
      }
    }
    
    // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
    document.addEventListener("DOMContentLoaded", function() {
      // Ø¥Ø¶Ø§ÙØ© Ø­Ø¯Ø« Ù„Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© Ø§Ù„ØµÙˆØ±Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Esc
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
          document.getElementById('image-modal').style.display = 'none';
        }
      });
    });
  </script>
</body>
</html>
