<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>واجهة المكالمات</title>

  <!-- خطوط وأيقونات -->
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>

  <style>
    * { box-sizing: border-box; margin:0; padding:0; }
    body {
      font-family: 'Tajawal', sans-serif;
      background: #f0f2f5;
      color: #333;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    header {
      background: #4267B2;
      color: #fff;
      padding: 10px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    header h1 { font-size: 1.5rem; }
    header button {
      background: none; border: none; color: #fff;
      font-size: 1rem; cursor: pointer;
    }

    .users-container {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      padding: 20px;
      justify-content: center;
    }
    .user-card {
      background-color: #ffffff;
      border-radius: 20px;
      padding: 10px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 280px;
      cursor: pointer;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      transition: transform 0.2s;
    }
    .user-card:hover {
      transform: scale(1.03);
    }
    .user-name {
      font-weight: bold;
      font-size: 18px;
    }
    .user-image {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: #ccc;
      overflow: hidden;
      flex-shrink: 0;
    }
    .user-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    /* واجهة الفيديو مخفية في البداية */
    #videos {
      display: none;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
      padding: 20px;
    }
    video {
      width: 45%;
      background: #000;
      border-radius: 10px;
    }

    /* أزرار التحكم مخفية في البداية */
    .call-bar {
      display: none;
      justify-content: center;
      gap: 20px;
      margin-bottom: 30px;
    }
    .call-bar button {
      width: 50px; height: 50px;
      border-radius: 50%;
      border: none;
      font-size: 1.2rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .btn-mute, .btn-video { background: #fff; }
    .btn-hangup { background: #e74c3c; color: #fff; }
  </style>
</head>
<body>

  <header>
    <h1>واجهة المكالمات</h1>
    <button id="logoutBtn"><i class="fa-solid fa-right-from-bracket"></i> خروج</button>
  </header>

  <main>
    <div class="users-container" id="usersContainer"></div>

    <div id="videos">
      <video id="localVideo" autoplay muted playsinline></video>
      <video id="remoteVideo" autoplay playsinline></video>
    </div>

    <div class="call-bar" id="callBar">
      <button class="btn-mute" id="toggleAudio" title="كتم/تشغيل الصوت">
        <i class="fa-solid fa-microphone"></i>
      </button>
      <button class="btn-video" id="toggleVideo" title="إيقاف/تشغيل الكاميرا">
        <i class="fa-solid fa-video"></i>
      </button>
      <button class="btn-hangup" id="hangupBtn" title="إنهاء المكالمة">
        <i class="fa-solid fa-phone-slash"></i>
      </button>
    </div>
  </main>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBwwrBtf6AtW7R36FX4j2GQZVEdJldFq7o",
      authDomain: "you-unblock.firebaseapp.com",
      projectId: "you-unblock",
      storageBucket: "you-unblock.appspot.com",
      messagingSenderId: "306278978440",
      appId: "1:306278978440:web:4ca87c3856e107a30be03d"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db   = firebase.firestore();

    const usersContainer = document.getElementById("usersContainer");
    const videosDiv      = document.getElementById("videos");        // إضافة
    const callBar        = document.getElementById("callBar");      // إضافة
    const localVideo     = document.getElementById("localVideo");
    const remoteVideo    = document.getElementById("remoteVideo");
    const toggleAudio    = document.getElementById("toggleAudio");
    const toggleVideo    = document.getElementById("toggleVideo");
    const hangupBtn      = document.getElementById("hangupBtn");
    const logoutBtn      = document.getElementById("logoutBtn");

    let currentUser, localStream, pc, callDoc, callerCandidates, calleeCandidates;

    logoutBtn.onclick = () => auth.signOut().then(() => location.href = "login.html");

    auth.onAuthStateChanged(user => {
      if (!user) return location.href = 'login.html';
      currentUser = { id: user.uid, name: user.displayName || user.email };
      loadUsers();
      prepareLocalStream();
      listenIncomingCalls();     // إضافة
    });

    function loadUsers() {
      db.collection("users").get().then(snapshot => {
        usersContainer.innerHTML = "";
        snapshot.forEach(doc => {
          if (doc.id === currentUser.id) return;
          const user = doc.data();
          const card = document.createElement("div");
          card.className = "user-card";
          card.onclick = () => startCall(doc.id);

          const name = document.createElement("div");
          name.className = "user-name";
          name.textContent = user.name || "مستخدم";

          const image = document.createElement("div");
          image.className = "user-image";
          if (user.image) {
            image.innerHTML = `<img src="${user.image}" alt="${user.name}">`;
          } else {
            image.innerHTML = `<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;background:#ccc;font-weight:bold;">${(user.name || "؟")[0]}</div>`;
          }

          card.appendChild(name);
          card.appendChild(image);
          usersContainer.appendChild(card);
        });
      });
    }

    async function prepareLocalStream() {
      localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
      localVideo.srcObject = localStream;
    }

    // دالة عرض واجهة المكالمة
    function showCallUI() {
      usersContainer.style.display = 'none';
      videosDiv.style.display      = 'flex';
      callBar.style.display        = 'flex';
    }

    // الاستماع للمكالمات الواردة
    function listenIncomingCalls() {
      db.collection('calls')
        .where('callee','==', currentUser.id)
        .onSnapshot(snap => {
          snap.docChanges().forEach(change => {
            if (change.type === 'added' && !pc) {
              handleIncomingCall(change.doc);
            }
          });
        });
    }

    // التعامل مع مكالمة واردة
    async function handleIncomingCall(doc) {
      showCallUI();    // عرض الواجهة
      const data = doc.data();
      callDoc         = doc.ref;
      callerCandidates = callDoc.collection('callerCandidates');
      calleeCandidates = callDoc.collection('calleeCandidates');
      setupPeerConnection();
      addLocalTracks();
      await pc.setRemoteDescription(new RTCSessionDescription(data.offer));
      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);
      await callDoc.update({ answer });
      exchangeIce();
    }

    async function startCall(peerId) {
      showCallUI();    // عرض الواجهة
      setupPeerConnection();
      addLocalTracks();
      await makeOffer(peerId);
    }

    function setupPeerConnection() {
      pc = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] });
      pc.onicecandidate = e => {
        if (e.candidate) callerCandidates.add(e.candidate.toJSON());
      };
      pc.ontrack = e => {
        remoteVideo.srcObject = e.streams[0];
      };
      callerCandidates = calleeCandidates = null; // تهيئة
      callDoc = db.collection('calls').doc();
      callerCandidates = callDoc.collection('callerCandidates');
      calleeCandidates = callDoc.collection('calleeCandidates');
      subscribeAnswer();
      exchangeIce();
    }

    function addLocalTracks() {
      localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
      localStream && (localVideo.srcObject = localStream);
    }

    async function makeOffer(peerId) {
      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
      await callDoc.set({ caller: currentUser.id, callee: peerId, offer });
    }

    // الاشتراك لإستقبال الـ answer
    function subscribeAnswer() {
      callDoc.onSnapshot(snap => {
        const data = snap.data();
        if (data?.answer && !pc.currentRemoteDescription) {
          pc.setRemoteDescription(new RTCSessionDescription(data.answer));
        }
      });
    }

    // تبادل ICE Candidates
    function exchangeIce() {
      callerCandidates.onSnapshot(snap => {
        snap.docChanges().forEach(c => {
          if (c.type === 'added') pc.addIceCandidate(new RTCIceCandidate(c.doc.data()));
        });
      });
      calleeCandidates.onSnapshot(snap => {
        snap.docChanges().forEach(c => {
          if (c.type === 'added') pc.addIceCandidate(new RTCIceCandidate(c.doc.data()));
        });
      });
    }

    // إنهاء المكالمة
    hangupBtn.onclick = async () => {
      localStream.getTracks().forEach(t => t.stop());
      pc.close();
      for (let col of [callerCandidates, calleeCandidates]) {
        const snap = await col.get();
        snap.forEach(d => d.ref.delete());
      }
      await callDoc.delete();
      location.reload();
    };

    // أزرار التحكم بالصوت والكاميرا
    toggleAudio.onclick = () => {
      const t = localStream.getAudioTracks()[0];
      t.enabled = !t.enabled;
      toggleAudio.innerHTML = t.enabled
        ? '<i class="fa-solid fa-microphone"></i>'
        : '<i class="fa-solid fa-microphone-slash"></i>';
    };
    toggleVideo.onclick = () => {
      const t = localStream.getVideoTracks()[0];
      t.enabled = !t.enabled;
      toggleVideo.innerHTML = t.enabled
        ? '<i class="fa-solid fa-video"></i>'
        : '<i class="fa-solid fa-video-slash"></i>';
    };
  </script>
</body>
</html>
