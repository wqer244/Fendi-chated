<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>فندشات - منصة الدردشة</title>

  <!-- Google Identity Services -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <!-- Firebase (للبريد/كلمة المرور في الكود الحالي) -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    :root{--primary:#6366f1;--secondary:#4f46e5;--error:#ef4444;--background:#f8fafc}
    *{box-sizing:border-box;margin:0;padding:0}
    body{background:linear-gradient(135deg,#f8fafc 0%,#e2e8f0 100%);font-family:'Tajawal',sans-serif;min-height:100vh;display:flex;justify-content:center;align-items:center;padding:20px}
    .auth-container{background:rgba(255,255,255,.95);backdrop-filter:blur(10px);border-radius:20px;box-shadow:0 8px 32px rgba(0,0,0,.1);width:100%;max-width:440px;padding:40px;position:relative}
    .logo{text-align:center;margin-bottom:30px}
    .logo h1{color:var(--primary);font-size:2.2rem;font-weight:700}
    .form-group{margin-bottom:18px}
    .form-input{width:100%;padding:12px 14px;border:2px solid #e2e8f0;border-radius:12px;font-size:16px;background:#fff}
    .form-input:focus{border-color:var(--primary);outline:none;box-shadow:0 0 0 3px rgba(99,102,241,.12)}
    .btn{width:100%;padding:12px;border:none;border-radius:12px;font-size:16px;font-weight:600;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px}
    .btn-primary{background:var(--primary);color:#fff}
    .btn-google{background:#fff;color:#3c4043;border:1px solid #e0e0e0}
    .divider{text-align:center;margin:14px 0;color:#94a3b8}
    .toggle-form{margin-top:16px;text-align:center;color:#64748b}
    .toggle-form a{color:var(--primary);cursor:pointer;text-decoration:none;font-weight:600}
    .loader{width:20px;height:20px;border:3px solid #fff;border-bottom-color:transparent;border-radius:50%;animation:rotation 1s linear infinite;display:none}
    @keyframes rotation{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    .error-message{color:var(--error);font-size:14px;margin-top:8px;display:none;align-items:center;gap:8px}
    @media(max-width:480px){.auth-container{padding:20px;border-radius:14px}}
  </style>
</head>
<body>
  <div id="login-container" class="auth-container">
    <div class="logo"><h1>فندشات</h1></div>

    <form id="login-form" onsubmit="event.preventDefault(); login()">
      <div class="form-group">
        <input id="login-email" class="form-input" type="email" placeholder="البريد الإلكتروني" required>
      </div>
      <div class="form-group">
        <input id="login-password" class="form-input" type="password" placeholder="كلمة المرور" required>
      </div>
      <button id="login-btn" class="btn btn-primary" type="submit">
        <span>تسجيل الدخول</span>
        <div id="login-loader" class="loader"></div>
      </button>
    </form>

    <div id="login-error" class="error-message"><i class="fas fa-exclamation-circle"></i><span></span></div>

    <div class="divider">أو</div>

    <!-- زر Google مخصص (يمكن حذفه لو تريد إزالة التسجيل بالجوجل) -->
    <button class="btn btn-google" id="google-custom-btn" onclick="startGoogleSignIn()">
      <i class="fab fa-google"></i>
      <span>متابعة مع Google</span>
    </button>

    <div class="toggle-form">
      ليس لديك حساب؟ <a onclick="showSignUp()">أنشئ حسابًا الآن</a>
    </div>
  </div>

  <!-- نموذج التسجيل -->
  <div id="signup-container" class="auth-container" style="display:none;margin-top:20px;">
    <div class="logo"><h1>إنشاء حساب جديد</h1></div>
    <form id="signup-form" onsubmit="event.preventDefault(); signUp()">
      <div class="form-group"><input id="signup-name" class="form-input" type="text" placeholder="الاسم الكامل" required></div>
      <div class="form-group"><input id="signup-email" class="form-input" type="email" placeholder="البريد الإلكتروني" required></div>
      <div class="form-group"><input id="signup-password" class="form-input" type="password" placeholder="كلمة المرور" required></div>
      <button id="signup-btn" class="btn btn-primary" type="submit">
        <span>إنشاء حساب</span>
        <div id="signup-loader" class="loader"></div>
      </button>
    </form>
    <div id="signup-error" class="error-message"><i class="fas fa-exclamation-circle"></i><span></span></div>
    <div class="toggle-form">لديك حساب بالفعل؟ <a onclick="showLogin()">سجل الدخول هنا</a></div>
  </div>

  <script>
    /*******************************
     * إعدادات Firebase (استبدل إن لزم)
     *******************************/
    const firebaseConfig = {
      apiKey: "AIzaSyBwwrBtf6AtW7R36FX4j2GQZVEdJldFq7o",
      authDomain: "you-unblock.firebaseapp.com",
      projectId: "you-unblock",
      storageBucket: "you-unblock.appspot.com",
      messagingSenderId: "306278978440",
      appId: "1:306278978440:web:4ca87c3856e107a30be03d"
    };
    // تهيئة Firebase (يبقى موجودًا لاستخدام تسجيل البريد/كلمة المرور)
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();

    // تغيير حالة المصادقة (إذا تم تسجيل الدخول بواسطة أي طريقة نعيد التوجيه)
    auth.onAuthStateChanged(user => {
      if (user) {
        // تم تسجيل الدخول عبر Firebase SDK (بريد/كلمة مرور أو بعد ربط)
        window.location.href = "chat.html";
      }
    });

    /*******************************
     * وظائف عرض/إخفاء النماذج
     *******************************/
    function showSignUp() {
      document.getElementById('login-container').style.display = 'none';
      document.getElementById('signup-container').style.display = 'block';
      clearErrors();
    }
    function showLogin() {
      document.getElementById('signup-container').style.display = 'none';
      document.getElementById('login-container').style.display = 'block';
      clearErrors();
    }

    /*******************************
     * وظائف تسجيل البريد/كلمة المرور (كما في كودك)
     *******************************/
    async function login() {
      const email = document.getElementById('login-email').value.trim();
      const password = document.getElementById('login-password').value.trim();
      const loader = document.getElementById('login-loader');
      const btn = document.getElementById('login-btn');
      const errorDiv = document.getElementById('login-error');

      try {
        btn.disabled = true;
        loader.style.display = 'block';
        clearErrors();
        await auth.signInWithEmailAndPassword(email, password);
        // سيتم إعادة التوجيه بواسطة onAuthStateChanged
      } catch (err) {
        showError(errorDiv, 'خطأ في تسجيل الدخول: ' + (err.message || err));
      } finally {
        btn.disabled = false;
        loader.style.display = 'none';
      }
    }

    async function signUp() {
      const name = document.getElementById('signup-name').value.trim();
      const email = document.getElementById('signup-email').value.trim();
      const password = document.getElementById('signup-password').value.trim();
      const loader = document.getElementById('signup-loader');
      const btn = document.getElementById('signup-btn');
      const errorDiv = document.getElementById('signup-error');

      try {
        btn.disabled = true;
        loader.style.display = 'block';
        clearErrors();
        if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) throw new Error('صيغة البريد الإلكتروني غير صحيحة');
        const userCredential = await auth.createUserWithEmailAndPassword(email, password);
        await userCredential.user.updateProfile({ displayName: name });
        // سيتم إعادة التوجيه بواسطة onAuthStateChanged
      } catch (err) {
        showError(errorDiv, 'خطأ في التسجيل: ' + (err.message || err));
      } finally {
        btn.disabled = false;
        loader.style.display = 'none';
      }
    }

    /*******************************
     * أخطاء ووظائف مساعدة
     *******************************/
    function showError(element, message) {
      element.querySelector('span').textContent = message;
      element.style.display = 'flex';
    }
    function clearErrors() {
      document.querySelectorAll('.error-message').forEach(el => {
        el.style.display = 'none';
        const sp = el.querySelector('span');
        if (sp) sp.textContent = '';
      });
    }

    /*******************************
     * --- جزء Google Identity + إرسال إلى Firebase REST ---
     *  ملاحظة: استبدل GOOGLE_CLIENT_ID بقيمة العميل الخاصة بك
     *******************************/
    const GOOGLE_CLIENT_ID = 'GOOGLE_CLIENT_ID.apps.googleusercontent.com'; // <-- استبدل هنا

    // سيتم تهيئة Google Identity عند تحميل الصفحة
    window.onload = () => {
      if (window.google && google.accounts && google.accounts.id) {
        google.accounts.id.initialize({
          client_id: GOOGLE_CLIENT_ID,
          callback: handleCredentialResponse // سيستقبل الـ ID token هنا
        });
        // لا نرسم زر Google الافتراضي لأن لدينا زر مخصص، لكن يمكن رسمه هكذا إذا رغبت:
        // google.accounts.id.renderButton(document.getElementById("g_id_button"), { theme: "outline", size: "large" });
        // نستخدم prompt/one-tap أو نطلب من المستخدم النقر على زر مخصص ليبدأ التدفق
      } else {
        console.warn('Google Identity library not loaded yet.');
      }
    };

    // عند النقر على زر Google المخصص - يظهر واجهة اختيار حساب Google (one-tap/prompt)
    function startGoogleSignIn() {
      clearErrors();
      // انطلاقًا من Google Identity: نعرض نافذة اختيار الحساب
      // ملاحظة: بعض المتصفحات تمنع النوافذ المنبثقة إذا لم يتم استخدام renderButton،
      // لكن google.accounts.id.prompt() يعرض واجهة one-tap إذا كانت متاحة.
      if (window.google && google.accounts && google.accounts.id) {
        // نستخدم prompt — إذا كان المستخدم قد اختار مسبقًا سيظهر الـ credential فورًا
        google.accounts.id.prompt(notification => {
          // يمكن معالجة الإشعارات هنا إن أردنا (نجاح/رفض)
          // لكن النتيجة النهائية تُعالج في handleCredentialResponse
        });
      } else {
        alert('خطأ: مكتبة Google لم تُحمَّل بعد. حاول إعادة تحميل الصفحة.');
      }
    }

    // هذه الدالة تتلقى كائن الاستجابة من Google Identity (credential = ID token)
    async function handleCredentialResponse(response) {
      // response.credential يحوي ID token (JWT) صادر من Google
      if (!response || !response.credential) {
        showError(document.getElementById('login-error'), 'فشل الحصول على بيانات من Google.');
        return;
      }

      try {
        // عرض تحميل مؤقت
        const googleBtn = document.getElementById('google-custom-btn');
        googleBtn.disabled = true;
        googleBtn.querySelector('span').textContent = 'جارِ المتابعة...';

        const id_token = response.credential;
        const apiKey = firebaseConfig.apiKey;

        // استدعاء REST API الخاص بـ Firebase لتسجيل/تسجيل دخول عبر موفر خارجي (Google)
        const url = `https://identitytoolkit.googleapis.com/v1/accounts:signInWithIdp?key=${apiKey}`;
        const body = {
          postBody: `id_token=${encodeURIComponent(id_token)}&providerId=google.com`,
          requestUri: window.location.href,
          returnIdpCredential: true,
          returnSecureToken: true
        };

        const res = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });

        const data = await res.json();

        if (data && data.error) {
          // رسالة خطأ من Firebase
          throw new Error(data.error.message || JSON.stringify(data.error));
        }

        // النجاح: data يحتوي على idToken (Firebase ID token) و localId و email و displayName ...
        // يمكنك الآن:
        //  - تخزين data.idToken في localStorage/session إذا رغبت
        //  - إعادة التوجيه إلى صفحة الدردشة
        //  - أو ربط أي بيانات أخرى في قاعدة بياناتك

        // مثال: تخزين توكن Firebase (اختياري)
        localStorage.setItem('firebase_id_token', data.idToken);
        localStorage.setItem('user_email', data.email || '');
        // إعادة التوجيه إلى chat.html
        window.location.href = 'chat.html';

      } catch (err) {
        showError(document.getElementById('login-error'), 'خطأ في التسجيل بـ Google: ' + (err.message || err));
      } finally {
        const googleBtn = document.getElementById('google-custom-btn');
        if (googleBtn) {
          googleBtn.disabled = false;
          googleBtn.querySelector('span').textContent = 'متابعة مع Google';
        }
      }
    }

    /*******************************
     * ملاحظات ومميزات هذا الأسلوب:
     * 1) لا يستخدم signInWithPopup من Firebase SDK.
     * 2) تدفق Google يتم بواسطة Google Identity (الحصول على ID token).
     * 3) نرسل الـ ID token إلى Firebase REST endpoint accounts:signInWithIdp
     *    الذي يقوم بإنشاء/تسجيل المستخدم في Firebase Authentication.
     * 4) تحتاج فقط إلى GOOGLE_CLIENT_ID و firebaseConfig.apiKey (الـ apiKey موجود في كودك).
     *
     * إذا أردت حذف زر Google تمامًا: احذف عنصر
     *   <button class="btn btn-google" id="google-custom-btn" ...>...</button>
     * من HTML وسيُحذف خيار Google.
     *******************************/
  </script>
</body>
</html>
