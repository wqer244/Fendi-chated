<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>تطبيق القصص والمنشورات</title>
  <!-- ربط خطوط تاجوال -->
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
  <!-- أيقونات Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" 
        integrity="sha512-pIVz3r+YZIxG8wfsx9NWeoO59V+byy3pY++jZo+iq8zB0QpUP7q90ymY+gnr9dMW+dE9W/jwhCQq+E3Cz/XXRw==" 
        crossorigin="anonymous" referrerpolicy="no-referrer" />
  <!-- مكتبات Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <!-- مكتبة Backendless لنشر الصور -->
  <script src="https://cdn.jsdelivr.net/npm/backendless@7.0.5/dist/backendless.min.js"></script>
  <style>
    :root {
      --primary-color: #0072ff;
      --primary-dark: #005bb5;
      --secondary-color: #28a745;
      --danger-color: #dc3545;
      --bg-color: #f4f7f6;
      --text-color: #333;
      --header-bg: linear-gradient(45deg, #00c6ff, #0072ff);
      --tab-inactive: #e9ecef;
    }
    body.dark-mode {
      --bg-color: #181818;
      --text-color: #e0e0e0;
      --header-bg: linear-gradient(45deg, #333, #111);
      --tab-inactive: #2d2d2d;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'Tajawal', sans-serif;
      background: var(--bg-color);
      color: var(--text-color);
      direction: rtl;
      transition: background 0.3s, color 0.3s;
    }
    header {
      background: var(--header-bg);
      padding: 20px;
      text-align: center;
      color: #fff;
      position: relative;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }
    header h1 { margin: 0; font-size: 2.2rem; }
    .nav-buttons {
      position: absolute;
      top: 0px;
      left: 0px;
      z-index: 10000;
    }
    .nav-buttons button {
      background: none;
      border: none;
      cursor: pointer;
      outline: none;
    }
    .nav-buttons button span {
      font-size: 1.2rem;
      font-weight: bold;
      color: red;
      border: 0px solid black;
      padding: 5px 0px;
      border-radius: 1px;
    }
    .nav-buttons button:hover span {
      color: #cc0000;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 15px;
    }
    .stories-container {
      display: flex;
      overflow-x: auto;
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 10px;
      margin-top: 20px;
      min-height: 140px;
    }
    .story {
      margin: 10px;
      text-align: center;
      cursor: pointer;
      flex-shrink: 0;
      position: relative;
      width: 90px;
    }
    .story-img-container {
      position: relative;
      width: 80px;
      height: 80px;
      margin: 0 auto;
    }
    .story-img {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      border: 3px solid var(--primary-color);
      object-fit: cover;
      transition: transform 0.3s, border-color 0.3s;
    }
    .story-img-loader {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255,255,255,0.7);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .story.multiple .story-img { border: 3px solid #FF1493; }
    .story:hover .story-img {
      transform: scale(1.1);
      border-color: #00c6ff;
    }
    .story-name {
      font-size: 0.9rem;
      margin-top: 8px;
      color: #555;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .view-count {
      position: absolute;
      bottom: 20px;
      right: 20px;
      background: rgba(0,0,0,0.5);
      color: #fff;
      padding: 5px 10px;
      border-radius: 20px;
      font-size: 1rem;
      cursor: pointer;
      z-index: 10;
    }
    .like-btn {
      position: absolute;
      bottom: 20px;
      left: 20px;
      background: rgba(0,0,0,0.5);
      color: #fff;
      padding: 5px 10px;
      border-radius: 20px;
      font-size: 1rem;
      cursor: pointer;
      z-index: 10;
    }
    .suggested-accounts-container {
      margin-top: 10px;
      padding: 20px;
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .suggested-accounts-container h2 {
      text-align: center;
      margin-bottom: 15px;
      color: var(--primary-color);
      font-size: 1.8rem;
    }
    .accounts-grid {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 20px;
    }
    .account-card {
      width: 160px;
      text-align: center;
      cursor: pointer;
      position: relative;
      border: 1px solid #ddd;
      border-radius: 10px;
      padding: 10px;
      background: #fff;
      transition: transform 0.3s, box-shadow 0.3s;
    }
    .account-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    .account-card img {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      border: 3px solid var(--primary-color);
      object-fit: cover;
      transition: transform 0.3s;
    }
    .account-card img:hover { transform: scale(1.1); }
    .account-card .account-name {
      margin-top: 8px;
      font-size: 1.1rem;
      color: #333;
      font-weight: 600;
    }
    .account-card .followers-count {
      font-size: 0.85rem;
      margin: 5px 0;
      color: #777;
    }
    .follow-btn {
      margin-top: 8px;
      padding: 5px 10px;
      background: var(--primary-color);
      border: none;
      color: #fff;
      border-radius: 5px;
      cursor: pointer;
      transition: background 0.3s;
      font-size: 0.9rem;
    }
    .follow-btn:hover {
      background: var(--primary-dark);
    }
    #fabContainer {
      position: fixed;
      bottom: 30px;
      right: 30px;
      text-align: center;
      z-index: 1001;
      transition: opacity 0.3s;
    }
    .fab {
      width: 70px;
      height: 70px;
      border-radius: 50%;
      background-color: var(--primary-color);
      color: #fff;
      font-size: 2.5rem;
      border: none;
      box-shadow: 0 3px 8px rgba(0,0,0,0.3);
      cursor: pointer;
      outline: none;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.3s;
    }
    .fab:hover { background-color: var(--primary-dark); }
    .fab-label {
      margin-top: 10px;
      color: var(--primary-color);
      font-weight: bold;
      font-size: 1rem;
    }
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.85);
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .modal-content {
      background: #fff;
      padding: 25px;
      border-radius: 10px;
      max-width: 500px;
      width: 90%;
      text-align: center;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      position: relative;
      transition: all 0.3s;
    }
    .modal-content h2 {
      margin-top: 0;
      color: var(--primary-color);
      font-size: 1.8rem;
    }
    textarea {
      width: 100%;
      padding: 12px;
      margin: 15px 0;
      border: 1px solid #ccc;
      border-radius: 8px;
      resize: vertical;
      font-family: 'Tajawal', sans-serif;
      font-size: 1rem;
    }
    button {
      padding: 10px 20px;
      background: var(--primary-color);
      border: none;
      color: #fff;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
      margin: 5px;
      transition: background 0.3s;
    }
    button:hover { background: var(--primary-dark); }
    .btn-danger {
      background: var(--danger-color);
    }
    .btn-danger:hover { background: #b02a37; }
    .publish-btn {
      background: var(--secondary-color);
      border: none;
      color: #fff;
      padding: 10px 15px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: background 0.3s;
      margin-left: 10px;
    }
    .publish-btn:hover { background: #218838; }
    .story-view {
      width: 100vw;
      height: 100vh;
      background-size: cover;
      background-position: center;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      position: relative;
      color: #fff;
      padding: 20px;
      box-sizing: border-box;
    }
    .story-view-loader {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 100;
    }
    .action-bar {
      position: absolute;
      top: 20px;
      right: 20px;
      z-index: 1002;
      display: flex;
      gap: 15px;
    }
    .nav-btn {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      font-size: 2rem;
      color: #fff;
      background: rgba(0,0,0,0.4);
      border: none;
      border-radius: 50%;
      padding: 10px;
      cursor: pointer;
      z-index: 1001;
    }
    .nav-btn.prev { right: 20px; }
    .nav-btn.next { left: 20px; }
    .exit-btn {
      position: absolute;
      top: 20px;
      left: 20px;
      font-size: 1.5rem;
      background: rgba(0,0,0,0.5);
      border: none;
      color: #fff;
      padding: 5px 10px;
      cursor: pointer;
      border-radius: 8px;
      z-index: 1002;
    }
    #userInfoModal img {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      border: 3px solid var(--primary-color);
      object-fit: cover;
      margin-bottom: 15px;
      cursor: pointer;
    }
    #profileModal .modal-content {
      width: 100vw;
      height: 100vh;
      border-radius: 0;
      padding: 20px;
      position: relative;
      overflow: hidden;
    }
    #profileModal .profile-header {
      display: flex;
      align-items: center;
      gap: 20px;
      border-bottom: 1px solid #ddd;
      padding-bottom: 15px;
      margin-bottom: 15px;
    }
    #profileModal .profile-header img {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      border: 3px solid var(--primary-color);
      object-fit: cover;
    }
    #profileModal .profile-header .profile-info {
      text-align: left;
    }
    #profileModal .profile-header .profile-info p {
      margin: 5px 0;
      font-size: 1rem;
    }
    #userStoriesContainer {
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 100%;
      height: 40%;
      overflow-y: auto;
      background: rgba(255,255,255,0.95);
      padding: 10px;
      box-sizing: border-box;
    }
    .story-card {
      width: 100%;
      min-height: 120px;
      border: 2px solid red;
      border-radius: 8px;
      overflow: hidden;
      background-size: cover;
      background-position: center;
      margin-bottom: 10px;
      position: relative;
    }
    .story-card-loader {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255,255,255,0.7);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .story-time {
      position: absolute;
      top: 0px;
      left: 0px;
      color: #fff;
      background: rgba(0, 0, 0, 0.5);
      padding: 5px 10px;
      border-radius: 5px;
      font-size: 0.9rem;
      z-index: 1002;
    }
    .story-text-card {
      background: rgba(255, 255, 255, 0.9);
      color: #333;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
      max-width: 80%;
      margin: 20px auto;
      text-align: center;
      font-family: 'Tajawal', sans-serif;
      position: relative;
      z-index: 10;
    }
    .story-text-card h2 {
      margin: 0;
      font-size: 1.5rem;
      color: var(--primary-color);
    }
    .story-text-card p {
      margin-top: 10px;
      font-size: 1.1rem;
      line-height: 1.5;
    }
    
    /* منطقة معرض الصور (المنشورات) */
    .gallery-container {
      margin-top: 10px;
      padding: 20px;
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .gallery {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }
    .gallery .post {
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      overflow: hidden;
      position: relative;
      min-height: 300px;
    }
    .post-header {
      display: flex;
      align-items: center;
      padding: 10px;
      border-bottom: 1px solid #eee;
    }
    .post-header img {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: 2px solid var(--primary-color);
      object-fit: cover;
      margin-left: 10px;
      cursor: pointer;
      transition: transform 0.3s;
    }
    .post-header img:hover {
      transform: scale(1.1);
    }
    .post-header .user-name {
      font-weight: bold;
      font-size: 0.95rem;
    }
    .gallery .post .post-img-container {
      position: relative;
      height: 200px;
      overflow: hidden;
    }
    .gallery .post img.post-image {
      width: 100%;
      height: 200px;
      object-fit: cover;
    }
    .gallery .post .post-loader {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255,255,255,0.8);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .gallery .post .delete-btn {
      background: #dc3545;
      color: white;
      border: none;
      padding: ;adding: 10px;
      width: 100%;
      cursor: pointer;
      font-weight: bold;
      font-size: 1rem;
      transition: background 0.3s;
    }
    .gallery .post .delete-btn:hover {
      background: #b02a37;
    }
    
    /* تبويبات الصفحة الرئيسية */
    .tabs-container {
      display: flex;
      justify-content: center;
      margin: 20px 0;
    }
    
    .tab {
      padding: 12px 24px;
      background: var(--tab-inactive);
      border: none;
      border-radius: 30px;
      cursor: pointer;
      font-size: 1.1rem;
      font-weight: bold;
      transition: all 0.3s;
      margin: 0 5px;
    }
    
    .tab.active {
      background: var(--primary-color);
      color: white;
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    /* تصميم جديد لخيارات القصة */
    .story-type-selector {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin-bottom: 20px;
    }
    
    .story-type-btn {
      padding: 12px 24px;
      background: #e9ecef;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1.1rem;
      font-weight: bold;
      transition: all 0.3s;
    }
    
    .story-type-btn.active {
      background: var(--primary-color);
      color: white;
    }
    
    .story-type-content {
      display: none;
    }
    
    .story-type-content.active {
      display: block;
    }
    
    /* تصميم جديد لمعاينة الصورة */
    .image-preview-container {
      display: none;
      margin: 20px 0;
      text-align: center;
    }
    
    .image-preview {
      max-width: 100%;
      max-height: 300px;
      border-radius: 10px;
      border: 2px dashed #ddd;
      margin: 10px auto;
      display: block;
    }
    
    .upload-btn {
      background: #4CAF50;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 1rem;
      margin-top: 10px;
    }
    
    .upload-btn:hover {
      background: #45a049;
    }
    
    .file-upload-label {
      display: inline-block;
      padding: 10px 20px;
      background: var(--primary-color);
      color: white;
      border-radius: 5px;
      cursor: pointer;
      transition: background 0.3s;
      margin: 10px 0;
    }
    
    .file-upload-label:hover {
      background: var(--primary-dark);
    }
    
    .file-upload-label i {
      margin-left: 8px;
    }
    
    /* أيقونة التحميل الاحترافية */
    .loader {
      display: inline-block;
      width: 30px;
      height: 30px;
      border: 3px solid rgba(0,0,0,0.1);
      border-radius: 50%;
      border-top-color: var(--primary-color);
      animation: spin 1s linear infinite;
    }
    
    .loader.large {
      width: 60px;
      height: 60px;
      border-width: 5px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* مشاهدات القصة */
    .viewer {
      display: flex;
      align-items: center;
      padding: 10px;
      border-bottom: 1px solid #eee;
    }
    .viewer img {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      margin-left: 10px;
    }
    .viewer-name {
      font-weight: bold;
    }
    
    /* التعديلات الجديدة لحل المشكلات */
    
    /* تحسين أيقونة زر نشر الصورة */
    .fab .icon-fallback {
      display: none;
      font-size: 1.5rem;
      font-weight: bold;
    }
    
    /* تحسين موضع زر نشر الصورة */
    #fabContainerForImage {
      position: fixed;
      bottom: 120px;
      right: 30px;
      text-align: center;
      z-index: 1001;
    }
    
    /* تصميم وقت النشر */
    .post-time {
      position: absolute;
      top: 10px;
      right: 230px;
      color: #fff;
      background: rgba(0, 0, 0, 0.5);
      padding: 3px 8px;
      border-radius: 10px;
      font-size: 0.8rem;
      z-index: 10;
    }
    
    .story-time-preview {
      position: absolute;
      bottom: 95px;
      left: 5px;
      color: #fff;
      background: rgba(0, 0, 0, 0.5);
      padding: 3px 8px;
      border-radius: 10px;
      font-size: 0.7rem;
      z-index: 10;
    }
    
    @media (max-width: 600px) {
      header h1 { font-size: 1.5rem; }
      .fab { width: 60px; height: 60px; font-size: 2rem; }
      .fab-label { font-size: 0.9rem; }
      .gallery {
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      }
      .tab {
        padding: 10px 15px;
        font-size: 1rem;
      }
      .story-type-btn {
        padding: 10px 15px;
        font-size: 1rem;
      }
      .story {
        width: 80px;
      }
      .story-img-container {
        width: 70px;
        height: 70px;
      }
      .story-img {
        width: 70px;
        height: 70px;
      }
      #fabContainerForImage {
        bottom: 125px;
        right: 20px;
      }
    }
  </style>
</head>
<body>
  <!-- رأس الموقع مع زر رجوع كنص ظاهر فوق باقي العناصر -->
  <header>
    <div class="nav-buttons">
      <button id="backBtn" title="رجوع">
        <span>رجوع</span>
      </button>
    </div>
    <div class="container">
      <h1>قصصي - ستوري</h1>
    </div>
  </header>

  <div class="container">
    <!-- منطقة عرض القصص مع أيقونة التحميل -->
    <div class="stories-container" id="storiesContainer">
      <div class="loader large" id="storiesLoader"></div>
      <!-- سيتم تحميل القصص هنا -->
    </div>
    
    <!-- تبويبات الصفحة الرئيسية -->
    <div class="tabs-container">
      <button id="postsTab" class="tab active">منشورات</button>
      <button id="suggestedTab" class="tab">حسابات مقترحة</button>
    </div>
    
    <!-- محتوى التبويبات -->
    <div id="postsContent" class="tab-content active">
      <!-- معرض الصور (المنشورات) مع أيقونة التحميل -->
      <div class="gallery-container">
        <div class="gallery" id="gallery">
          <div class="loader large" id="galleryLoader"></div>
        </div>
      </div>
    </div>
    
    <div id="suggestedContent" class="tab-content">
      <!-- قسم الحسابات المقترحة مع أيقونة التحميل -->
      <div class="suggested-accounts-container">
        <h2>حسابات مقترحة</h2>
        <div class="loader large" id="accountsLoader"></div>
        <div class="accounts-grid" id="accountsGrid">
          <!-- سيتم تحميل حسابات المستخدمين هنا -->
        </div>
      </div>
    </div>
  </div>

  <!-- زر نشر القصة العائم -->
  <div id="fabContainer">
    <button class="fab" id="floatingAddStoryBtn">+</button>
    <div class="fab-label">نشر قصه جديده</div>
  </div>
  
  <!-- زر نشر الصورة العائم مع أيقونة احترافية -->
  <div id="fabContainerForImage">
    <button class="fab" id="floatingAddImageBtn" style="background-color: #4CAF50;">
      <i class="fas fa-camera" style="font-size: 1.8rem;"></i>
      <span class="icon-fallback">صورة</span>
    </button>
    <div class="fab-label">نشر صورة</div>
  </div>
  
  <!-- مودال إضافة القصة مع خيارات النوع -->
  <div class="modal-overlay" id="addStoryModal">
    <div class="modal-content">
      <h2 id="modalTitle">نشر قصة جديدة</h2>
      
      <div class="story-type-selector">
        <button id="textStoryBtn" class="story-type-btn active">نص</button>
        <button id="imageStoryBtn" class="story-type-btn">صورة</button>
      </div>
      
      <div id="textStoryContent" class="story-type-content active">
        <textarea id="storyText" rows="4" placeholder="أدخل نص القصة..."></textarea>
        <br>
        <button id="postTextStoryBtn"><i class="fa-solid fa-paper-plane"></i> نشر نص</button>
      </div>
      
      <div id="imageStoryContent" class="story-type-content">
        <!-- تم تحديث هذا القسم لتحسين اختيار الصور -->
        <label for="storyImageInput" class="file-upload-label">
          <i class="fa-solid fa-image"></i> اختر صورة
        </label>
        <input type="file" id="storyImageInput" accept="image/*" style="display: none;" />
        
        <div class="image-preview-container" id="imagePreviewContainer">
          <img id="imagePreview" class="image-preview" src="" alt="معاينة الصورة">
          <br>
          <button id="uploadImageBtn" class="upload-btn">
            <i class="fa-solid fa-cloud-upload-alt"></i> نشر الصورة
          </button>
        </div>
      </div>
      
      <button id="closeAddStoryBtn" class="btn-danger">
        <i class="fa-solid fa-xmark"></i> إغلاق
      </button>
    </div>
  </div>

  <!-- مودال عرض القصة -->
  <div class="modal-overlay" id="viewStoryModal">
    <div class="story-view" id="storyView">
      <div class="story-view-loader" id="storyViewLoader">
        <div class="loader large"></div>
      </div>
      <!-- سيتم تحميل محتوى عرض القصة هنا -->
    </div>
    <button class="nav-btn prev" id="prevStory">&#10094;</button>
    <button class="nav-btn next" id="nextStory">&#10095;</button>
    <button class="exit-btn" id="exitBtn">X</button>
  </div>

  <!-- مودال معلومات المستخدم -->
  <div class="modal-overlay" id="userInfoModal">
    <div class="modal-content" id="userInfoContent">
      <h2>معلومات المستخدم</h2>
      <div id="userInfoDetails">
        <!-- تفاصيل المستخدم -->
      </div>
      <button id="closeUserInfoBtn" class="btn-danger">
        <i class="fa-solid fa-xmark"></i> إغلاق
      </button>
    </div>
  </div>

  <!-- مودال الملف الشخصي (يشبه إنستغرام) -->
  <div class="modal-overlay" id="profileModal">
    <div class="modal-content">
      <button id="closeProfileBtn" class="btn-danger" style="position:absolute; top:10px; right:10px;">
        <i class="fa-solid fa-xmark"></i> إغلاق
      </button>
      <div class="profile-header">
        <img id="profilePic" src="" alt="صورة المستخدم">
        <div class="profile-info" id="profileInfo">
          <!-- تفاصيل الحساب -->
        </div>
      </div>
      <!-- قصص المستخدم تظهر في الأسفل -->
      <div id="userStoriesContainer">
        <!-- سيتم تحميل قصص المستخدم هنا -->
      </div>
    </div>
  </div>

  <!-- مودال عرض مشاهدات القصة -->
  <div class="modal-overlay" id="storyViewsModal">
    <div class="modal-content">
      <h2>مشاهدات القصة</h2>
      <div id="viewsList">
        <!-- سيتم تحميل قائمة المشاهدين هنا -->
      </div>
      <button id="closeViewsModal" class="btn-danger">
        <i class="fa-solid fa-xmark"></i> إغلاق
      </button>
    </div>
  </div>

  <script>
    // تهيئة Backendless لنشر الصور
    const APP_ID = "1A59C778-783C-4A9B-8167-648ECCFDF394";
    const API_KEY = "BBEAFC43-F642-44A3-B89A-245CA24C6D87";
    const STORIES_TABLE = "lpa"; // جدول القصص
    const POSTS_TABLE = "Apl";   // جدول المنشورات
    Backendless.initApp(APP_ID, API_KEY);

    // دالة لحساب الوقت النسبي (مثلاً "قبل 5 دقيقة")
    function getRelativeTime(date) {
      const now = new Date();
      const diffInSeconds = Math.floor((now - date) / 1000);
      
      if (diffInSeconds < 60) {
        return `قبل ${diffInSeconds} ثانية`;
      } else if (diffInSeconds < 3600) {
        const minutes = Math.floor(diffInSeconds / 60);
        return minutes === 1 ? "قبل دقيقة" : `قبل ${minutes} دقائق`;
      } else if (diffInSeconds < 86400) {
        const hours = Math.floor(diffInSeconds / 3600);
        return hours === 1 ? "قبل ساعة" : `قبل ${hours} ساعات`;
      } else if (diffInSeconds < 604800) {
        const days = Math.floor(diffInSeconds / 86400);
        return days === 1 ? "قبل يوم" : `قبل ${days} أيام`;
      } else if (diffInSeconds < 2592000) {
        const weeks = Math.floor(diffInSeconds / 604800);
        return weeks === 1 ? "قبل أسبوع" : `قبل ${weeks} أسابيع`;
      } else {
        const months = Math.floor(diffInSeconds / 2592000);
        return months === 1 ? "قبل شهر" : `قبل ${months} أشهر`;
      }
    }

    // تهيئة Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyBwwrBtf6AtW7R36FX4j2GQZVEdJldFq7o",
      authDomain: "you-unblock.firebaseapp.com",
      projectId: "you-unblock",
      storageBucket: "you-unblock.appspot.com",
      messagingSenderId: "306278978440",
      appId: "1:306278978440:web:4ca87c3856e107a30be03d"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let currentUser = null;
    let storyGroups = [];
    let currentGroupIndex = 0;
    let currentStoryIndex = 0;
    let uploadType = 'story'; // القيمة الافتراضية: قصة
    let usersCache = {}; // كاش لتخزين بيانات المستخدمين

    auth.onAuthStateChanged(user => {
      if(user) {
        currentUser = {
          id: user.uid,
          name: user.displayName || "مستخدم",
          photoURL: user.photoURL || "https://www.gravatar.com/avatar/?d=mp"
        };
        loadStories();
        loadSuggestedAccounts();
        loadGalleryImages();
      } else {
        window.location.href = 'login.html';
      }
    });

    // حدث زر الرجوع
    document.getElementById("backBtn").addEventListener("click", () => {
      window.location.href = "chat.html";
    });

    // تحميل القصص وتجميعها حسب userId
    function loadStories() {
      // إظهار أيقونة التحميل
      document.getElementById('storiesLoader').style.display = 'block';
      
      // تحميل القصص من Backendless
      Backendless.Data.of(STORIES_TABLE).find()
        .then(stories => {
          // معالجة القصص المحملة
          let groups = {};
          stories.forEach(story => {
            // التحقق من صلاحية القصة (أقل من 24 ساعة)
            const storyTime = new Date(story.timestamp);
            const now = new Date();
            if(now - storyTime > 24 * 60 * 60 * 1000) {
              // حذف القصة المنتهية الصلاحية
              Backendless.Data.of(STORIES_TABLE).remove(story.objectId);
              return;
            }
            
            if(!groups[story.userId]) {
              groups[story.userId] = [];
            }
            groups[story.userId].push(story);
          });
          
          // تحويل إلى مصفوفة وترتيب حسب الوقت
          storyGroups = [];
          for(let userId in groups) {
            groups[userId].sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
            storyGroups.push({ userId: userId, stories: groups[userId] });
          }
          storyGroups.sort((a, b) => {
            return new Date(b.stories[b.stories.length - 1].timestamp) - 
                   new Date(a.stories[a.stories.length - 1].timestamp);
          });
          
          renderStoryGroups();
          // إخفاء أيقونة التحميل بعد الانتهاء
          document.getElementById('storiesLoader').style.display = 'none';
        })
        .catch(err => {
          console.error("Error loading stories:", err);
          document.getElementById('storiesLoader').style.display = 'none';
        });
    }

    // عرض القصص في شريط القصص
    function renderStoryGroups() {
      const container = document.getElementById('storiesContainer');
      container.innerHTML = "";
      storyGroups.forEach(group => {
        const latestStory = group.stories[group.stories.length - 1];
        const storyDiv = document.createElement('div');
        storyDiv.classList.add('story');
        if(group.stories.length > 1) {
          storyDiv.classList.add('multiple');
        }
        storyDiv.dataset.userId = group.userId;
        
        // حاوية الصورة مع مؤشر التحميل
        const imgContainer = document.createElement('div');
        imgContainer.classList.add('story-img-container');
        
        const imgLoader = document.createElement('div');
        imgLoader.classList.add('story-img-loader');
        imgLoader.innerHTML = '<div class="loader"></div>';
        imgContainer.appendChild(imgLoader);
        
        const img = document.createElement('img');
        img.classList.add('story-img');
        img.src = latestStory.photoURL || currentUser.photoURL;
        img.onload = () => {
          imgLoader.style.display = 'none';
        };
        img.onerror = () => {
          imgLoader.style.display = 'none';
          img.src = "https://www.gravatar.com/avatar/?d=mp";
        };
        imgContainer.appendChild(img);
        
        const nameDiv = document.createElement('div');
        nameDiv.classList.add('story-name');
        nameDiv.textContent = latestStory.userName;
        
        // إضافة وقت النشر النسبي
        const timeDiv = document.createElement('div');
        timeDiv.classList.add('story-time-preview');
        if(latestStory.timestamp) {
          timeDiv.textContent = getRelativeTime(new Date(latestStory.timestamp));
        }
        
        storyDiv.appendChild(imgContainer);
        storyDiv.appendChild(nameDiv);
        storyDiv.appendChild(timeDiv);
        storyDiv.addEventListener('click', () => {
          currentGroupIndex = storyGroups.findIndex(g => g.userId === group.userId);
          currentStoryIndex = 0;
          showGroupedStory(currentGroupIndex, currentStoryIndex);
        });
        container.appendChild(storyDiv);
      });
    }

    // عرض قصة معينة من مجموعة
    function showGroupedStory(groupIndex, storyIndex) {
      if(groupIndex < 0 || groupIndex >= storyGroups.length) return;
      let group = storyGroups[groupIndex];
      if(storyIndex < 0 || storyIndex >= group.stories.length) return;
      let story = group.stories[storyIndex];
      const storyView = document.getElementById('storyView');
      storyView.innerHTML = "";
      
      // إظهار مؤشر التحميل
      const storyLoader = document.createElement('div');
      storyLoader.id = "storyViewLoader";
      storyLoader.className = "story-view-loader";
      storyLoader.innerHTML = '<div class="loader large"></div>';
      storyView.appendChild(storyLoader);
      
      // إخفاء زر الرجوع وزر نشر الصورة
      document.querySelector('.nav-buttons').style.display = 'none';
      document.getElementById('fabContainerForImage').style.display = 'none';
      
      // شريط الإجراءات إذا كانت القصة للمستخدم الحالي
      if(story.userId === currentUser.id) {
        const actionBar = document.createElement('div');
        actionBar.className = "action-bar";
        const deleteBtn = document.createElement('button');
        deleteBtn.className = "btn-danger";
        deleteBtn.innerHTML = '<i class="fa-solid fa-trash"></i> حذف القصة';
        deleteBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          if(confirm("هل أنت متأكد من حذف القصة؟")) {
            deleteStory(story.objectId);
          }
        });
        const publishNewBtn = document.createElement('button');
        publishNewBtn.className = "publish-btn";
        publishNewBtn.innerHTML = '<i class="fa-solid fa-plus-circle"></i> نشر قصة جديدة';
        publishNewBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          document.getElementById('viewStoryModal').style.display = 'none';
          document.getElementById('addStoryModal').style.display = 'flex';
          document.getElementById('fabContainer').style.display = 'block';
        });
        actionBar.appendChild(deleteBtn);
        actionBar.appendChild(publishNewBtn);
        storyView.appendChild(actionBar);
      }
      
      // إنشاء بطاقة لعرض نص القصة بشكل احترافي مع خلفية عشوائية
      if(story.type === 'text') {
        // إذا كانت القصة نصية، نستخدم الخلفية العشوائية
        storyView.style.backgroundImage = `url('${story.backgroundUrl}')`;
        storyView.style.backgroundSize = 'cover';
        
        const textCard = document.createElement('div');
        textCard.className = "story-text-card";
        textCard.style.backgroundColor = "rgba(255, 255, 255, 0.8)";
        textCard.style.padding = "25px";
        textCard.style.borderRadius = "15px";
        textCard.style.boxShadow = "0 4px 15px rgba(0,0,0,0.2)";
        textCard.style.maxWidth = "85%";
        textCard.innerHTML = `<h2 style="font-size: 1.8rem; margin-bottom: 15px;">${story.userName}</h2><p style="font-size: 1.3rem; line-height: 1.6;">${story.text}</p>`;
        storyView.appendChild(textCard);
        
        // إخفاء مؤشر التحميل بعد تحميل الخلفية
        const bgImg = new Image();
        bgImg.src = story.backgroundUrl;
        bgImg.onload = () => {
          document.getElementById('storyViewLoader').style.display = 'none';
        };
        bgImg.onerror = () => {
          document.getElementById('storyViewLoader').style.display = 'none';
        };
      }
      else if(story.type === 'image') {
        const bgImg = new Image();
        bgImg.src = story.imageUrl;
        bgImg.onload = () => {
          storyView.style.backgroundImage = `url('${story.imageUrl}')`;
          storyView.style.backgroundSize = 'cover';
          document.getElementById('storyViewLoader').style.display = 'none';
        };
        bgImg.onerror = () => {
          document.getElementById('storyViewLoader').style.display = 'none';
          storyView.innerHTML = '<p style="color:white;font-size:1.5rem">حدث خطأ في تحميل الصورة</p>';
        };
      }
      
      // حساب الوقت النسبي لعرضه
      let relativeTime = "";
      if(story.timestamp) {
        relativeTime = getRelativeTime(new Date(story.timestamp));
      }
      const timeDiv = document.createElement('div');
      timeDiv.className = "story-time";
      timeDiv.textContent = relativeTime;
      storyView.appendChild(timeDiv);
      
      // إنشاء أيقونة وعدد المشاهدات
      let currentViews = (story.views && story.views.length) ? story.views.length : 0;
      let viewCountDiv = document.createElement('div');
      viewCountDiv.className = "view-count";
      viewCountDiv.innerHTML = '<i class="fa-solid fa-eye"></i> ' + currentViews + ' مشاهدات';
      viewCountDiv.addEventListener('click', (e) => {
        e.stopPropagation();
        showStoryViews(story);
      });
      storyView.appendChild(viewCountDiv);
      
      // إنشاء زر اللايك وعرض عدد اللايكات
      let currentLikes = (story.likes && story.likes.length) ? story.likes.length : 0;
      let likeBtn = document.createElement('div');
      likeBtn.className = "like-btn";
      if(story.likes && story.likes.includes(currentUser.id)) {
         likeBtn.innerHTML = '<i class="fa-solid fa-heart" style="color: red;"></i> ' + currentLikes + ' لايك';
      } else {
         likeBtn.innerHTML = '<i class="fa-regular fa-heart"></i> ' + currentLikes + ' لايك';
      }
      likeBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          if(story.likes && story.likes.includes(currentUser.id)) {
              // إزالة الإعجاب
              Backendless.Data.of(STORIES_TABLE).save({
                objectId: story.objectId,
                likes: story.likes.filter(id => id !== currentUser.id)
              }).then(() => {
                story.likes = story.likes.filter(id => id !== currentUser.id);
                currentLikes = story.likes.length;
                likeBtn.innerHTML = '<i class="fa-regular fa-heart"></i> ' + currentLikes + ' لايك';
              });
          } else {
              // إضافة إعجاب
              if(!story.likes) story.likes = [];
              story.likes.push(currentUser.id);
              Backendless.Data.of(STORIES_TABLE).save({
                objectId: story.objectId,
                likes: story.likes
              }).then(() => {
                currentLikes = story.likes.length;
                likeBtn.innerHTML = '<i class="fa-solid fa-heart" style="color: red;"></i> ' + currentLikes + ' لايك';
              });
          }
      });
      storyView.appendChild(likeBtn);
      
      document.getElementById('viewStoryModal').style.display = 'flex';
      document.getElementById('fabContainer').style.display = 'none';
      
      // تسجيل المشاهدة
      if(!story.views || !story.views.includes(currentUser.id)) {
        if(!story.views) story.views = [];
        story.views.push(currentUser.id);
        Backendless.Data.of(STORIES_TABLE).save({
          objectId: story.objectId,
          views: story.views
        }).then(() => {
          viewCountDiv.innerHTML = '<i class="fa-solid fa-eye"></i> ' + story.views.length + ' مشاهدات';
        });
      }
    }

    // دالة حذف القصة
    function deleteStory(storyId) {
      Backendless.Data.of(STORIES_TABLE).remove(storyId)
        .then(() => {
          document.getElementById('viewStoryModal').style.display = 'none';
          document.getElementById('fabContainer').style.display = 'block';
          document.querySelector('.nav-buttons').style.display = 'block';
          loadStories();
        })
        .catch(err => console.error("Error deleting story:", err));
    }

    // تحميل الحسابات المقترحة مع زر متابعة/إلغاء متابعة
    function loadSuggestedAccounts() {
      // إظهار أيقونة التحميل
      document.getElementById('accountsLoader').style.display = 'block';
      
      db.collection("users").get().then(snapshot => {
        const grid = document.getElementById("accountsGrid");
        grid.innerHTML = "";
        snapshot.forEach(doc => {
          let user = doc.data();
          user.id = doc.id;
          if(!user.followers) user.followers = [];
          if(!user.followersCount) user.followersCount = 0;
          
          // تخزين المستخدم في الكاش
          usersCache[user.id] = user;
          
          const card = document.createElement("div");
          card.classList.add("account-card");
          
          // حاوية الصورة مع مؤشر التحميل
          const imgContainer = document.createElement('div');
          imgContainer.style.position = 'relative';
          imgContainer.style.width = '100px';
          imgContainer.style.height = '100px';
          imgContainer.style.margin = '0 auto';
          
          const imgLoader = document.createElement('div');
          imgLoader.style.position = 'absolute';
          imgLoader.style.top = '0';
          imgLoader.style.left = '0';
          imgLoader.style.width = '100%';
          imgLoader.style.height = '100%';
          imgLoader.style.display = 'flex';
          imgLoader.style.alignItems = 'center';
          imgLoader.style.justifyContent = 'center';
          imgLoader.style.backgroundColor = 'rgba(255,255,255,0.7)';
          imgLoader.style.borderRadius = '50%';
          imgLoader.innerHTML = '<div class="loader"></div>';
          imgContainer.appendChild(imgLoader);
          
          const img = document.createElement("img");
          img.src = user.photoURL || "https://www.gravatar.com/avatar/?d=mp";
          img.onload = () => {
            imgLoader.style.display = 'none';
          };
          img.onerror = () => {
            imgLoader.style.display = 'none';
            img.src = "https://www.gravatar.com/avatar/?d=mp";
          };
          imgContainer.appendChild(img);
          
          const nameDiv = document.createElement("div");
          nameDiv.classList.add("account-name");
          nameDiv.textContent = user.name || "مستخدم";
          const follCount = document.createElement("p");
          follCount.classList.add("followers-count");
          follCount.textContent = user.followersCount + " متابع";
          const followBtn = document.createElement("button");
          followBtn.classList.add("follow-btn");
          if(user.followers.includes(currentUser.id)) {
            followBtn.textContent = "تم متابعه";
          } else {
            followBtn.textContent = "متابعة";
          }
          followBtn.addEventListener("click", (e) => {
            e.stopPropagation();
            let isFollowing = user.followers.includes(currentUser.id);
            if(!isFollowing) {
              db.collection("users").doc(user.id).update({
                followers: firebase.firestore.FieldValue.arrayUnion(currentUser.id),
                followersCount: firebase.firestore.FieldValue.increment(1)
              }).then(() => {
                followBtn.textContent = "تم متابعه";
                user.followers.push(currentUser.id);
                user.followersCount++;
                follCount.textContent = user.followersCount + " متابع";
              });
            } else {
              db.collection("users").doc(user.id).update({
                followers: firebase.firestore.FieldValue.arrayRemove(currentUser.id),
                followersCount: firebase.firestore.FieldValue.increment(-1)
              }).then(() => {
                followBtn.textContent = "متابعة";
                user.followers = user.followers.filter(id => id !== currentUser.id);
                user.followersCount--;
                follCount.textContent = user.followersCount + " متابع";
              });
            }
          });
          card.appendChild(imgContainer);
          card.appendChild(nameDiv);
          card.appendChild(follCount);
          card.appendChild(followBtn);
          card.addEventListener("click", () => {
            showUserInfo(user);
          });
          grid.appendChild(card);
        });
        // إخفاء أيقونة التحميل بعد الانتهاء
        document.getElementById('accountsLoader').style.display = 'none';
      }).catch(err => {
        console.error("Error loading suggested accounts:", err);
        document.getElementById('accountsLoader').style.display = 'none';
      });
    }

    // عرض معلومات المستخدم في مودال
    function showUserInfo(user) {
      let joinDate = "غير متوفر";
      if(user.createdAt) {
        joinDate = new Date(user.createdAt).toLocaleDateString("ar-EG", {year:"numeric", month:"long", day:"numeric"});
      }
      const followersCount = user.followersCount || 0;
      const detailsDiv = document.getElementById("userInfoDetails");
      detailsDiv.innerHTML = `
        <img id="userProfilePic" src="${user.photoURL || "https://www.gravatar.com/avatar/?d=mp"}" alt="صورة المستخدم">
        <p><strong>الاسم:</strong> ${user.name || "غير معروف"}</p>
        <p><strong>اسم المستخدم:</strong> ${user.username || "غير متوفر"}</p>
        <p><strong>الوصف:</strong> ${user.description || "لا يوجد وصف."}</p>
        <p><strong>عدد المتابعين:</strong> ${followersCount}</p>
        <p><strong>تاريخ الانضمام:</strong> ${joinDate}</p>
      `;
      document.getElementById("userProfilePic").addEventListener("click", () => {
        document.getElementById("fabContainer").style.display = "none";
        openUserProfile(user);
      });
      document.getElementById("userInfoModal").style.display = "flex";
      document.getElementById("fabContainer").style.display = "none";
    }

    document.getElementById("closeUserInfoBtn").addEventListener("click", () => {
      document.getElementById("userInfoModal").style.display = "none";
      document.getElementById("fabContainer").style.display = "block";
    });
    document.getElementById("userInfoModal").addEventListener("click", (e) => {
      if(e.target === document.getElementById("userInfoModal")) {
        document.getElementById("userInfoModal").style.display = "none";
        document.getElementById("fabContainer").style.display = "block";
      }
    });

    // فتح شاشة الملف الشخصي (شاشة كاملة)
    function openUserProfile(user) {
      let joinDate = "غير متوفر";
      if(user.createdAt) {
        joinDate = new Date(user.createdAt).toLocaleDateString("ar-EG", {year:"numeric", month:"long", day:"numeric"});
      }
      document.getElementById("profilePic").src = user.photoURL || "https://www.gravatar.com/avatar/?d=mp";
      document.getElementById("profileInfo").innerHTML = `
        <p><strong>الاسم:</strong> ${user.name || "غير معروف"}</p>
        <p><strong>اسم المستخدم:</strong> ${user.username || "غير متوفر"}</p>
        <p><strong>الوصف:</strong> ${user.description || "لا يوجد وصف."}</p>
        <p><strong>تاريخ الانضمام:</strong> ${joinDate}</p>
        <p><strong>عدد المتابعين:</strong> ${user.followersCount || 0}</p>
      `;
      document.getElementById("profileModal").style.display = "flex";
      loadUserStories(user.id);
    }

    // تحميل قصص المستخدم وعرضها في القسم السفلي
    function loadUserStories(userId) {
      const storiesContainer = document.getElementById("userStoriesContainer");
      storiesContainer.innerHTML = "";
      Backendless.Data.of(STORIES_TABLE).find({ where: `userId = '${userId}'` })
        .then(stories => {
          stories.forEach(story => {
            const storyCard = document.createElement("div");
            storyCard.classList.add("story-card", "published");
            
            // إضافة مؤشر التحميل
            const loader = document.createElement('div');
            loader.className = "story-card-loader";
            loader.innerHTML = '<div class="loader"></div>';
            storyCard.appendChild(loader);
            
            if(story.type === 'image') {
              const img = new Image();
              img.src = story.imageUrl;
              img.onload = () => {
                storyCard.style.backgroundImage = `url('${story.imageUrl}')`;
                loader.style.display = 'none';
              };
              img.onerror = () => {
                loader.style.display = 'none';
                storyCard.innerHTML = '<div style="padding:10px;text-align:center">خطأ في تحميل الصورة</div>';
              };
            } else {
              const img = new Image();
              img.src = story.backgroundUrl;
              img.onload = () => {
                storyCard.style.backgroundImage = `url('${story.backgroundUrl}')`;
                storyCard.innerHTML = `<div style="padding:10px;text-align:center;color:white;font-weight:bold;text-shadow: 1px 1px 3px rgba(0,0,0,0.8);">${story.text}</div>`;
                loader.style.display = 'none';
              };
              img.onerror = () => {
                loader.style.display = 'none';
                storyCard.innerHTML = `<div style="padding:10px;text-align:center;color:black;font-weight:bold;">${story.text}</div>`;
              };
            }
            
            // إضافة وقت النشر النسبي
            const timeDiv = document.createElement('div');
            timeDiv.className = "story-time-preview";
            if(story.timestamp) {
              timeDiv.textContent = getRelativeTime(new Date(story.timestamp));
            }
            storyCard.appendChild(timeDiv);
            
            storiesContainer.appendChild(storyCard);
          });
        })
        .catch(err => console.error("Error loading user stories:", err));
    }

    document.getElementById("profileModal").addEventListener("click", (e) => {
      if(e.target === document.getElementById("profileModal")) {
        document.getElementById("profileModal").style.display = "none";
        document.getElementById("fabContainer").style.display = "block";
      }
    });
    document.getElementById("closeProfileBtn").addEventListener("click", () => {
      document.getElementById("profileModal").style.display = "none";
      document.getElementById("fabContainer").style.display = "block";
    });

    // التنقل بين القصص
    document.getElementById('prevStory').addEventListener('click', (e) => {
      e.stopPropagation();
      if(currentStoryIndex > 0) {
        currentStoryIndex--;
        showGroupedStory(currentGroupIndex, currentStoryIndex);
      } else if(currentGroupIndex > 0) {
        currentGroupIndex--;
        currentStoryIndex = storyGroups[currentGroupIndex].stories.length - 1;
        showGroupedStory(currentGroupIndex, currentStoryIndex);
      }
    });
    document.getElementById('nextStory').addEventListener('click', (e) => {
      e.stopPropagation();
      let group = storyGroups[currentGroupIndex];
      if(currentStoryIndex < group.stories.length - 1) {
        currentStoryIndex++;
        showGroupedStory(currentGroupIndex, currentStoryIndex);
      } else if(currentGroupIndex < storyGroups.length - 1) {
        currentGroupIndex++;
        currentStoryIndex = 0;
        showGroupedStory(currentGroupIndex, currentStoryIndex);
      }
    });
    document.getElementById('exitBtn').addEventListener('click', () => {
      document.getElementById('viewStoryModal').style.display = 'none';
      document.getElementById('fabContainer').style.display = 'block';
      document.getElementById('fabContainerForImage').style.display = 'block';
      document.querySelector('.nav-buttons').style.display = 'block';
    });
    document.getElementById('viewStoryModal').addEventListener('click', (e) => {
      if(e.target === document.getElementById('viewStoryModal')) {
        document.getElementById('viewStoryModal').style.display = 'none';
        document.getElementById('fabContainer').style.display = 'block';
        document.getElementById('fabContainerForImage').style.display = 'block';
        document.querySelector('.nav-buttons').style.display = 'block';
      }
    });
    
    // التبديل بين خيارات القصة (نص/صورة)
    document.getElementById('textStoryBtn').addEventListener('click', function() {
      this.classList.add('active');
      document.getElementById('imageStoryBtn').classList.remove('active');
      document.getElementById('textStoryContent').classList.add('active');
      document.getElementById('imageStoryContent').classList.remove('active');
    });
    
    document.getElementById('imageStoryBtn').addEventListener('click', function() {
      this.classList.add('active');
      document.getElementById('textStoryBtn').classList.remove('active');
      document.getElementById('imageStoryContent').classList.add('active');
      document.getElementById('textStoryContent').classList.remove('active');
    });
    
    // نشر قصة نصية
    document.getElementById('postTextStoryBtn').addEventListener('click', () => {
      const text = document.getElementById('storyText').value.trim();
      if(!text) {
        alert('يرجى إدخال نص القصة');
        return;
      }
      
      // توليد خلفية عشوائية باستخدم Unsplash API
      const randomBg = `https://source.unsplash.com/random/600x800?${Math.floor(Math.random()*1000)}`;
      
      // إظهار مؤشر التحميل
      const postBtn = document.getElementById('postTextStoryBtn');
      const originalText = postBtn.innerHTML;
      postBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> جاري النشر...';
      postBtn.disabled = true;
      
      Backendless.Data.of(STORIES_TABLE).save({
        type: 'text',
        text: text,
        userId: currentUser.id,
        userName: currentUser.name,
        photoURL: currentUser.photoURL,
        timestamp: new Date().getTime(),
        backgroundUrl: randomBg
      }).then(() => {
        document.getElementById('addStoryModal').style.display = 'none';
        document.getElementById('storyText').value = '';
        loadStories();
        
        // إعادة تعيين الزر
        postBtn.innerHTML = originalText;
        postBtn.disabled = false;
      }).catch(err => {
        console.error("Error posting text story:", err);
        
        // إعادة تعيين الزر في حالة الخطأ
        postBtn.innerHTML = originalText;
        postBtn.disabled = false;
      });
    });

    // دالة جديدة لنشر الصورة في جدول المنشورات (Apl)
    async function publishImageToPosts(file) {
      try {
        // إظهار مؤشر التحميل
        const uploadBtn = document.getElementById('uploadImageBtn');
        const originalText = uploadBtn.innerHTML;
        uploadBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> جاري النشر...';
        uploadBtn.disabled = true;
        
        // تحميل الصورة إلى Backendless
        const fileURL = await Backendless.Files.upload(file, "post_images", true);
        
        // حفظ البيانات في جدول المنشورات (Apl)
        await Backendless.Data.of(POSTS_TABLE).save({
          imageUrl: fileURL.fileURL,
          userId: currentUser.id,
          userName: currentUser.name,
          userPhotoURL: currentUser.photoURL,
          timestamp: new Date().getTime()
        });
        
        // إغلاق المودال وإعادة تعيين العناصر
        document.getElementById('addStoryModal').style.display = 'none';
        document.getElementById('imagePreviewContainer').style.display = 'none';
        document.getElementById('imagePreview').src = '';
        document.getElementById('storyImageInput').value = "";
        
        // إعادة تعيين الزر
        uploadBtn.innerHTML = originalText;
        uploadBtn.disabled = false;
        
        // إعادة تحميل معرض الصور
        loadGalleryImages();
        
        // إظهار رسالة نجاح
        alert('تم نشر الصورة في المنشورات بنجاح!');
      } catch (error) {
        console.error("خطأ في نشر الصورة في المنشورات:", error);
        alert("حدث خطأ أثناء نشر الصورة في المنشورات");
        
        // إعادة تعيين الزر في حالة الخطأ
        const uploadBtn = document.getElementById('uploadImageBtn');
        uploadBtn.innerHTML = '<i class="fa-solid fa-cloud-upload-alt"></i> نشر الصورة';
        uploadBtn.disabled = false;
      }
    }

    // فتح متصفح الملفات عند الضغط على زر الصورة العائم
    document.getElementById('floatingAddImageBtn').addEventListener('click', () => {
      // تعيين نوع النشر إلى "منشور"
      uploadType = 'post';
      document.getElementById('storyImageInput').click();
    });

    // معاينة الصورة عند اختيارها
    document.getElementById('storyImageInput').addEventListener('change', function() {
      if (this.files && this.files[0]) {
        const reader = new FileReader();
        
        reader.onload = function(e) {
          document.getElementById('imagePreview').src = e.target.result;
          document.getElementById('imagePreviewContainer').style.display = 'block';
          
          // عرض المودال إذا لم يكن مفتوحاً
          if (document.getElementById('addStoryModal').style.display !== 'flex') {
            document.getElementById('addStoryModal').style.display = 'flex';
            document.getElementById('imageStoryBtn').click();
          }
          
          // تعديل النصوص حسب نوع النشر
          if (uploadType === 'post') {
            document.getElementById('modalTitle').textContent = 'نشر صورة في المنشورات';
            document.getElementById('uploadImageBtn').innerHTML = 
              '<i class="fa-solid fa-cloud-upload-alt"></i> نشر في المنشورات';
          } else {
            document.getElementById('modalTitle').textContent = 'نشر قصة جديدة';
            document.getElementById('uploadImageBtn').innerHTML = 
              '<i class="fa-solid fa-cloud-upload-alt"></i> نشر الصورة في القصص';
          }
        }
        
        reader.readAsDataURL(this.files[0]);
      }
    });

    // حدث النقر على زر نشر الصورة
    document.getElementById('uploadImageBtn').addEventListener('click', async () => {
      const fileInput = document.getElementById("storyImageInput");
      const file = fileInput.files[0];
      
      if (!file) {
        alert("الرجاء اختيار صورة أولاً");
        return;
      }
      
      // اختيار الجدول المناسب حسب نوع النشر
      if (uploadType === 'post') {
        await publishImageToPosts(file);
      } else {
        // النشر في القصص (كما كان في الكود الأصلي)
        try {
          // إظهار مؤشر التحميل
          document.getElementById('uploadImageBtn').innerHTML = 
            '<i class="fa-solid fa-spinner fa-spin"></i> جاري النشر...';
          document.getElementById('uploadImageBtn').disabled = true;
          
          const fileURL = await Backendless.Files.upload(file, "story_images", true);
          await Backendless.Data.of(STORIES_TABLE).save({
            type: 'image',
            imageUrl: fileURL.fileURL,
            userId: currentUser.id,
            userName: currentUser.name,
            photoURL: currentUser.photoURL,
            timestamp: new Date().getTime()
          });
          
          document.getElementById('addStoryModal').style.display = 'none';
          document.getElementById('imagePreviewContainer').style.display = 'none';
          document.getElementById('imagePreview').src = '';
          fileInput.value = "";
          
          // إعادة تعيين الزر
          document.getElementById('uploadImageBtn').innerHTML = 
            '<i class="fa-solid fa-cloud-upload-alt"></i> نشر الصورة';
          document.getElementById('uploadImageBtn').disabled = false;
          
          loadStories();
        } catch (error) {
          console.error("خطأ في نشر الصورة في القصص:", error);
          alert("حدث خطأ أثناء نشر الصورة في القصص");
          
          // إعادة تعيين الزر في حالة الخطأ
          document.getElementById('uploadImageBtn').innerHTML = 
            '<i class="fa-solid fa-cloud-upload-alt"></i> نشر الصورة';
          document.getElementById('uploadImageBtn').disabled = false;
        }
      }
      
      // إعادة تعيين نوع النشر إلى القيمة الافتراضية (قصة)
      uploadType = 'story';
    });

    // فتح مودال إضافة القصة
    document.getElementById('floatingAddStoryBtn').addEventListener('click', () => {
      document.getElementById('addStoryModal').style.display = 'flex';
      document.getElementById('storyText').value = '';
      document.getElementById('textStoryBtn').classList.add('active');
      document.getElementById('imageStoryBtn').classList.remove('active');
      document.getElementById('textStoryContent').classList.add('active');
      document.getElementById('imageStoryContent').classList.remove('active');
      document.getElementById('modalTitle').textContent = 'نشر قصة جديدة';
      document.getElementById('uploadImageBtn').innerHTML = 
        '<i class="fa-solid fa-cloud-upload-alt"></i> نشر الصورة';
    });
    
    // إغلاق مودال إضافة القصة
    document.getElementById('closeAddStoryBtn').addEventListener('click', () => {
      document.getElementById('addStoryModal').style.display = 'none';
      document.getElementById('imagePreviewContainer').style.display = 'none';
      document.getElementById('imagePreview').src = '';
      document.getElementById('storyImageInput').value = '';
    });

    // دالة عرض مشاهدات القصة في مودال منفصل
    function showStoryViews(story) {
      const modal = document.getElementById('storyViewsModal');
      const viewsList = document.getElementById('viewsList');
      viewsList.innerHTML = '<div class="loader large"></div>';
      modal.style.display = 'flex';
      
      if(!story.views || story.views.length === 0) {
        viewsList.innerHTML = "<p>لا يوجد مشاهدات بعد.</p>";
        return;
      }
      
      // جلب بيانات المستخدمين من Firebase
      viewsList.innerHTML = "";
      let loadedCount = 0;
      const totalViews = story.views.length;
      
      story.views.forEach(userId => {
        // إذا كان المستخدم في الكاش، نستخدم البيانات المخزنة
        if(usersCache[userId]) {
          const user = usersCache[userId];
          createViewerElement(user);
          loadedCount++;
        } else {
          // جلب بيانات المستخدم من Firebase
          db.collection("users").doc(userId).get().then(doc => {
            if(doc.exists) {
              const user = doc.data();
              usersCache[userId] = user;
              createViewerElement(user);
            } else {
              createViewerElement({id: userId, name: "مستخدم غير معروف", photoURL: "https://www.gravatar.com/avatar/?d=mp"});
            }
            loadedCount++;
            if(loadedCount === totalViews) {
              // إخفاء أيقونة التحميل بعد تحميل جميع المشاهدات
              document.querySelector('#viewsList .loader')?.remove();
            }
          }).catch(() => {
            createViewerElement({id: userId, name: "مستخدم غير معروف", photoURL: "https://www.gravatar.com/avatar/?d=mp"});
            loadedCount++;
            if(loadedCount === totalViews) {
              document.querySelector('#viewsList .loader')?.remove();
            }
          });
        }
      });
      
      function createViewerElement(user) {
        let userDiv = document.createElement("div");
        userDiv.className = "viewer";
        userDiv.innerHTML = `
          <img src="${user.photoURL || "https://www.gravatar.com/avatar/?d=mp"}" alt="صورة المستخدم">
          <span class="viewer-name">${user.name || "مستخدم"}</span>
        `;
        viewsList.appendChild(userDiv);
      }
    }

    document.getElementById('closeViewsModal').addEventListener('click', () => {
      document.getElementById('storyViewsModal').style.display = 'none';
    });
    
    // وظائف معرض الصور باستخدام Backendless
    async function loadGalleryImages() {
      try {
        // إظهار أيقونة التحميل
        document.getElementById('galleryLoader').style.display = 'block';
        
        const queryBuilder = Backendless.DataQueryBuilder.create().setSortBy('timestamp DESC');
        const records = await Backendless.Data.of(POSTS_TABLE).find(queryBuilder);
        const gallery = document.getElementById('gallery');
        gallery.innerHTML = "";
        
        records.forEach(record => {
          const post = document.createElement("div");
          post.className = "post";
          
          // رأس المنشور مع صورة المستخدم واسمه
          const postHeader = document.createElement('div');
          postHeader.className = 'post-header';
          
          const userImg = document.createElement('img');
          userImg.src = record.userPhotoURL || currentUser.photoURL || "https://www.gravatar.com/avatar/?d=mp";
          userImg.addEventListener('click', () => {
            const user = {
              id: record.userId,
              name: record.userName,
              photoURL: record.userPhotoURL || "https://www.gravatar.com/avatar/?d=mp"
            };
            showUserInfo(user);
          });
          
          const userNameSpan = document.createElement('span');
          userNameSpan.className = 'user-name';
          userNameSpan.textContent = record.userName || "مستخدم";
          
          postHeader.appendChild(userImg);
          postHeader.appendChild(userNameSpan);
          post.appendChild(postHeader);
          
          // حاوية الصورة مع مؤشر التحميل
          const imgContainer = document.createElement('div');
          imgContainer.className = "post-img-container";
          
          const loader = document.createElement('div');
          loader.className = "post-loader";
          loader.innerHTML = '<div class="loader"></div>';
          imgContainer.appendChild(loader);
          
          const img = document.createElement("img");
          img.className = "post-image";
          img.src = record.imageUrl;
          img.onload = () => {
            loader.style.display = 'none';
          };
          img.onerror = () => {
            loader.style.display = 'none';
            img.src = "https://via.placeholder.com/200x200?text=خطأ+في+الصورة";
          };
          imgContainer.appendChild(img);
          
          post.appendChild(imgContainer);
          
          // إضافة وقت النشر النسبي
          const timeDiv = document.createElement('div');
          timeDiv.className = "post-time";
          if(record.timestamp) {
            timeDiv.textContent = getRelativeTime(new Date(record.timestamp));
          }
          post.appendChild(timeDiv);
          
          // إضافة زر حذف إذا كان المستخدم الحالي هو صاحب الصورة
          if (currentUser && record.userId === currentUser.id) {
            const deleteBtn = document.createElement("button");
            deleteBtn.className = "delete-btn";
            deleteBtn.textContent = "حذف المنشور";
            deleteBtn.onclick = () => deleteImage(record.objectId);
            post.appendChild(deleteBtn);
          }
          
          gallery.appendChild(post);
        });
        
        // إخفاء أيقونة التحميل بعد الانتهاء
        document.getElementById('galleryLoader').style.display = 'none';
      } catch (error) {
        console.error("خطأ في التحميل:", error);
        document.getElementById('galleryLoader').style.display = 'none';
      }
    }
    
    async function deleteImage(objectId) {
      if (confirm("هل أنت متأكد من حذف الصورة؟")) {
        try {
          await Backendless.Data.of(POSTS_TABLE).remove(objectId);
          loadGalleryImages();
        } catch (error) {
          console.error("خطأ في الحذف:", error);
          alert("حدث خطأ أثناء حذف الصورة");
        }
      }
    }
    
    // أحداث التبديل بين التبويبات
    document.getElementById('postsTab').addEventListener('click', function() {
      this.classList.add('active');
      document.getElementById('suggestedTab').classList.remove('active');
      document.getElementById('postsContent').classList.add('active');
      document.getElementById('suggestedContent').classList.remove('active');
    });
    
    document.getElementById('suggestedTab').addEventListener('click', function() {
      this.classList.add('active');
      document.getElementById('postsTab').classList.remove('active');
      document.getElementById('suggestedContent').classList.add('active');
      document.getElementById('postsContent').classList.remove('active');
    });
    
    // حل مشكلة أيقونة الكاميرا
    window.addEventListener('load', () => {
      const cameraIcon = document.querySelector('#floatingAddImageBtn .fa-camera');
      if (!cameraIcon || getComputedStyle(cameraIcon).display === 'none') {
        document.querySelector('#floatingAddImageBtn .icon-fallback').style.display = 'block';
      }
    });
  </script>
</body>
</html>
