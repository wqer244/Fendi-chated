<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>تطبيق البث المباشر</title>
  <!-- ربط خطوط تاجوال -->
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
  <!-- أيقونات Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" 
        integrity="sha512-pIVz3r+YZIxG8wfsx9NWeoO59V+byy3pY++jZo+iq8zB0QpUP7q90ymY+gnr9dMW+dE9W/jwhCQq+E3Cz/XXRw==" 
        crossorigin="anonymous" referrerpolicy="no-referrer" />
  <!-- مكتبات Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
  <style>
    :root {
      --primary-color: #0072ff;
      --primary-dark: #005bb5;
      --secondary-color: #28a745;
      --danger-color: #dc3545;
      --bg-color: #f4f7f6;
      --text-color: #333;
      --header-bg: linear-gradient(45deg, #00c6ff, #0072ff);
      --tab-inactive: #e9ecef;
      --like-color: #ff0000;
      --edit-color: #28a745; /* أخضر */
      --delete-color: #dc3545; /* أحمر */
    }
    body.dark-mode {
      --bg-color: #181818;
      --text-color: #e0e0e0;
      --header-bg: linear-gradient(45deg, #333, #111);
      --tab-inactive: #2d2d2d;
    }
    * { 
      box-sizing: border-box; 
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      -khtml-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
    }
    body {
      margin: 0;
      font-family: 'Tajawal', sans-serif;
      background: var(--bg-color);
      color: var(--text-color);
      direction: rtl;
      transition: background 0.3s, color 0.3s;
      touch-action: pan-y;
    }
    header {
      background: var(--header-bg);
      padding: 20px;
      text-align: center;
      color: #fff;
      position: relative;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .header-content {
      flex-grow: 1;
      position: relative;
    }
    header h1 { 
      margin: 0; 
      font-size: 1.8rem;
      text-align: center;
    }
    .nav-buttons {
      position: absolute;
      top: 0px;
      right: 0px;
      z-index: 10000;
    }
    .nav-buttons button {
      background: none;
      border: none;
      cursor: pointer;
      outline: none;
      padding: 8px 12px;
      font-size: 1rem;
      color: white;
      font-weight: bold;
      border-radius: 4px;
      background: rgba(0,0,0,0.2);
    }
    .profile-actions {
      position: absolute;
      top: 0px;
      left: 0px;
      z-index: 10000;
    }
    .profile-actions button {
      background: none;
      border: none;
      cursor: pointer;
      outline: none;
      padding: 8px 12px;
      font-size: 1rem;
      color: white;
      font-weight: bold;
      border-radius: 4px;
      background: rgba(0,0,0,0.2);
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 15px;
    }
    
    /* منطقة البث المباشر */
    .live-container {
      margin-top: 20px;
      background: #fff;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      position: relative;
    }
    
    .live-header {
      display: flex;
      align-items: center;
      padding: 15px;
      background: #f8f9fa;
      border-bottom: 1px solid #eee;
    }
    
    .live-header img {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      border: 2px solid var(--primary-color);
      margin-left: 15px;
    }
    
    .live-info {
      flex: 1;
    }
    
    .live-info h3 {
      margin: 0;
      font-size: 1.3rem;
    }
    
    .live-info p {
      margin: 5px 0 0;
      color: #666;
      font-size: 0.9rem;
    }
    
    .live-badge {
      background: var(--danger-color);
      color: white;
      padding: 3px 10px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: bold;
    }
    
    .video-container {
      position: relative;
      width: 100%;
      padding-top: 56.25%; /* 16:9 Aspect Ratio */
      background: #000;
    }
    
    .video-container video {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .live-controls {
      position: absolute;
      bottom: 15px;
      left: 0;
      right: 0;
      display: flex;
      justify-content: center;
      gap: 15px;
      z-index: 100;
    }
    
    .control-btn {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: rgba(0,0,0,0.5);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      border: none;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .control-btn:hover {
      background: rgba(0,0,0,0.7);
      transform: scale(1.1);
    }
    
    .end-btn {
      background: var(--danger-color);
    }
    
    .viewers-count {
      position: absolute;
      top: 15px;
      left: 15px;
      background: rgba(0,0,0,0.5);
      color: white;
      padding: 5px 15px;
      border-radius: 20px;
      font-size: 0.9rem;
      z-index: 100;
    }
    
    .live-chat-container {
      padding: 15px;
      background: #fff;
      border-top: 1px solid #eee;
      max-height: 300px;
      overflow-y: auto;
    }
    
    .chat-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    
    .chat-header h4 {
      margin: 0;
      font-size: 1.1rem;
    }
    
    .chat-messages {
      min-height: 150px;
      max-height: 250px;
      overflow-y: auto;
      padding: 10px 0;
    }
    
    .message {
      margin-bottom: 15px;
      padding: 10px;
      border-radius: 10px;
      background: #f8f9fa;
    }
    
    .message-header {
      display: flex;
      align-items: center;
      margin-bottom: 5px;
    }
    
    .message-header img {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      margin-left: 10px;
    }
    
    .message-header span {
      font-weight: bold;
      font-size: 0.9rem;
    }
    
    .message-content {
      font-size: 0.95rem;
      padding: 0 10px;
    }
    
    .chat-input {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }
    
    .chat-input input {
      flex: 1;
      padding: 10px 15px;
      border: 1px solid #ddd;
      border-radius: 20px;
      font-family: 'Tajawal', sans-serif;
      font-size: 0.95rem;
    }
    
    .chat-input button {
      background: var(--primary-color);
      border: none;
      color: white;
      padding: 10px 20px;
      border-radius: 20px;
      cursor: pointer;
      font-size: 0.95rem;
      transition: background 0.3s;
    }
    
    .chat-input button:hover {
      background: var(--primary-dark);
    }
    
    /* قائمة البثوث المباشرة */
    .live-streams-container {
      margin-top: 20px;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
    }
    
    .stream-card {
      background: #fff;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      transition: transform 0.3s, box-shadow 0.3s;
      cursor: pointer;
    }
    
    .stream-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 16px rgba(0,0,0,0.15);
    }
    
    .stream-thumbnail {
      position: relative;
      height: 160px;
      background: #000;
      overflow: hidden;
    }
    
    .stream-thumbnail img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      opacity: 0.9;
      transition: transform 0.3s;
    }
    
    .stream-card:hover .stream-thumbnail img {
      transform: scale(1.05);
    }
    
    .live-indicator {
      position: absolute;
      top: 10px;
      left: 10px;
      background: var(--danger-color);
      color: white;
      padding: 3px 10px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: bold;
      z-index: 10;
    }
    
    .viewers-count-small {
      position: absolute;
      bottom: 10px;
      left: 10px;
      background: rgba(0,0,0,0.5);
      color: white;
      padding: 3px 10px;
      border-radius: 20px;
      font-size: 0.8rem;
      z-index: 10;
    }
    
    .stream-info {
      padding: 15px;
    }
    
    .stream-info-header {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
    }
    
    .stream-info-header img {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      margin-left: 10px;
    }
    
    .stream-title {
      font-weight: bold;
      font-size: 1.1rem;
      margin-bottom: 5px;
    }
    
    .stream-category {
      color: #666;
      font-size: 0.9rem;
    }
    
    /* زر بدء البث المباشر */
    #fabContainer {
      position: fixed;
      bottom: 30px;
      right: 30px;
      text-align: center;
      z-index: 1001;
      transition: opacity 0.3s;
    }
    
    .fab {
      width: 70px;
      height: 70px;
      border-radius: 50%;
      background-color: var(--danger-color);
      color: #fff;
      font-size: 1.8rem;
      border: none;
      box-shadow: 0 3px 8px rgba(0,0,0,0.3);
      cursor: pointer;
      outline: none;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.3s;
    }
    
    .fab:hover { background-color: #c82333; }
    .fab-label {
      margin-top: 10px;
      color: var(--danger-color);
      font-weight: bold;
      font-size: 1rem;
    }
    
    /* تبويبات الصفحة الرئيسية */
    .tabs-container {
      display: flex;
      justify-content: center;
      margin: 20px 0;
    }
    
    .tab {
      padding: 12px 24px;
      background: var(--tab-inactive);
      border: none;
      border-radius: 30px;
      cursor: pointer;
      font-size: 1.1rem;
      font-weight: bold;
      transition: all 0.3s;
      margin: 0 5px;
    }
    
    .tab.active {
      background: var(--primary-color);
      color: white;
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    /* مودال بدء البث المباشر */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.85);
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    
    .modal-content {
      background: #fff;
      padding: 25px;
      border-radius: 10px;
      max-width: 500px;
      width: 90%;
      text-align: center;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      position: relative;
      transition: all 0.3s;
    }
    
    .modal-content h2 {
      margin-top: 0;
      color: var(--primary-color);
      font-size: 1.8rem;
    }
    
    input, textarea {
      width: 100%;
      padding: 12px;
      margin: 15px 0;
      border: 1px solid #ccc;
      border-radius: 8px;
      resize: vertical;
      font-family: 'Tajawal', sans-serif;
      font-size: 1rem;
    }
    
    button {
      padding: 10px 20px;
      background: var(--primary-color);
      border: none;
      color: #fff;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
      margin: 5px;
      transition: background 0.3s;
    }
    
    button:hover { background: var(--primary-dark); }
    
    .btn-danger {
      background: var(--danger-color);
    }
    
    .btn-danger:hover { background: #b02a37; }
    
    /* أيقونة التحميل */
    .loader {
      display: inline-block;
      width: 30px;
      height: 30px;
      border: 3px solid rgba(0,0,0,0.1);
      border-radius: 50%;
      border-top-color: var(--primary-color);
      animation: spin 1s linear infinite;
    }
    
    .loader.large {
      width: 60px;
      height: 60px;
      border-width: 5px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* زر التعديل والحذف الجديد */
    .text-btn {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 1rem;
      padding: 5px 10px;
      border-radius: 4px;
      transition: background 0.3s;
      margin: 0 2px;
      font-weight: bold;
    }
    
    /* زر التعديل - أخضر */
    .edit-text-btn {
      background: #28a745; /* أخضر */
      color: white;
    }
    
    /* زر الحذف - أحمر */
    .delete-text-btn {
      background: #dc3545; /* أحمر */
      color: white;
    }
    
    .edit-text-btn:hover {
      background: #218838;
    }
    
    .delete-text-btn:hover {
      background: #bd2130;
    }
    
    @media (max-width: 600px) {
      header h1 { font-size: 1.5rem; }
      .fab { width: 60px; height: 60px; font-size: 1.5rem; }
      .fab-label { font-size: 0.9rem; }
      .tabs-container { flex-wrap: wrap; }
      .tab { padding: 8px 15px; font-size: 0.9rem; margin: 5px; }
      .live-streams-container { grid-template-columns: 1fr; }
      .control-btn { width: 40px; height: 40px; font-size: 1rem; }
      .video-container { padding-top: 75%; } /* 4:3 for mobile */
    }
  </style>
</head>
<body>
  <header>
    <div class="header-content">
      <div class="nav-buttons">
        <button id="backBtn" title="رجوع">
          <span>رجوع</span>
        </button>
      </div>
      <h1>البث المباشر</h1>
      <div class="profile-actions">
        <button id="editProfileBtn" class="edit-profile-btn">
          <i class="fas fa-user"></i>
          الملف الشخصي
        </button>
      </div>
    </div>
  </header>

  <div class="container">
    <!-- تبويبات الصفحة الرئيسية -->
    <div class="tabs-container">
      <button id="liveTab" class="tab active">بث مباشر</button>
      <button id="streamsTab" class="tab">البثوث الحية</button>
    </div>
    
    <!-- محتوى التبويبات -->
    <div id="liveContent" class="tab-content active">
      <!-- منطقة البث المباشر -->
      <div class="live-container" id="activeLiveContainer" style="display: none;">
        <div class="live-header">
          <img id="broadcasterImg" src="" alt="صورة المذيع">
          <div class="live-info">
            <h3 id="broadcasterName"></h3>
            <p id="streamTitle"></p>
          </div>
          <div class="live-badge">مباشر</div>
        </div>
        
        <div class="video-container">
          <video id="liveVideo" autoplay playsinline></video>
          <div class="viewers-count">
            <i class="fas fa-eye"></i> <span id="viewersCount">0</span> مشاهدين
          </div>
          <div class="live-controls">
            <button id="toggleMic" class="control-btn">
              <i class="fas fa-microphone"></i>
            </button>
            <button id="toggleCam" class="control-btn">
              <i class="fas fa-video"></i>
            </button>
            <button id="endLive" class="control-btn end-btn">
              <i class="fas fa-phone-slash"></i>
            </button>
          </div>
        </div>
        
        <div class="live-chat-container">
          <div class="chat-header">
            <h4>محادثة البث</h4>
          </div>
          <div class="chat-messages" id="chatMessages">
            <!-- سيتم تحميل الرسائل هنا -->
          </div>
          <div class="chat-input">
            <input type="text" id="chatInput" placeholder="اكتب رسالة...">
            <button id="sendChatBtn">إرسال</button>
          </div>
        </div>
      </div>
      
      <!-- رسالة عندما لا يكون هناك بث نشط -->
      <div id="noLiveMessage" style="text-align: center; padding: 40px 20px; background: #fff; border-radius: 12px; margin-top: 20px;">
        <i class="fas fa-video-slash" style="font-size: 3rem; color: #ccc; margin-bottom: 20px;"></i>
        <h3>لا يوجد بث مباشر نشط حاليًا</h3>
        <p>يمكنك بدء بث مباشر أو تصفح البثوث الحية من التبويب الآخر</p>
        <button id="startLiveBtn" style="margin-top: 20px; padding: 12px 30px; font-size: 1.1rem;">بدء بث مباشر</button>
      </div>
    </div>
    
    <div id="streamsContent" class="tab-content">
      <!-- قسم البثوث الحية -->
      <div class="live-streams-container" id="liveStreamsContainer">
        <div class="loader large" style="grid-column: 1 / -1; margin: 40px auto;"></div>
      </div>
    </div>
  </div>

  <!-- زر بدء البث المباشر العائم -->
  <div id="fabContainer">
    <button class="fab" id="floatingStartLiveBtn">
      <i class="fas fa-video"></i>
    </button>
    <div class="fab-label">بدء بث</div>
  </div>
  
  <!-- مودال بدء البث المباشر -->
  <div class="modal-overlay" id="startLiveModal">
    <div class="modal-content">
      <h2>بدء بث مباشر جديد</h2>
      
      <input type="text" id="streamTitleInput" placeholder="عنوان البث المباشر">
      <input type="text" id="streamCategory" placeholder="فئة البث (اختياري)">
      <textarea id="streamDescription" rows="3" placeholder="وصف البث (اختياري)"></textarea>
      
      <div style="display: flex; justify-content: center; gap: 15px; margin-top: 20px;">
        <button id="confirmStartLiveBtn" style="background: var(--danger-color);">
          <i class="fas fa-play-circle"></i> بدء البث
        </button>
        <button id="cancelStartLiveBtn" class="btn-danger">
          <i class="fas fa-times"></i> إلغاء
        </button>
      </div>
    </div>
  </div>

  <!-- مودال تعديل الملف الشخصي -->
  <div class="modal-overlay" id="editProfileModal">
    <div class="modal-content">
      <h2>تعديل الملف الشخصي</h2>
      <div style="text-align: center; margin: 20px 0;">
        <img id="editProfilePic" src="" alt="صورة الملف" 
             style="width: 120px; height: 120px; border-radius: 50%; border: 3px solid var(--primary-color); object-fit: cover; cursor: pointer;">
        <input type="file" id="editProfileImageInput" accept="image/*" style="display: none;">
      </div>
      <div style="margin: 15px 0;">
        <label>الاسم:</label>
        <input type="text" id="editProfileName" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px; margin-top: 5px;">
      </div>
      <div style="margin: 15px 0;">
        <label>الوصف:</label>
        <textarea id="editProfileDescription" rows="3" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px; margin-top: 5px; resize: vertical;"></textarea>
      </div>
      <div style="margin: 15px 0;">
        <label>اسم المستخدم:</label>
        <input type="text" id="editProfileUsername" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px; margin-top: 5px;">
      </div>
      <div style="display: flex; justify-content: center; gap: 10px; margin-top: 20px;">
        <button id="saveProfileBtn" style="background: var(--primary-color);">حفظ التعديلات</button>
        <button id="cancelEditProfileBtn" class="btn-danger">إلغاء</button>
      </div>
    </div>
  </div>

  <script>
    // تهيئة Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyBwwrBtf6AtW7R36FX4j2GQZVEdJldFq7o",
      authDomain: "you-unblock.firebaseapp.com",
      projectId: "you-unblock",
      storageBucket: "you-unblock.appspot.com",
      messagingSenderId: "306278978440",
      appId: "1:306278978440:web:4ca87c3856e107a30be03d",
      databaseURL: "https://you-unblock-default-rtdb.firebaseio.com/"
    };
    
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const realtimeDb = firebase.database();

    let currentUser = null;
    let localStream = null;
    let peerConnection = null;
    let currentLiveStreamId = null;
    let isBroadcasting = false;
    let isWatching = false;
    let mediaConstraints = {
      video: {
        width: { ideal: 1280 },
        height: { ideal: 720 }
      },
      audio: true
    };
    
    // متغيرات حالة البث
    let micEnabled = true;
    let camEnabled = true;

    // منع التكبير/التصغير والنسخ
    document.addEventListener('contextmenu', event => event.preventDefault());
    document.addEventListener('dblclick', event => event.preventDefault(), { passive: false });
    
    auth.onAuthStateChanged(user => {
      if(user) {
        currentUser = {
          id: user.uid,
          name: user.displayName || "مستخدم",
          photoURL: user.photoURL || "https://www.gravatar.com/avatar/?d=mp",
          username: ""
        };
        
        // جلب معلومات إضافية للمستخدم
        db.collection("users").doc(user.uid).get().then(doc => {
          if (doc.exists) {
            const userData = doc.data();
            currentUser.description = userData.description || "";
            currentUser.username = userData.username || "";
          }
          loadLiveStreams();
          checkActiveLiveStream();
        }).catch(() => {
          loadLiveStreams();
          checkActiveLiveStream();
        });
      } else {
        window.location.href = 'login.html';
      }
    });

    // حدث زر الرجوع
    document.getElementById("backBtn").addEventListener("click", () => {
      window.location.href = "chat.html";
    });
    
    // أحداث التبديل بين التبويبات
    document.getElementById('liveTab').addEventListener('click', function() {
      this.classList.add('active');
      document.getElementById('streamsTab').classList.remove('active');
      document.getElementById('liveContent').classList.add('active');
      document.getElementById('streamsContent').classList.remove('active');
    });
    
    document.getElementById('streamsTab').addEventListener('click', function() {
      this.classList.add('active');
      document.getElementById('liveTab').classList.remove('active');
      document.getElementById('streamsContent').classList.add('active');
      document.getElementById('liveContent').classList.remove('active');
      loadLiveStreams();
    });
    
    // تحميل البثوث الحية
    function loadLiveStreams() {
      const container = document.getElementById('liveStreamsContainer');
      container.innerHTML = '<div class="loader large" style="grid-column: 1 / -1; margin: 40px auto;"></div>';
      
      // جلب البثوث النشطة فقط
      db.collection("liveStreams")
        .where("isActive", "==", true)
        .get()
        .then(snapshot => {
          container.innerHTML = '';
          
          if (snapshot.empty) {
            container.innerHTML = `
              <div style="grid-column: 1 / -1; text-align: center; padding: 40px 20px;">
                <i class="fas fa-video-slash" style="font-size: 3rem; color: #ccc; margin-bottom: 20px;"></i>
                <h3>لا توجد بثوث مباشرة حالياً</h3>
                <p>كن أول من يبدأ بثاً مباشراً!</p>
              </div>
            `;
            return;
          }
          
          snapshot.forEach(doc => {
            const stream = doc.data();
            const streamCard = document.createElement('div');
            streamCard.className = 'stream-card';
            streamCard.dataset.id = doc.id;
            
            streamCard.innerHTML = `
              <div class="stream-thumbnail">
                <img src="${stream.thumbnail || 'https://via.placeholder.com/300x200?text=Live+Stream'}" alt="صورة البث">
                <div class="live-indicator">مباشر</div>
                <div class="viewers-count-small">
                  <i class="fas fa-eye"></i> ${stream.viewers || 0}
                </div>
              </div>
              <div class="stream-info">
                <div class="stream-title">${stream.title || 'بث مباشر'}</div>
                <div class="stream-category">${stream.category || 'عام'}</div>
                <div class="stream-info-header">
                  <img src="${stream.broadcasterPhotoURL || 'https://www.gravatar.com/avatar/?d=mp'}" alt="صورة المذيع">
                  <div>
                    <div>${stream.broadcasterName || 'مستخدم'}</div>
                    <small>${getRelativeTime(new Date(stream.startedAt))}</small>
                  </div>
                </div>
              </div>
            `;
            
            streamCard.addEventListener('click', () => {
              joinLiveStream(doc.id);
            });
            
            container.appendChild(streamCard);
          });
        })
        .catch(error => {
          console.error("Error loading live streams:", error);
          container.innerHTML = '<p>حدث خطأ أثناء تحميل البثوث المباشرة</p>';
        });
    }
    
    // دالة لحساب الوقت النسبي
    function getRelativeTime(date) {
      const now = new Date();
      const diffInSeconds = Math.floor((now - date) / 1000);
      
      if (diffInSeconds < 60) {
        return `قبل ${diffInSeconds} ثانية`;
      } else if (diffInSeconds < 3600) {
        const minutes = Math.floor(diffInSeconds / 60);
        return minutes === 1 ? "قبل دقيقة" : `قبل ${minutes} دقائق`;
      } else if (diffInSeconds < 86400) {
        const hours = Math.floor(diffInSeconds / 3600);
        return hours === 1 ? "قبل ساعة" : `قبل ${hours} ساعات`;
      } else if (diffInSeconds < 604800) {
        const days = Math.floor(diffInSeconds / 86400);
        return days === 1 ? "قبل يوم" : `قبل ${days} أيام`;
      } else if (diffInSeconds < 2592000) {
        const weeks = Math.floor(diffInSeconds / 604800);
        return weeks === 1 ? "قبل أسبوع" : `قبل ${weeks} أسابيع`;
      } else {
        const months = Math.floor(diffInSeconds / 2592000);
        return months === 1 ? "قبل شهر" : `قبل ${months} أشهر`;
      }
    }
    
    // التحقق من وجود بث نشط
    function checkActiveLiveStream() {
      db.collection("liveStreams")
        .where("isActive", "==", true)
        .limit(1)
        .get()
        .then(snapshot => {
          if (!snapshot.empty) {
            const stream = snapshot.docs[0].data();
            joinLiveStream(snapshot.docs[0].id);
          } else {
            document.getElementById('noLiveMessage').style.display = 'block';
            document.getElementById('activeLiveContainer').style.display = 'none';
          }
        });
    }
    
    // الانضمام إلى بث مباشر
    function joinLiveStream(streamId) {
      document.getElementById('liveTab').click();
      document.getElementById('noLiveMessage').style.display = 'none';
      document.getElementById('activeLiveContainer').style.display = 'block';
      
      db.collection("liveStreams").doc(streamId).get().then(doc => {
        if (!doc.exists) return;
        
        const stream = doc.data();
        document.getElementById('broadcasterName').textContent = stream.broadcasterName;
        document.getElementById('streamTitle').textContent = stream.title;
        document.getElementById('broadcasterImg').src = stream.broadcasterPhotoURL || 'https://www.gravatar.com/avatar/?d=mp';
        document.getElementById('viewersCount').textContent = stream.viewers || 0;
        
        // تحديث عدد المشاهدين
        db.collection("liveStreams").doc(streamId).update({
          viewers: firebase.firestore.FieldValue.increment(1)
        });
        
        // جلب الرسائل
        loadChatMessages(streamId);
        
        // إعداد المشاهدة
        setupViewing(streamId);
      });
    }
    
    // إعداد المشاهدة (محاكاة)
    function setupViewing(streamId) {
      isWatching = true;
      currentLiveStreamId = streamId;
      
      // استخدام فيديو تجريبي للبث
      const liveVideo = document.getElementById('liveVideo');
      liveVideo.src = "https://sample-videos.com/video123/mp4/720/big_buck_bunny_720p_1mb.mp4";
      liveVideo.play();
    }
    
    // تحميل رسائل الدردشة
    function loadChatMessages(streamId) {
      const messagesContainer = document.getElementById('chatMessages');
      messagesContainer.innerHTML = '';
      
      db.collection("liveStreams").doc(streamId).collection("chat")
        .orderBy("timestamp", "asc")
        .onSnapshot(snapshot => {
          snapshot.docChanges().forEach(change => {
            if (change.type === "added") {
              const msg = change.doc.data();
              addMessageToChat(msg);
            }
          });
        });
    }
    
    // إضافة رسالة إلى الدردشة
    function addMessageToChat(msg) {
      const messagesContainer = document.getElementById('chatMessages');
      const messageElement = document.createElement('div');
      messageElement.className = 'message';
      
      messageElement.innerHTML = `
        <div class="message-header">
          <img src="${msg.userPhotoURL || 'https://www.gravatar.com/avatar/?d=mp'}" alt="صورة المستخدم">
          <span>${msg.userName}</span>
        </div>
        <div class="message-content">${msg.text}</div>
      `;
      
      messagesContainer.appendChild(messageElement);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }
    
    // إرسال رسالة دردشة
    document.getElementById('sendChatBtn').addEventListener('click', () => {
      const message = document.getElementById('chatInput').value.trim();
      if (!message || !currentLiveStreamId) return;
      
      db.collection("liveStreams").doc(currentLiveStreamId).collection("chat").add({
        userId: currentUser.id,
        userName: currentUser.name,
        userPhotoURL: currentUser.photoURL,
        text: message,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      });
      
      document.getElementById('chatInput').value = '';
    });
    
    // السماح بإرسال الرسالة بالضغط على Enter
    document.getElementById('chatInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        document.getElementById('sendChatBtn').click();
      }
    });
    
    // بدء بث مباشر
    document.getElementById('startLiveBtn').addEventListener('click', showStartLiveModal);
    document.getElementById('floatingStartLiveBtn').addEventListener('click', showStartLiveModal);
    
    function showStartLiveModal() {
      document.getElementById('startLiveModal').style.display = 'flex';
    }
    
    document.getElementById('confirmStartLiveBtn').addEventListener('click', startLiveBroadcast);
    
    async function startLiveBroadcast() {
      const title = document.getElementById('streamTitleInput').value.trim() || "بث مباشر";
      const category = document.getElementById('streamCategory').value.trim() || "عام";
      const description = document.getElementById('streamDescription').value.trim() || "";
      
      if (!title) {
        alert("الرجاء إدخال عنوان للبث");
        return;
      }
      
      try {
        // الحصول على إذن الكاميرا والميكروفون
        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
          localStream = await navigator.mediaDevices.getUserMedia(mediaConstraints);
        } else {
          throw new Error("المتصفح لا يدعم الكاميرا والميكروفون");
        }
        
        // إنشاء بث جديد في قاعدة البيانات
        const liveStreamRef = await db.collection("liveStreams").add({
          broadcasterId: currentUser.id,
          broadcasterName: currentUser.name,
          broadcasterPhotoURL: currentUser.photoURL,
          title: title,
          category: category,
          description: description,
          startedAt: firebase.firestore.FieldValue.serverTimestamp(),
          viewers: 0,
          isActive: true
        });
        
        currentLiveStreamId = liveStreamRef.id;
        isBroadcasting = true;
        
        // عرض البث في الواجهة
        document.getElementById('noLiveMessage').style.display = 'none';
        document.getElementById('activeLiveContainer').style.display = 'block';
        document.getElementById('broadcasterName').textContent = currentUser.name;
        document.getElementById('streamTitle').textContent = title;
        document.getElementById('broadcasterImg').src = currentUser.photoURL || 'https://www.gravatar.com/avatar/?d=mp';
        document.getElementById('viewersCount').textContent = '0';
        
        // عرض الفيديو المحلي
        const liveVideo = document.getElementById('liveVideo');
        if (localStream) {
          liveVideo.srcObject = localStream;
        } else {
          // استخدام فيديو تجريبي إذا لم يتوفر بث حقيقي
          liveVideo.src = "https://sample-videos.com/video123/mp4/720/big_buck_bunny_720p_1mb.mp4";
          liveVideo.play();
        }
        
        // إخفاء المودال
        document.getElementById('startLiveModal').style.display = 'none';
        
        // تحديث واجهة المستخدم
        document.getElementById('liveTab').click();
        
        // إعداد خادم الإشارة البسيط
        setupSignaling();
        
      } catch (error) {
        console.error("Error starting live broadcast:", error);
        alert("فشل في بدء البث المباشر: " + error.message);
        
        // استخدام فيديو تجريبي في حالة الخطأ
        const liveVideo = document.getElementById('liveVideo');
        liveVideo.src = "https://sample-videos.com/video123/mp4/720/big_buck_bunny_720p_1mb.mp4";
        liveVideo.play();
      }
    }
    
    // إعداد خادم الإشارة البسيط
    function setupSignaling() {
      if (!currentLiveStreamId) return;
      
      // إنشاء اتصال WebRTC
      const configuration = {
        iceServers: [
          { urls: 'stun:stun.l.google.com:19302' },
          { urls: 'stun:stun1.l.google.com:19302' }
        ]
      };
      
      peerConnection = new RTCPeerConnection(configuration);
      
      // إضافة تدفق الوسائط المحلي
      if (localStream) {
        localStream.getTracks().forEach(track => {
          peerConnection.addTrack(track, localStream);
        });
      }
      
      // معالجة مرشحات ICE
      peerConnection.onicecandidate = event => {
        if (event.candidate) {
          // إرسال مرشح ICE إلى المشاهدين عبر Firebase
          realtimeDb.ref(`liveStreams/${currentLiveStreamId}/candidates`).push({
            candidate: event.candidate,
            from: currentUser.id
          });
        }
      };
      
      // إنشاء عرض SDP
      peerConnection.createOffer()
        .then(offer => peerConnection.setLocalDescription(offer))
        .then(() => {
          // حفظ العرض في قاعدة البيانات
          realtimeDb.ref(`liveStreams/${currentLiveStreamId}/offer`).set({
            sdp: peerConnection.localDescription.sdp,
            type: peerConnection.localDescription.type
          });
        });
    }
    
    // إيقاف البث المباشر
    document.getElementById('endLive').addEventListener('click', endLiveBroadcast);
    
    function endLiveBroadcast() {
      if (!currentLiveStreamId) return;
      
      if (confirm("هل أنت متأكد من إيقاف البث المباشر؟")) {
        // تحديث حالة البث في قاعدة البيانات
        db.collection("liveStreams").doc(currentLiveStreamId).update({
          isActive: false,
          endedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // إيقاف الفيديو
        const liveVideo = document.getElementById('liveVideo');
        liveVideo.srcObject = null;
        liveVideo.src = '';
        
        // إغلاق التدفق المحلي
        if (localStream) {
          localStream.getTracks().forEach(track => track.stop());
          localStream = null;
        }
        
        // إغلاق اتصال WebRTC
        if (peerConnection) {
          peerConnection.close();
          peerConnection = null;
        }
        
        // إعادة تعيين الحالة
        isBroadcasting = false;
        currentLiveStreamId = null;
        
        // تحديث الواجهة
        document.getElementById('activeLiveContainer').style.display = 'none';
        document.getElementById('noLiveMessage').style.display = 'block';
        
        // إعادة تحميل البثوث الحية
        loadLiveStreams();
      }
    }
    
    // تبديل الميكروفون
    document.getElementById('toggleMic').addEventListener('click', () => {
      if (!localStream) return;
      
      const audioTracks = localStream.getAudioTracks();
      if (audioTracks.length > 0) {
        micEnabled = !micEnabled;
        audioTracks[0].enabled = micEnabled;
        document.getElementById('toggleMic').innerHTML = micEnabled ? 
          '<i class="fas fa-microphone"></i>' : 
          '<i class="fas fa-microphone-slash"></i>';
      }
    });
    
    // تبديل الكاميرا
    document.getElementById('toggleCam').addEventListener('click', () => {
      if (!localStream) return;
      
      const videoTracks = localStream.getVideoTracks();
      if (videoTracks.length > 0) {
        camEnabled = !camEnabled;
        videoTracks[0].enabled = camEnabled;
        document.getElementById('toggleCam').innerHTML = camEnabled ? 
          '<i class="fas fa-video"></i>' : 
          '<i class="fas fa-video-slash"></i>';
      }
    });
    
    // أحداث إغلاق المودالات
    document.getElementById('cancelStartLiveBtn').addEventListener('click', () => {
      document.getElementById('startLiveModal').style.display = 'none';
    });
    
    document.getElementById('cancelEditProfileBtn').addEventListener('click', () => {
      document.getElementById('editProfileModal').style.display = 'none';
    });
    
    document.querySelectorAll('.modal-overlay').forEach(modal => {
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          modal.style.display = 'none';
        }
      });
    });
    
    // أحداث تعديل الملف الشخصي
    document.getElementById('editProfileBtn').addEventListener('click', function() {
      // تعبئة البيانات الحالية في المودال
      document.getElementById('editProfilePic').src = currentUser.photoURL || "https://www.gravatar.com/avatar/?d=mp";
      document.getElementById('editProfileName').value = currentUser.name || "";
      document.getElementById('editProfileDescription').value = currentUser.description || "";
      document.getElementById('editProfileUsername').value = currentUser.username || "";
      
      document.getElementById('editProfileModal').style.display = 'flex';
    });
    
    document.getElementById('editProfileImageInput').addEventListener('change', function(e) {
      if (e.target.files && e.target.files[0]) {
        const reader = new FileReader();
        reader.onload = function(event) {
          document.getElementById('editProfilePic').src = event.target.result;
        };
        reader.readAsDataURL(e.target.files[0]);
      }
    });
    
    document.getElementById('editProfilePic').addEventListener('click', function() {
      document.getElementById('editProfileImageInput').click();
    });
    
    document.getElementById('saveProfileBtn').addEventListener('click', async function() {
      const name = document.getElementById('editProfileName').value.trim();
      const description = document.getElementById('editProfileDescription').value.trim();
      const username = document.getElementById('editProfileUsername').value.trim();
      const fileInput = document.getElementById('editProfileImageInput');
      
      if (!name) {
        alert('يرجى إدخال الاسم');
        return;
      }
      
      try {
        let newPhotoURL = currentUser.photoURL;
        
        // تحديث بيانات المستخدم في Firebase
        await db.collection("users").doc(currentUser.id).update({
          name: name,
          description: description,
          username: username,
          photoURL: newPhotoURL
        });
        
        // تحديث بيانات المستخدم الحالي
        currentUser.name = name;
        currentUser.description = description;
        currentUser.username = username;
        
        // تحديث الصورة في الواجهة
        document.querySelectorAll('.post-header img').forEach(img => {
          if (img.src === currentUser.photoURL || img.src === document.getElementById('editProfilePic').src) {
            img.src = newPhotoURL;
          }
        });
        
        // إغلاق المودال
        document.getElementById('editProfileModal').style.display = 'none';
        
        // إظهار رسالة نجاح
        alert('تم تحديث الملف الشخصي بنجاح!');
      } catch (error) {
        console.error('خطأ في تحديث الملف الشخصي:', error);
        alert('حدث خطأ أثناء تحديث الملف الشخصي');
      }
    });
  </script>
</body>
</html>
